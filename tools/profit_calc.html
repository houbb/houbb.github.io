<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿æ»šä¸“å±è®¡ç®—åˆ©æ¶¦</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
	
    <style>
      
    </style>
</head>
<body class="container">

    <h3>
	1. é€‰æ‹©è®¢å•EXCEL
	</h3>
	
	<div>
	    <div class="row" style="margin-top: 10px;">
		  <label class="col-sm-1 col-form-label col-form-label"> ğŸ‘©â€ğŸ’¼å½“å‰ç”¨æˆ·</label>
		  <div class="col-sm-11">
			<img class="img-thumbnail" style="width:40px;height:40px;"src="https://avatars.githubusercontent.com/u/18375710?s=400&u=5e06158e37b8c0b671c1df202e309eab00073d9d&v=4"/>
	        <span>é˜¿æ»š</span>
		  </div>
		</div>
		
		<div class="row" style="margin-top: 10px;">
		  <label class="col-sm-1 col-form-label col-form-label">ğŸ”è¾“å…¥å¯†ç </label>
		  <div class="col-sm-11">
			<input id="password" type="password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
		  </div>
		</div>
	</div>
	
	<br/>
	
	<div class="row">
	  <label class="col-sm-1 col-form-label col-form-label">ğŸ“—æ–‡ä»¶ä¸Šä¼ </label>
	  <div class="col-sm-6">
		<input type="file" id="fileInput" accept=".xls,.xlsx" class="form-control">
	  </div>
	  <div class="col-sm-2">
		<button class = "btn btn-warning" onclick="deleteFile()">âŒåˆ é™¤æ–‡ä»¶</button>
	  </div>
	  <div class="col-sm-2">
		<button class = "btn btn-success" onclick="exportOrderSummary()">ğŸ“˜å¯¼å‡ºäº¤æ˜“æ±‡æ€»</button>
	  </div>
	</div>
	
    
	
	
	<br/>
    <table id="dataTable" class="table table-striped table-bordered" data-toggle="table" data-resizable="true">
        <thead>
            <tr>
                <th>å•†å“åç§°</th>
				<th>å•†å“å±æ€§</th>
                <th>æˆäº¤é‡‘é¢æ€»è®¡(å…ƒ)</th>
                <th>æˆäº¤æ•°æ€»è®¡(ä¸ª)</th>
                <th>é€€æ¬¾é‡‘é¢æ€»è®¡(å…ƒ)</th>
                <th>é€€æ¬¾æ•°æ€»è®¡(ä¸ª)</th>
                <th>æˆäº¤äººæ•°é¢„ä¼°(äºº)</th>
                <th>å•†å“å®¢å•ä»·(å…ƒ)</th>
                <th>å•†å“é‡‡è´­å…¬æ–¤ä»·(å…ƒ)</th>
                <th>å•†å“é‡é‡(å…‹)</th>
            </tr>
        </thead>
        <tbody id="dataBody"></tbody>
    </table>

	
	<h3>
	2. åˆ©æ¶¦è®¡ç®—
	</h3>
	
	<h4>2.1 è®¡ç®—è§£é‡Š</h4>
	æ¯›åˆ©=ï¼ˆå•åœºæˆäº¤GMV-é€€æ¬¾é‡‘é¢ï¼‰-åŸæ–™æˆæœ¬-ï¼ˆæˆäº¤äººæ•°*å¿«é€’å•ä»·ï¼‰-ï¼ˆæˆäº¤å•æ•°*åŒ…æå•ä»·ï¼‰-ï¼ˆæˆäº¤å•æ•°*æŠ€æœ¯æœåŠ¡è´¹å•ä»·ï¼‰-ï¼ˆæˆäº¤å•æ•°*è¿è´¹é™©å•ä»·ï¼‰-(åŒ…æ•°*åŒ…æäººå·¥è´¹) <br/>
	åŸæ–™æˆæœ¬=åŒ…æ•°*å•†å“å…‹ä»·*è§„æ ¼å…‹é‡       <br/>
	åŒ…æ•°=ï¼ˆæˆäº¤é‡‘é¢-é€€æ¬¾é‡‘é¢ï¼‰/å®¢å•ä»·      <br/>
	å…‹ä»·=å•†å“å…¬æ–¤ä»·/1000  <br/>
	æŠ€æœ¯æœåŠ¡è´¹=æˆäº¤é‡‘é¢*0.02  <br/>
	è¿è´¹é™©=(æˆäº¤å•æ•°-é€€æ¬¾å•æ•°)*0.14  <br/>
    åŒ…æäººå·¥=åŒ…æ•°*åŒ…æäººå·¥è´¹=åŒ…æ•°*0.25 <br/>

	<h4>2.2 è´¹ç”¨é…ç½®</h4>
	
	<div class="row">
	  <label class="col-sm-1 col-form-label col-form-label">ğŸ•µï¸â€â™‚ï¸æˆäº¤äººæ•°</label>
	  <div class="col-sm-11">
		<input id="configSuccessPersonCount" class="form-control" value="0">
	  </div>
	</div>
	
	<div class="row" style="margin-top: 10px;">
	  <label class="col-sm-1 col-form-label col-form-label">ğŸ’¼å¿«é€’å•ä»·</label>
	  <div class="col-sm-11">
		<input id="configKuaiduFeePerson" value="2" class="form-control">
	  </div>
	</div>


	
	<!-- æˆäº¤æ€»äººæ•°: <input id="configSuccessPersonCount" value="0" class="form-control"></input> -->
	<!-- å¿«é€’å•ä»·(å…ƒ)ï¼š<input id="configKuaiduFeePerson" value="2" class="form-control"></input> -->
    <br/> 				
    <button id="calculateProfit" class="hidden btn btn-primary">ğŸ…è®¡ç®—åˆ©æ¶¦</button>
    <button id="exportTableProfit" class="btn btn-success" onclick="exportTableProfit()">ğŸ“˜å¯¼å‡ºåˆ©æ¶¦æ˜ç»†</button>
    
    <h4>2.3 åˆ©æ¶¦æ±‡æ€»</h4>
	æ€»åˆ©æ¶¦=å•†å“åˆ©æ¶¦ä¹‹å’Œ-(æˆäº¤äººæ•°*å¿«é€’å•ä»·)
	
	<div id="totalProfit" class="hidden"></div>
	
    <table id="costTable" class="hidden table table-striped table-bordered" style="margin-top: 10px;">
        <thead>
            <tr>
                <th>å•†å“åç§°</th>
				<th>å•†å“å±æ€§</th>
                <th>åŒ…æ•°</th>
                <th>å…‹ä»·</th>
                <th>æŠ€æœ¯æœåŠ¡è´¹</th>
                <th>è¿è´¹é™©</th>
                <th>åˆ©æ¶¦</th>
				<th>åˆ©æ¶¦æ˜ç»†=(æˆäº¤è®¢å•é‡‘é¢æ€»è®¡-é€€æ¬¾è®¢å•é‡‘é¢æ€»è®¡ï¼‰-åŸæ–™æˆæœ¬-ï¼ˆæˆäº¤å•æ•°*åŒ…æå•ä»·ï¼‰-ï¼ˆæˆäº¤å•æ•°*æŠ€æœ¯æœåŠ¡è´¹å•ä»·ï¼‰-(åŒ…æ•°*åŒ…æäººå·¥è´¹)</th>
            </tr>
        </thead>
        <tbody id="costBody"></tbody>
    </table>

    

    <script>    
	function exportOrderSummary() {
		exportTableToExcel('dataTable', 'äº¤æ˜“æ±‡æ€»');
	}
	function exportTableProfit() {
		exportTableToExcel('costTable', 'åˆ©æ¶¦æ˜ç»†');
	}
	
	// è¡¨æ ¼å¯¼å‡ºåˆ° EXCEL
	function exportTableToExcel(tableId, tableName) {
		 // è·å–è¡¨æ ¼å…ƒç´ 
		  var table = document.getElementById(tableId);

          // ä¿®æ­£ input æ— æ³•å¯¼å‡ºçš„é—®é¢˜
                // éå†è¡¨æ ¼çš„æ¯ä¸€è¡Œ
        for (var r = 0; r < table.rows.length; r++) {
            var row = table.rows[r];
            // éå†æ¯ä¸€è¡Œä¸­çš„æ¯ä¸€ä¸ªå•å…ƒæ ¼
            for (var c = 0; c < row.cells.length; c++) {
                var cell = row.cells[c];
                // æ£€æŸ¥å•å…ƒæ ¼ä¸­æ˜¯å¦æœ‰inputå…ƒç´ 
                if (cell.getElementsByTagName('input').length > 0) {
                    // å¦‚æœæœ‰inputå…ƒç´ ï¼Œè·å–å…¶å€¼å¹¶è®¾ç½®ä¸ºå•å…ƒæ ¼çš„æ–‡æœ¬å†…å®¹
                    cell.innerHTML = cell.getElementsByTagName('input')[0].value;
                }
            }
        }
		  
		  // å°†è¡¨æ ¼è½¬æ¢ä¸ºå·¥ä½œç°¿
		  var ws = XLSX.utils.table_to_sheet(table);
		  var wb = XLSX.utils.book_new();
		  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
		  
		  // ä¸ºæ–‡ä»¶åæ·»åŠ æ—¶é—´æˆ³
		  var timestamp = new Date().toISOString().replace(/[:\.]/g, '-');
		  let filename = tableName+"_"+ timestamp + '.xlsx';
		  
		  // ä½¿ç”¨JSZipç”ŸæˆExcelæ–‡ä»¶
		  XLSX.writeFile(wb, filename);
	}
	

	// åˆ é™¤æ–‡ä»¶çš„å‡½æ•°
	function deleteFile() {
	    var fileInput = document.getElementById('fileInput');
		// æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†çš„å€¼
		fileInput.value = '';
		// å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„é€»è¾‘ï¼Œæ¯”å¦‚æ›´æ–°ç•Œé¢æ˜¾ç¤ºç­‰
	}

	    function calculateMD5(input) {
		    if(input && input != "") {
				return CryptoJS.MD5(input).toString();
			}
			return "";
		}
		function isExpire() {
			const today = new Date();
			const targetDate = new Date('2024-10-31');

			if (today > targetDate) {
			    alert('è´¦æˆ·å·²è¿‡æœŸï¼Œè¯·è”ç³»æŠ€æœ¯ç®¡ç†å‘˜!');
				return true;
			} else {
				return false;
			}
		}

	    function checkPassword() {
		    //expire
			if(isExpire()) {
				return false;
			}
			
			let passwordElement = document.getElementById('password');
			let pwdMd5 = calculateMD5(passwordElement.value);
			if ('d5792307ca46844fd13e0ee78c858a11' == pwdMd5) {
				return true;
			}
			alert('è´¦æˆ·æˆ–è€…å¯†ç é”™è¯¯!');
			return false;
		}
		
        document.getElementById('fileInput').addEventListener('change', function(event) {
		    let valid = checkPassword();
			if(!valid) {
				return;
			}
		
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                generateProductTable(jsonData);
            };

            reader.readAsArrayBuffer(file);
        });
		
		// æå–é‡é‡
		function extraWeight(description) {
			  // å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºåŒ¹é…æ•°å­—ã€å…‹æˆ–gä»¥åŠå¯èƒ½çš„ä¹˜æ³•
			  const weightRegex = /(\d+)(å…‹|g)/g;
			  const multiplierRegex = /\*(\d+)/g;

			  // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„é‡é‡
			  let weightMatches = description.match(weightRegex);
			  let multiplierMatches = description.match(multiplierRegex);

			  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…é¡¹ï¼Œè¿”å›0
			  if (!weightMatches) {
				return 0;
			  }

			  // åˆå§‹åŒ–æ€»é‡é‡
			  let totalWeight = 0;

			  // éå†æ‰€æœ‰åŒ¹é…çš„é‡é‡
			  weightMatches.forEach((match, index) => {
				// æå–æ•°å­—
				let weight = parseInt(match.match(/\d+/)[0], 10);

				// å¦‚æœå­˜åœ¨ä¹˜æ•°ï¼Œå¹¶ä¸”æ˜¯å½“å‰é‡é‡çš„ä¹˜æ•°ï¼Œåˆ™ä¹˜ä»¥ä¹˜æ•°
				if (multiplierMatches && multiplierMatches[index]) {
				  let multiplier = parseInt(multiplierMatches[index].match(/\d+/)[0], 10);
				  weight *= multiplier;
				}

				// å°†æå–çš„é‡é‡åŠ åˆ°æ€»é‡é‡ä¸Š
				totalWeight += weight;
			  });

			  // è¿”å›æ€»é‡é‡
			  return totalWeight;
		}

        function getProductInPricePerKg(productName) {
            const productMap = new Map([
                ['ç«ç‘°', 58],
                ['é…¸æ£ä»', 100],
                ['é¹¿èŒ¸è‡', 55],
                ['è™«è‰èŠ±', 45],
                ['ç¾Šè‚šèŒ', 320],
                ['æ¸æ', 43],
                ['æ¡‚åœ†', 22],
                ['çº¢æ£', 15],
                ['å±±æ¥‚', 35],
                ['é›ªç‡•', 18],
                ['æ¡ƒèƒ¶', 32],
                ['çš‚è§’ç±³', 28],
                ['ç‡•éº¦', 7],
                ['å°é¦™è‡', 60],
                ['çŒ´å¤´è‡', 55],
                ['èŒæ±¤åŒ…', 66.67],
                ['å§¬æ¾èŒ¸', 135],
                ['é¸¡æ²¹è‡', 55],
                ['æ¡‘è‘š', 19],
                ['è‹¦èç±³', 12],
                ['å¤§éº¦èŒ¶', 5],
            ]);
            
            // éå†Mapä¸­çš„æ¯ä¸ªé”®å€¼å¯¹
            for (let [key, value] of productMap) {
                // æ£€æŸ¥å•†å“å…¨åæ˜¯å¦åŒ…å«å•†å“ç®€ç§°
                if (productName.includes(key)) {
                    return value; // å¦‚æœåŒ…å«ï¼Œè¿”å›å¯¹åº”çš„ä»·æ ¼
                }
            }
            return 0; // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…é¡¹ï¼Œè¿”å›null
        }

        function generateProductTable(data) {
            const productStats = {};
            const headers = data[0];

            const productNameIndex = headers.indexOf('å•†å“åç§°');
			const productPropIndex = headers.indexOf('å•†å“å±æ€§');
			const productPriceIndex = headers.indexOf('å•†å“ä»·æ ¼');
            const orderAmountIndex = headers.indexOf('è®¢å•å®é™…æ”¯ä»˜é‡‘é¢');
            const refundedAmountIndex = headers.indexOf('å•†å“å·²é€€æ¬¾é‡‘é¢');
            const recipientNameIndex = headers.indexOf('æ”¶ä»¶äººå§“å');
            const recipientAddressIndex = headers.indexOf('æ”¶ä»¶äººåœ°å€');
            const recipientPhoneIndex = headers.indexOf('æ”¶ä»¶äººæ‰‹æœº');

            let  totalSuccessPerson = 0;
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const productName = row[productNameIndex];
                const productProp = row[productPropIndex];
				const productPrice = row[productPriceIndex];
                const orderAmount = parseFloat(row[orderAmountIndex]) || 0;
                const refundedAmount = parseFloat(row[refundedAmountIndex]) || 0;
                const recipientKey = `${row[recipientNameIndex]}_${row[recipientAddressIndex]}_${row[recipientPhoneIndex]}`;

                if (productName && productProp) {
                    if (!productStats[productName+productProp]) {
                        productStats[productName+productProp] = {
                            totalOrderAmount: 0,
                            totalOrders: 0,
                            totalRefundedAmount: 0,
                            totalRefundedOrders: 0,
							productName: productName,
							productProp: productProp,
							// å•†å“ä»·æ ¼
							productPrice: productPrice,
                            uniqueCustomers: new Set()
                        };
                    }

                    if (orderAmount > 0) {
                        productStats[productName+productProp].totalOrderAmount += orderAmount;
                        productStats[productName+productProp].totalOrders += 1;
                        productStats[productName+productProp].uniqueCustomers.add(recipientKey);
                    }

                    if (refundedAmount > 0) {
                        productStats[productName+productProp].totalRefundedAmount += refundedAmount;
                        productStats[productName+productProp].totalRefundedOrders += 1;
                    }
                }
            }

            const dataBody = document.getElementById('dataBody');
            dataBody.innerHTML = '';

            for (const [productName, stats] of Object.entries(productStats)) {
                const tr = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = stats.productName;
                tr.appendChild(nameCell);

				const propCell = document.createElement('td');
                propCell.textContent = stats.productProp;
                tr.appendChild(propCell);
				
                const orderAmountCell = document.createElement('td');
                orderAmountCell.textContent = stats.totalOrderAmount.toFixed(2);
                tr.appendChild(orderAmountCell);

                const orderCountCell = document.createElement('td');
                orderCountCell.textContent = stats.totalOrders;
                tr.appendChild(orderCountCell);

                const refundedAmountCell = document.createElement('td');
                refundedAmountCell.textContent = stats.totalRefundedAmount.toFixed(2);
                tr.appendChild(refundedAmountCell);

                const refundedCountCell = document.createElement('td');
                refundedCountCell.textContent = stats.totalRefundedOrders;
                tr.appendChild(refundedCountCell);

                const uniqueCustomersCell = document.createElement('td');
                uniqueCustomersCell.textContent = stats.uniqueCustomers.size;
                tr.appendChild(uniqueCustomersCell);
				
				// æ›´æ–°æ€»äººæ•°
				totalSuccessPerson += stats.uniqueCustomers.size;

                const priceCell = document.createElement('td');
                const inputPrice = document.createElement('input');
                inputPrice.type = 'number';
                inputPrice.placeholder = 'å®¢å•ä»·';
				inputPrice.value= stats.productPrice.toFixed(2);
                priceCell.appendChild(inputPrice);
                tr.appendChild(priceCell);

                const weightCell = document.createElement('td');
                const inputWeight = document.createElement('input');
                inputWeight.type = 'number';
                inputWeight.placeholder = 'å…¬æ–¤ä»·';
				inputWeight.value = getProductInPricePerKg(stats.productName);
                if(inputWeight.value == 0) {
                    inputWeight.style.color = 'red';
				}
                weightCell.appendChild(inputWeight);
                tr.appendChild(weightCell);

                const customWeightCell = document.createElement('td');
                const inputCustomWeight = document.createElement('input');
                inputCustomWeight.type = 'number';
                inputCustomWeight.placeholder = 'å•†å“é‡é‡';
				inputCustomWeight.value=extraWeight(stats.productProp);
				if(inputCustomWeight.value == 0) {
				   inputCustomWeight.style.color = 'red';
				}
                customWeightCell.appendChild(inputCustomWeight);
                tr.appendChild(customWeightCell);

                dataBody.appendChild(tr);
            }

            document.getElementById('configSuccessPersonCount').value = totalSuccessPerson;
            document.getElementById('calculateProfit').classList.remove('hidden');
        }

        document.getElementById('calculateProfit').addEventListener('click', function() {
		    let valid = checkPassword();
			if(!valid) {
				return;
			}
			
            const rows = document.querySelectorAll('#dataBody tr');
            const costBody = document.getElementById('costBody');
            costBody.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            let totalProfit = 0;

            for (const row of rows) {
                const cells = row.querySelectorAll('td');
                const productName = cells[0].textContent;
                const productProp = cells[1].textContent;
                const totalOrderAmount = parseFloat(cells[2].textContent);
                const totalRefundedAmount = parseFloat(cells[4].textContent);
                const totalOrders = parseInt(cells[3].textContent);
                const totalRefundedOrders = parseInt(cells[5].textContent);
                const uniqueCustomersCount = parseInt(cells[6].textContent);
                const inputPrice = cells[7].querySelector('input');
                const inputWeight = cells[8].querySelector('input');
                const inputCustomWeight = cells[9].querySelector('input');

                const userPrice = parseFloat(inputPrice.value);
                const userKgPrice = parseFloat(inputWeight.value);
                const userCustomWeight = parseFloat(inputCustomWeight.value);

                if (!userPrice || userPrice <= 0 || !userKgPrice || userKgPrice <= 0 || !userCustomWeight || userCustomWeight <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼å’Œé‡é‡ï¼');
                    return;
                }

                const packageCount = Math.ceil((totalOrderAmount - totalRefundedAmount) / userPrice);
                const gramPrice = userKgPrice / 1000;
                const technicalServiceFee = totalOrderAmount * 0.02;
                const shippingInsurance = (totalOrders - totalRefundedOrders) * 0.14;
                const rawMaterialCost = packageCount * gramPrice * userCustomWeight;
                const profit = (totalOrderAmount - totalRefundedAmount) - rawMaterialCost - technicalServiceFee - shippingInsurance - packageCount * 0.25;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${productName}</td>
					<td>${productProp}</td>
                    <td>${packageCount}</td>
                    <td>${gramPrice.toFixed(4)}</td>
                    <td>${technicalServiceFee.toFixed(2)}</td>
                    <td>${shippingInsurance.toFixed(2)}</td>
					<td>${profit.toFixed(2)}</td>
                    <td>(${totalOrderAmount.toFixed(2)} - ${totalRefundedAmount.toFixed(2)}) - ${rawMaterialCost.toFixed(2)} - (${technicalServiceFee.toFixed(2)}) - (${shippingInsurance.toFixed(2)}) - (${packageCount} * 0.25)</td>
                `;
                costBody.appendChild(tr);
                totalProfit += profit;
            }

            let configSuccessPersonCount = document.getElementById('configSuccessPersonCount').value;
            let configKuaiduFeePerson = document.getElementById('configKuaiduFeePerson').value;
			let totalPureProfit = totalProfit - configSuccessPersonCount * configKuaiduFeePerson;
            document.getElementById('totalProfit').innerHTML = `æ€»åˆ©æ¶¦: ${totalPureProfit.toFixed(2)}=${totalProfit.toFixed(2)}-(${configSuccessPersonCount}*${configKuaiduFeePerson})`;
            document.getElementById('totalProfit').classList.remove('hidden');
            document.getElementById('costTable').classList.remove('hidden');
        });
    </script>
</body>
</html>
