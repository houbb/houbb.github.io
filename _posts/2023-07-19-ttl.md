---
layout: post
title: TransmittableThreadLocal (TTL) è§£å†³å¼‚æ­¥æ‰§è¡Œæ—¶ä¸Šä¸‹æ–‡ä¼ é€’çš„é—®é¢˜
date:  2023-07-19 +0800
categories: [Java]
tags: [java, sh]
published: true
---

# åŠŸèƒ½

ğŸ‘‰ TransmittableThreadLocal(TTL)ï¼šåœ¨ä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶æƒ…å†µä¸‹ï¼Œæä¾›ThreadLocalå€¼çš„ä¼ é€’åŠŸèƒ½ï¼Œè§£å†³å¼‚æ­¥æ‰§è¡Œæ—¶ä¸Šä¸‹æ–‡ä¼ é€’çš„é—®é¢˜ã€‚

ä¸€ä¸ªJavaæ ‡å‡†åº“æœ¬åº”ä¸ºæ¡†æ¶/ä¸­é—´ä»¶è®¾æ–½å¼€å‘æä¾›çš„æ ‡é…èƒ½åŠ›ï¼Œæœ¬åº“åŠŸèƒ½èšç„¦ & 0ä¾èµ–ï¼Œæ”¯æŒJava 6~21ã€‚

JDKçš„InheritableThreadLocalç±»å¯ä»¥å®Œæˆçˆ¶çº¿ç¨‹åˆ°å­çº¿ç¨‹çš„å€¼ä¼ é€’ã€‚

ä½†å¯¹äºä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶çš„æƒ…å†µï¼Œçº¿ç¨‹ç”±çº¿ç¨‹æ± åˆ›å»ºå¥½ï¼Œå¹¶ä¸”çº¿ç¨‹æ˜¯æ± åŒ–èµ·æ¥åå¤ä½¿ç”¨çš„ï¼›è¿™æ—¶çˆ¶å­çº¿ç¨‹å…³ç³»çš„ThreadLocalå€¼ä¼ é€’å·²ç»æ²¡æœ‰æ„ä¹‰ï¼Œåº”ç”¨éœ€è¦çš„å®é™…ä¸Šæ˜¯æŠŠ ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± æ—¶çš„ThreadLocalå€¼ä¼ é€’åˆ° ä»»åŠ¡æ‰§è¡Œæ—¶ã€‚

æœ¬åº“æä¾›çš„TransmittableThreadLocalç±»ç»§æ‰¿å¹¶åŠ å¼ºInheritableThreadLocalç±»ï¼Œè§£å†³ä¸Šè¿°çš„é—®é¢˜ï¼Œä½¿ç”¨è¯¦è§ User Guideã€‚

æ•´ä¸ªTransmittableThreadLocalåº“çš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆç”¨æˆ·APIã€çº¿ç¨‹æ± ExecutorService/ForkJoinPool/TimerTaskåŠå…¶çº¿ç¨‹å·¥å‚çš„Wrapperï¼›

å¼€å‘è€…APIã€æ¡†æ¶/ä¸­é—´ä»¶çš„é›†æˆAPIï¼‰ï¼Œåªæœ‰ ~1000 SLOCä»£ç è¡Œï¼Œéå¸¸ç²¾å°ã€‚

# éœ€æ±‚åœºæ™¯
ThreadLocalçš„éœ€æ±‚åœºæ™¯å³TransmittableThreadLocalçš„æ½œåœ¨éœ€æ±‚åœºæ™¯ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡éœ€è¦ã€åœ¨ä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶æƒ…å†µä¸‹ä¼ é€’ThreadLocalå€¼ã€åˆ™æ˜¯TransmittableThreadLocalç›®æ ‡åœºæ™¯ã€‚

ä¸‹é¢æ˜¯å‡ ä¸ªå…¸å‹åœºæ™¯ä¾‹å­ã€‚

- åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿ æˆ– å…¨é“¾è·¯å‹æµ‹ï¼ˆå³é“¾è·¯æ‰“æ ‡ï¼‰

- æ—¥å¿—æ”¶é›†è®°å½•ç³»ç»Ÿä¸Šä¸‹æ–‡

- Sessionçº§Cache

- åº”ç”¨å®¹å™¨æˆ–ä¸Šå±‚æ¡†æ¶è·¨åº”ç”¨ä»£ç ç»™ä¸‹å±‚SDKä¼ é€’ä¿¡æ¯

å„ä¸ªåœºæ™¯çš„å±•å¼€è¯´æ˜å‚è§å­æ–‡æ¡£ éœ€æ±‚åœºæ™¯ã€‚

# User Guide

ä½¿ç”¨ç±»TransmittableThreadLocalæ¥ä¿å­˜å€¼ï¼Œå¹¶è·¨çº¿ç¨‹æ± ä¼ é€’ã€‚

TransmittableThreadLocalç»§æ‰¿InheritableThreadLocalï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿç±»ä¼¼ã€‚

ç›¸æ¯”InheritableThreadLocalï¼Œæ·»åŠ äº†protectedçš„transmitteeValue()æ–¹æ³•ï¼Œç”¨äºå®šåˆ¶ ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± æ—¶ çš„ThreadLocalå€¼ä¼ é€’åˆ° ä»»åŠ¡æ‰§è¡Œæ—¶ çš„ä¼ é€’æ–¹å¼ï¼Œç¼ºçœæ˜¯ç®€å•çš„èµ‹å€¼ä¼ é€’ã€‚

æ³¨æ„ï¼šå¦‚æœä¼ é€’çš„å¯¹è±¡ï¼ˆå¼•ç”¨ç±»å‹ï¼‰ä¼šè¢«ä¿®æ”¹ï¼Œä¸”æ²¡æœ‰åšæ·±æ‹·è´ï¼ˆå¦‚ç›´æ¥ä¼ é€’å¼•ç”¨æˆ–æ˜¯æµ…æ‹·è´ï¼‰ï¼Œé‚£ä¹ˆ

- å› ä¸ºè·¨çº¿ç¨‹ä¼ é€’è€Œä¸å†æœ‰çº¿ç¨‹å°é—­ï¼Œä¼ é€’å¯¹è±¡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´æ˜¯æœ‰å…±äº«çš„ã€‚

- ä¸JDKçš„InheritableThreadLocal.childValue()ä¸€æ ·ï¼Œéœ€è¦ä½¿ç”¨è€…/ä¸šåŠ¡é€»è¾‘æ³¨æ„ä¿è¯ä¼ é€’å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨ã€‚

## 1. ç®€å•ä½¿ç”¨

çˆ¶çº¿ç¨‹ç»™å­çº¿ç¨‹ä¼ é€’å€¼ã€‚

ç¤ºä¾‹ä»£ç ï¼š

```java
TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();

// =====================================================

// åœ¨çˆ¶çº¿ç¨‹ä¸­è®¾ç½®
context.set("value-set-in-parent");

// =====================================================

// åœ¨å­çº¿ç¨‹ä¸­å¯ä»¥è¯»å–ï¼Œå€¼æ˜¯"value-set-in-parent"
String value = context.get();
```

è¿™å…¶å®æ˜¯InheritableThreadLocalçš„åŠŸèƒ½ï¼Œåº”è¯¥ä½¿ç”¨InheritableThreadLocalæ¥å®Œæˆã€‚

ä½†å¯¹äºä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶çš„æƒ…å†µï¼Œçº¿ç¨‹ç”±çº¿ç¨‹æ± åˆ›å»ºå¥½ï¼Œå¹¶ä¸”çº¿ç¨‹æ˜¯æ± åŒ–èµ·æ¥åå¤ä½¿ç”¨çš„ï¼›

è¿™æ—¶çˆ¶å­çº¿ç¨‹å…³ç³»çš„ThreadLocalå€¼ä¼ é€’å·²ç»æ²¡æœ‰æ„ä¹‰ï¼Œåº”ç”¨éœ€è¦çš„å®é™…ä¸Šæ˜¯æŠŠ ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± æ—¶çš„ThreadLocalå€¼ä¼ é€’åˆ° ä»»åŠ¡æ‰§è¡Œæ—¶ã€‚

# 2. ä¿è¯çº¿ç¨‹æ± ä¸­ä¼ é€’å€¼

## 2.1 ä¿®é¥°Runnableå’ŒCallable

ä½¿ç”¨TtlRunnableå’ŒTtlCallableæ¥ä¿®é¥°ä¼ å…¥çº¿ç¨‹æ± çš„Runnableå’ŒCallableã€‚

ç¤ºä¾‹ä»£ç ï¼š

```java
TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();

// =====================================================

// åœ¨çˆ¶çº¿ç¨‹ä¸­è®¾ç½®
context.set("value-set-in-parent");

Runnable task = new RunnableTask();
// é¢å¤–çš„å¤„ç†ï¼Œç”Ÿæˆä¿®é¥°äº†çš„å¯¹è±¡ttlRunnable
Runnable ttlRunnable = TtlRunnable.get(task);
executorService.submit(ttlRunnable);

// =====================================================

// Taskä¸­å¯ä»¥è¯»å–ï¼Œå€¼æ˜¯"value-set-in-parent"
String value = context.get();
```

### æ³¨æ„ï¼š

å³ä½¿æ˜¯åŒä¸€ä¸ªRunnableä»»åŠ¡å¤šæ¬¡æäº¤åˆ°çº¿ç¨‹æ± æ—¶ï¼Œæ¯æ¬¡æäº¤æ—¶éƒ½éœ€è¦é€šè¿‡ä¿®é¥°æ“ä½œï¼ˆå³TtlRunnable.get(task)ï¼‰ä»¥æŠ“å–è¿™æ¬¡æäº¤æ—¶çš„TransmittableThreadLocalä¸Šä¸‹æ–‡çš„å€¼ï¼›

å³å¦‚æœåŒä¸€ä¸ªä»»åŠ¡ä¸‹ä¸€æ¬¡æäº¤æ—¶ä¸æ‰§è¡Œä¿®é¥°è€Œä»ç„¶ä½¿ç”¨ä¸Šä¸€æ¬¡çš„TtlRunnableï¼Œåˆ™æäº¤çš„ä»»åŠ¡è¿è¡Œæ—¶ä¼šæ˜¯ä¹‹å‰ä¿®é¥°æ“ä½œæ‰€æŠ“å–çš„ä¸Šä¸‹æ–‡ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹

```java
// ç¬¬ä¸€æ¬¡æäº¤
Runnable task = new RunnableTask();
executorService.submit(TtlRunnable.get(task));

// ...ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œ
// å¹¶ä¸”ä¿®æ”¹äº† TransmittableThreadLocalä¸Šä¸‹æ–‡ ...
context.set("value-modified-in-parent");

// å†æ¬¡æäº¤
// é‡æ–°æ‰§è¡Œä¿®é¥°ï¼Œä»¥ä¼ é€’ä¿®æ”¹äº†çš„ TransmittableThreadLocalä¸Šä¸‹æ–‡
executorService.submit(TtlRunnable.get(task));
```

ä¸Šé¢æ¼”ç¤ºäº†Runnableï¼ŒCallableçš„å¤„ç†ç±»ä¼¼

```java
TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();

// =====================================================

// åœ¨çˆ¶çº¿ç¨‹ä¸­è®¾ç½®
context.set("value-set-in-parent");

Callable call = new CallableTask();
// é¢å¤–çš„å¤„ç†ï¼Œç”Ÿæˆä¿®é¥°äº†çš„å¯¹è±¡ttlCallable
Callable ttlCallable = TtlCallable.get(call);
executorService.submit(ttlCallable);

// =====================================================

// Callä¸­å¯ä»¥è¯»å–ï¼Œå€¼æ˜¯"value-set-in-parent"
String value = context.get();
```

- æ•´ä¸ªè¿‡ç¨‹çš„å®Œæ•´æ—¶åºå›¾

![å®Œæ•´æ—¶åºå›¾](https://user-images.githubusercontent.com/1063891/233595980-ef7f1f8b-36cd-45b3-b55b-45f7b3d1c94f.png)

## 2.2 ä¿®é¥°çº¿ç¨‹æ± 

çœå»æ¯æ¬¡Runnableå’ŒCallableä¼ å…¥çº¿ç¨‹æ± æ—¶çš„ä¿®é¥°ï¼Œè¿™ä¸ªé€»è¾‘å¯ä»¥åœ¨çº¿ç¨‹æ± ä¸­å®Œæˆã€‚

é€šè¿‡å·¥å…·ç±»TtlExecutorså®Œæˆï¼Œæœ‰ä¸‹é¢çš„æ–¹æ³•ï¼š

getTtlExecutorï¼šä¿®é¥°æ¥å£Executor

getTtlExecutorServiceï¼šä¿®é¥°æ¥å£ExecutorService

getTtlScheduledExecutorServiceï¼šä¿®é¥°æ¥å£ScheduledExecutorService

ç¤ºä¾‹ä»£ç ï¼š

```java
ExecutorService executorService = ...
// é¢å¤–çš„å¤„ç†ï¼Œç”Ÿæˆä¿®é¥°äº†çš„å¯¹è±¡executorService
executorService = TtlExecutors.getTtlExecutorService(executorService);

TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();

// =====================================================

// åœ¨çˆ¶çº¿ç¨‹ä¸­è®¾ç½®
context.set("value-set-in-parent");

Runnable task = new RunnableTask();
Callable call = new CallableTask();
executorService.submit(task);
executorService.submit(call);

// =====================================================

// Taskæˆ–æ˜¯Callä¸­å¯ä»¥è¯»å–ï¼Œå€¼æ˜¯"value-set-in-parent"
String value = context.get();
```

## 2.3 ä½¿ç”¨Java Agentæ¥ä¿®é¥°JDKçº¿ç¨‹æ± å®ç°ç±»

è¿™ç§æ–¹å¼ï¼Œå®ç°çº¿ç¨‹æ± çš„ä¼ é€’æ˜¯é€æ˜çš„ï¼Œä¸šåŠ¡ä»£ç ä¸­æ²¡æœ‰ä¿®é¥°Runnableæˆ–æ˜¯çº¿ç¨‹æ± çš„ä»£ç ã€‚å³å¯ä»¥åšåˆ°åº”ç”¨ä»£ç  æ— ä¾µå…¥ã€‚

å…³äº æ— ä¾µå…¥ çš„æ›´å¤šè¯´æ˜å‚è§æ–‡æ¡£ [Java Agentæ–¹å¼å¯¹åº”ç”¨ä»£ç æ— ä¾µå…¥](https://github.com/alibaba/transmittable-thread-local/blob/master/docs/developer-guide.md#java-agent%E6%96%B9%E5%BC%8F%E5%AF%B9%E5%BA%94%E7%94%A8%E4%BB%A3%E7%A0%81%E6%97%A0%E4%BE%B5%E5%85%A5)ã€‚

ç¤ºä¾‹ä»£ç ï¼š

```java
// ## 1. æ¡†æ¶ä¸Šå±‚é€»è¾‘ï¼Œåç»­æµç¨‹æ¡†æ¶è°ƒç”¨ä¸šåŠ¡ ##
TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();
context.set("value-set-in-parent");

// ## 2. åº”ç”¨é€»è¾‘ï¼Œåç»­æµç¨‹ä¸šåŠ¡è°ƒç”¨æ¡†æ¶ä¸‹å±‚é€»è¾‘ ##
ExecutorService executorService = Executors.newFixedThreadPool(3);

Runnable task = new RunnableTask();
Callable call = new CallableTask();
executorService.submit(task);
executorService.submit(call);

// ## 3. æ¡†æ¶ä¸‹å±‚é€»è¾‘ ##
// Taskæˆ–æ˜¯Callä¸­å¯ä»¥è¯»å–ï¼Œå€¼æ˜¯"value-set-in-parent"
String value = context.get();
```

# å‚è€ƒèµ„æ–™

https://github.com/alibaba/transmittable-thread-local

* any list
{:toc}