---
layout: post
title: Rocketmq
date:  2016-10-25 20:57:26 +0800
categories: [Apache]
tags: [mq]
published: true
---

* any list
{:toc}

# Message Queue

消息队列（Message Queue，简称 MQ）是阿里巴巴集团中间件技术部自主研发的专业消息中间件。产品基于高可用分布式集群技术，
提供消息发布订阅、消息轨迹查询、定时（延时）消息、资源统计、监控报警等一系列消息云服务，是企业级互联网架构的核心产品。
为分布式应用系统提供异步解耦、削峰填谷的能力，同时具备海量消息堆积、高吞吐、可靠重试等互联网应用所需的特性。

> [mq](https://help.aliyun.com/document_detail/29532.html?spm=5176.doc35370.6.89.HWqJPD)

<uml>
    Active MQ Service->Request MQ Resource:
    Request MQ Resource->Send Msg By SDK:
    Send Msg By SDK->Consumer Msg:
</uml>

> [Active Service](https://www.aliyun.com/price/product?spm=5176.7946988.209956.6.BrHbDM#/ons/detail)


1、 开通服务

阿里云主页-》产品-》互联网中间件-》RocketMQ-》开通


2、 下载demo

```
git clone git@github.com:lollipopjin/Aliware-MQ-demo.git
```

3、IDEA 导入项目并添加 maven 支持。

4、管理平台

(1) TOPIC管理-》发布Topic

定义一个topic: MQ_TEST_DEMO_TOPIC 备注: MQ_TEST

(2) TOPIC管理-》发布Topic-》申请发布

```
Producer ID: PID_RYO_MQ_TEST
```

(3) TOPIC管理-》发布Topic-》申请订阅

```
Consumer ID: CID_RYO_MQ_TEST
```

## MQConfig

**创建Access Key**-》

(1) AccessKey
(2) SecretKey

## Run demo


将```MqConfig.java```中数据修改为设置的值。直接运行 main 方法。


# Quick Start

[quick start](https://github.com/alibaba/RocketMQ/wiki/quick-start)


> 需要

```
64bit OS, best to have Linux/Unix/Mac;
64bit JDK 1.6+;
Maven 3.x
Git
Screen
```

- JDK

```
houbinbindeMacBook-Pro:aliyun-ons-client-java houbinbin$ java -version
java version "1.8.0_91"
Java(TM) SE Runtime Environment (build 1.8.0_91-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)
```

> Download and install

- Download rocketmq


download from this ```https://github.com/alibaba/RocketMQ/releases```, now tag is ```3.5.8```

```
$ ls
RocketMQ-3.5.8		RocketMQ-3.5.8.tar.gz
```

- Install

```
$ pwd
/Users/houbinbin/it/tools/rocketMQ/RocketMQ-3.5.8

$ bash instal.sh
...
```

then we get

```
 To refactor, move this assembly into a child project and use the flag <useAllReactorProjects>true</useAllReactorProjects> in each moduleSet.
[INFO] Building tar: /Users/houbinbin/IT/tools/rocketMQ/RocketMQ-3.5.8/target/alibaba-rocketmq-broker.tar.gz
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Summary:
[INFO]
[INFO] rocketmq-all 3.5.8 ................................. SUCCESS [ 48.565 s]
[INFO] rocketmq-remoting 3.5.8 ............................ SUCCESS [  1.772 s]
[INFO] rocketmq-common 3.5.8 .............................. SUCCESS [  1.348 s]
[INFO] rocketmq-client 3.5.8 .............................. SUCCESS [  1.522 s]
[INFO] rocketmq-store 3.5.8 ............................... SUCCESS [  0.815 s]
[INFO] rocketmq-srvutil 3.5.8 ............................. SUCCESS [  0.139 s]
[INFO] rocketmq-broker 3.5.8 .............................. SUCCESS [  0.951 s]
[INFO] rocketmq-tools 3.5.8 ............................... SUCCESS [  0.889 s]
[INFO] rocketmq-namesrv 3.5.8 ............................. SUCCESS [  0.373 s]
[INFO] rocketmq-example 3.5.8 ............................. SUCCESS [  0.392 s]
[INFO] rocketmq-filtersrv 3.5.8 ........................... SUCCESS [  0.337 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 59.323 s
[INFO] Finished at: 2017-01-02T18:21:01+08:00
[INFO] Final Memory: 52M/1042M
[INFO] ------------------------------------------------------------------------
```

> 环境配置


Make sure the following environment variable is properly setup: ```JAVA_HOME```

Now setup ROCKETMQ_HOME environment variable:

```
cd devenv

echo "ROCKETMQ_HOME=`pwd`" >> ~/.bash_profile
```

make it work at once:

```
source ~/.bash_profile
```

> Launch RocketMQ Name Server and Broker

确保在```devenv```目录下:

```
$ cd bin
$ pwd
/Users/houbinbin/it/tools/rocketMQ/RocketMQ-3.5.8/devenv/bin
```

- Start Name Server

```
screen bash mqnamesrv
```



现实是可能会遇到这个:

```
$ screen bash mqnamesrv
[screen is terminating]
```

[screen is terminating](http://superuser.com/questions/781591/screen-is-terminating-for-non-root)

执行以下命令(暂时提权):

```
su
```

使用 ```screen``` 命令进入, 运行:

```
$   bash mqnamesrv
```

then

```
sh-3.2# bash mqnamesrv
Java HotSpot(TM) 64-Bit Server VM warning: ignoring option PermSize=128m; support was removed in 8.0
Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=320m; support was removed in 8.0
Java HotSpot(TM) 64-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and will likely be removed in a future release.
The Name Server boot success. serializeType=JSON
```


If you see "The Name Server boot success. serializeType=JSON", this means name server starts successfully.

Press ```Ctrl + A```, then ```D``` to detach the session.

```
sh-3.2# screen
[detached]
```

- Start Broker


```
sh-3.2# screen
sh-3.2# pwd
/Users/houbinbin/it/tools/rocketMQ/RocketMQ-3.5.8/devenv/bin
sh-3.2# bash mqbroker -n localhost:9876
cp: /var/root/rmq_bk_gc.log: No such file or directory
Java HotSpot(TM) 64-Bit Server VM warning: ignoring option PermSize=128m; support was removed in 8.0
Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=320m; support was removed in 8.0
Java HotSpot(TM) 64-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and will likely be removed in a future release.
Java HotSpot(TM) 64-Bit Server VM warning: Cannot open file /var/root/tmpfs/logs/gc.log due to No such file or directory

The broker[houbinbindeMacBook-Pro.local, 192.168.2.102:10911] boot success. serializeType=JSON and name server is localhost:9876
```

If you see output like the following:

```The broker[lizhanhui-Lenovo, 172.30.30.233:10911] boot success. serializeType=JSON and name server is localhost:9876``` your broker then runs successfully.


> Send & Receive MSG

Before sending/receiving messages, we need to tell clients where name servers are located. RocketMQ provides multiple ways to achieve this.
For simplicity, we use environment variable ```NAMESRV_ADDR```

```
$   export NAMESRV_ADDR=localhost:9876
```

# In Mac


> [blog zh_CN](http://blog.csdn.net/zhu_tianwei/article/details/40948447)

> [blog zh_CN](http://blog.csdn.net/crazyxq/article/details/52870502)

> [rocketmq console zh_CN](http://blog.csdn.net/pandajava/article/details/50833878)

> [分布式](http://blog.csdn.net/qq_19244267/article/details/52411883)

- Download

download from this ```https://github.com/alibaba/RocketMQ/releases```, now tag is ```3.5.8```

```
$ pwd
/Users/houbinbin/it/tools/rocketMQ
$ ls
RocketMQ-3.5.8		RocketMQ-3.5.8.tar.gz
```

- NameServer

默认端口为```9876```, 进入 ```bin``` 目录

```
$ pwd
/Users/houbinbin/it/tools/rocketMQ/RocketMQ-3.5.8/bin
$ chmod +x mqadmin mqbroker mqfiltersrv mqshutdown  mqnamesrv
```


start

```
$ nohup  bash mqnamesrv >/dev/null 2>&1 &
[1] 32117
```

shutdown

```
bash mqshutdown namesrv
```


- mq broker

默认端口10911, 127.0.0.1:9876 为 NameServer

start

```
$   nohup mqbroker -n 127.0.0.1:9876 >/dev/null 2>&1 &
[2] 32144
[1]   Exit 1                  nohup bash mqnamesrv > /dev/null 2>&1
[2]+  Exit 127                $ nohup mqbroker -n 127.0.0.1:9876 > /dev/null 2>&1
```

```
启动nameserver：nohup ./bin/mqnamesrv >/dev/null 2>&1 &         #默认端口9876
关闭nameserver：./bin/mqshutdown namesrv
启动mqbroker ：nohup ./bin/mqbroker -n 192.168.36.189:9876 >/dev/null 2>&1 &     #默认端口10911（192.168.36.189:9876为nameserver，链接进行注册）
关闭mqbroker ：./bin/mqshutdown broker
```
















