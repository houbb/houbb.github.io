---
layout: post
title: java 如何让 jar/sdk 包静默升级？
date: 2024-01-04 21:01:55 +0800
categories: [Java]
tags: [java, sh]
published: true
---

# 业务背景

有时候为业务方提供了基础的 sdk 包，为了保证稳定性，一般都是 release 包。

但是每一次升级都非常痛苦，也不可能写一个一步到位的 jar 包，因为业务一直在变化。

那有什么方式，让 sdk 包静默升级呢？


# 方式1-snapshot

以 java 的 maven 包管理为例，如果使用 snapshot，那么就可以随时方便的升级包内容。

## 优点

非常简单，maven 天然支持、

## 缺点

- 包信息不够稳定，一般为了追求生产的稳定性，都会要求去 snapshot。

- 升级失败，不兼容等，没有回滚的余地。

## 方式2-nexus 等内部仓库直接替换

方式：直接替换指定版本的仓库中的包。这种方式的核心和上面类似。只不过是看起来不是 snapshot，但是依然无法保障安全。

## 方式3-sh

方式：使用 sh 脚本，在升级的时候，先备份，再替换。

流程：一般结合 ci 流水线使用，部署打包的时候替换包版本到指定版本，相比较而言更加灵活，也有回旋的余地。

缺点：要求比较多，比较麻烦。且要求应用必须通过 ci 流水线部署，否则就会被绕过。

## 方式4-maven 插件

实现方式一致，不过是时机问题。


# 注意点

1）需要保证 jar 版本之间的向前兼容性，避免升级导致问题。

2）应用环境比较复杂，可能会出问题。所以一定要逐步的升级，让用户测试环境经过验证。

3）提前通知用户，让用户知道这个事情。而且允许用户不做升级操作。

# chat

## java jar sdk 想实现静默升级，有哪些方式

实现Java应用的静默升级有多种方式，以下是一些常见的方法：

1. **自动更新工具：** 使用专门的自动更新工具，如[Java Web Start](https://docs.oracle.com/javase/8/docs/technotes/guides/javaws/)或[GetDown](https://github.com/threerings/getdown)。这些工具可以帮助您在应用启动时检查并下载新版本，然后自动升级应用。

2. **版本检查服务：** 在应用启动时连接到服务器，检查当前应用的版本是否是最新版本。如果不是，下载并安装新版本。您可以使用HTTP或FTP等协议进行文件传输。

3. **自定义升级逻辑：** 实现自己的升级逻辑。在应用启动时，应用程序可以检查服务器上的版本信息，如果有新版本，则下载并替换旧版本的JAR文件。可以使用Java的网络库（如`java.net`包）进行文件下载，然后使用自定义的代码来完成替换和升级。

4. **使用JavaFX的自动更新功能：** 如果您的应用使用JavaFX，JavaFX提供了[Deployment Toolkit](https://docs.oracle.com/javafx/2/deployment/self-contained-packaging.htm)来支持自动更新。

5. **Java插件框架：** 使用插件框架，例如[Java Plugin Framework (JPF)](https://github.com/jpf/jpf)。通过插件框架，您可以在应用运行时动态加载和卸载模块，从而实现模块的更新和替换。

请注意，无论哪种方式，静默升级可能会涉及到文件替换，因此需要谨慎处理以确保升级过程的稳定性和完整性。另外，确保在进行任何升级之前备份用户数据，以防止数据丢失。

## jar 包上传到 nexus，可以使用 snapshot 让用户无感升级。也可以直接删除替换，还有其他方式吗？

上传到 Nexus 或其他 Maven 仓库并使用 Snapshot 版本是一种常见的方式来进行快速开发和测试，但在生产环境中，不推荐直接依赖于 Snapshot 版本进行发布和升级。 Snapshot 版本通常是不稳定的，因此在生产环境中更推荐使用稳定的版本。

对于在 Nexus 或其他 Maven 仓库中的 JAR 包进行升级的方式，以下是一些建议：

1. **发布稳定版本：** 推荐发布稳定版本，而不是使用快照版本。稳定版本更适合在生产环境中使用，因为它们经过充分的测试，较为可靠。

2. **版本管理工具：** 使用版本管理工具，如 [Semantic Versioning (SemVer)](https://semver.org/)，以规范化版本号。这可以帮助您和用户更好地理解版本之间的变化和向后兼容性。

3. **增量更新：** 将更新分为小的增量步骤，而不是一次性替换整个 JAR 包。这可以减小升级的风险，同时使用户感受到更小的影响。

4. **插件化架构：** 如果可能的话，设计您的应用以支持插件化架构，使得您可以在不中断主要功能的情况下，动态加载和卸载插件或模块。这样，您就可以通过更新插件来实现一些功能的更新，而无需替换整个应用。

5. **热更新技术：** 某些框架和工具提供了热更新的功能，允许您在运行时更新部分代码而无需停止整个应用。例如，Java 中的 [JRebel](https://www.jrebel.com/) 就是一个支持热更新的工具。

6. **蓝绿部署：** 实施蓝绿部署策略，即在新版本和旧版本之间逐步切换流量。这有助于降低升级风险，并在问题发生时快速回滚。

选择哪种方式取决于您的应用需求、部署环境和用户体验的考虑。

在任何情况下，都建议在生产环境中进行充分的测试，并备份关键数据以防万一。

# 参考资料

chat

* any list
{:toc}