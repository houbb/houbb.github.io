---
layout: post
title: å¦‚ä½•è®¾è®¡å®ç°å¼€å‘è‡ªåŠ©é‡å¯å·¥å…·-05-èŠä¸€èŠæœåŠ¡å¦‚ä½•åˆ¤æ–­å·²ç»æœ‰è¯·æ±‚äº†ï¼Ÿ
date: 2025-6-20 23:45:51 +0800
categories: [Tool]
tags: [tool, sh]
published: true
---

# å¼€å‘è‡ªåŠ©é‡å¯

è¯´æ˜ï¼šæœ‰æ—¶å€™ç ”å‘äº§çº¿éœ€è¦é‡å¯ï¼Œä¸ºäº†ä¿è¯å®‰å…¨ã€æˆ–è€…è¯´æå‡æ•ˆç‡ï¼Œæœ€å¥½æœ‰ä¸€ä¸ªç»Ÿä¸€çš„ç ”å‘è‡ªåŠ©é‡å¯é¡µé¢ã€‚

è¿™ä¸ªåŠŸèƒ½å¯åº”ç”¨çš„å‘å¸ƒæœ‰ä¸€äº›ç±»ä¼¼ä¹‹å¤„ã€‚é‚£ä¹ˆè¿™ä¸ªåŠŸèƒ½å…·ä½“åº”è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ

# chat

# å¥åº·å’Œå°±ç»ªURL

Qï¼š

```
java çš„åº”ç”¨åœ¨å¯åŠ¨ä¹‹åï¼Œå¦‚æœå·²ç»å¯ç”¨æµé‡ã€‚

åˆåº”è¯¥å¦‚ä½•åˆ¤æ–­æ˜¯å¦æœ‰è¯·æ±‚æ­£å¸¸è¿›æ¥ï¼Ÿ

æœ€å¥½å¯ä»¥è‡ªåŠ¨åŒ–çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡ api ä¹‹ç±»çš„ï¼Œæ–¹ä¾¿å’Œè‡ªåŠ©é‡å¯å·¥å…·é›†æˆ
```

éå¸¸å¥½ï¼Œè¿™æ˜¯**æœåŠ¡ä¸Šçº¿ä¹‹åå¥åº·ç›‘æ§é—­ç¯çš„æœ€åä¸€æ­¥**ï¼š

> âœ… åº”ç”¨é‡å¯ â†’ âœ… æˆåŠŸä¸Šçº¿æ¥æµé‡ â†’ âœ… å®é™…æœ‰è¯·æ±‚è¿›æ¥ï¼ˆä¸šåŠ¡ç¡®è®¤ï¼‰

æˆ‘ä»¬ä¸èƒ½åªé ã€ŒæœåŠ¡å¯åŠ¨æˆåŠŸã€æˆ–ã€Œå°±ç»ªæ¢é’ˆé€šè¿‡ã€ï¼Œè¿˜åº”è¯¥ç¡®ä¿ï¼š

> **æœåŠ¡çœŸæ­£å¼€å§‹å¤„ç†å®é™…æµé‡äº†ï¼ˆä¾‹å¦‚ HTTPã€RPCã€æ¶ˆæ¯ç­‰ï¼‰**

---

## âœ… ç›®æ ‡ï¼šé‡å¯ä¸Šçº¿åï¼Œ**æ£€æµ‹æ˜¯å¦æœ‰çœŸå®è¯·æ±‚è¿›æ¥**

è¿™ä¸ªç›®æ ‡å¯ä»¥ç”¨äºï¼š

* åˆ¤æ–­æµé‡æ˜¯å¦æ¥å…¥æˆåŠŸï¼›
* è‡ªåŠ¨é‡å¯å¤±è´¥èŠ‚ç‚¹ï¼›
* è‡ªåŠ©å·¥å…·åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•æˆ–æŠ¥è­¦ã€‚

---

## ğŸ§  å®ç°æ–¹å¼æ€»è§ˆï¼ˆä»æ˜“åˆ°éš¾ï¼‰

| å®ç°æ–¹æ¡ˆ            | æ£€æµ‹æ–¹å¼                   | è‡ªåŠ¨åŒ–ç¨‹åº¦ | è¯´æ˜        |
| --------------- | ---------------------- | ----- | --------- |
| âœ… **è¯·æ±‚è®¡æ•°å™¨ API** | ç»Ÿè®¡è®¿é—®é‡                  | é«˜     | æ¨èæ–¹å¼      |
| âœ… è®¿é—®æ—¥å¿—ç›‘æ§        | è¯»å–æ—¥å¿— / Prometheus      | é«˜     | å¯æ¥å…¥ç°æœ‰ç›‘æ§ä½“ç³» |
| âœ… æ¥å…¥å±‚/ç½‘å…³ç»Ÿè®¡      | é€šè¿‡ Nginx / Istio / SLB | ä¸­     | å¯æŸ¥æ˜¯å¦æœ‰æµé‡è¿›æ¥ |
| âœ… APM é“¾è·¯ç³»ç»Ÿ      | æ¥å…¥ Skywalking / Zipkin | ä¸­     | ä¸šåŠ¡ç²’åº¦æ›´é«˜    |
| â›” åªé æ¢é’ˆ          | æ— æ³•ç¡®è®¤çœŸå®è¯·æ±‚               | ä¸å¯ç”¨   | å°±ç»ªä¸ä»£è¡¨è¢«è°ƒç”¨äº† |

---

## âœ… æ¨èæ–¹æ¡ˆï¼šæœåŠ¡æä¾›â€œè¯·æ±‚ç›‘æ§ APIâ€ï¼Œä¾›è‡ªåŠ©å¹³å°è°ƒç”¨

### ğŸ§© æ­¥éª¤ä¸€ï¼šæ·»åŠ å…¨å±€è¯·æ±‚è®¡æ•°å™¨ï¼ˆSpring Bootï¼‰

```java
@Component
public class TrafficMonitorInterceptor implements HandlerInterceptor {

    private final AtomicLong requestCount = new AtomicLong(0);

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        requestCount.incrementAndGet();
        return true;
    }

    public long getRequestCount() {
        return requestCount.get();
    }
}
```

> æ³¨æ„ï¼šä¹Ÿå¯ä»¥ç»Ÿè®¡æ¯åˆ†é’Ÿè¯·æ±‚æ•°ã€æ¯ä¸ªæ¥å£è®¿é—®é‡ç­‰

---

### ğŸ§© æ­¥éª¤äºŒï¼šæš´éœ²è¯·æ±‚ç»Ÿè®¡ APIï¼ˆæˆ–æŒ‚åˆ° `/actuator`ï¼‰

```java
@RestController
@RequestMapping("/internal")
public class RequestStatsController {

    @Autowired
    private TrafficMonitorInterceptor trafficMonitorInterceptor;

    @GetMapping("/request-stats")
    public Map<String, Object> stats() {
        return Map.of(
            "totalRequests", trafficMonitorInterceptor.getRequestCount(),
            "timestamp", System.currentTimeMillis()
        );
    }
}
```

---

### ğŸ§© æ­¥éª¤ä¸‰ï¼šè‡ªåŠ©é‡å¯å¹³å°è°ƒç”¨è¿™ä¸ª API

```text
æœåŠ¡é‡å¯ â†’ ç­‰å¾…å°±ç»ª â†’ åŠ å…¥æµé‡ â†’ 
å»¶è¿Ÿ 10 ç§’ â†’ è°ƒç”¨ /internal/request-stats â†’
è‹¥è¯·æ±‚æ•° >= 1ï¼Œè¯´æ˜æœ‰æµé‡ â†’ æ ‡è®°ä¸Šçº¿æˆåŠŸ âœ…
å¦åˆ™ç»§ç»­ç­‰å¾…æˆ–å‘Šè­¦ â—
```

å¯è®¾å®šï¼š

* è¶…æ—¶åˆ¤æ–­ï¼ˆå¦‚ 30 ç§’ä»æ— è¯·æ±‚æ•°ï¼‰
* å¤šæ¬¡è½®è¯¢ï¼Œç¡®å®šè¶‹åŠ¿ï¼ˆé 0ï¼‰

---

## âœ… é«˜çº§æ–¹æ¡ˆï¼šç»“åˆ Prometheus æˆ– APM

å¦‚æœä½ å·²æœ‰ç›‘æ§ç³»ç»Ÿï¼Œå¯ä»¥ï¼š

### ğŸ“Š æ–¹å¼ä¸€ï¼šPrometheus + Micrometer ç›‘æ§è¯·æ±‚æ•°

```properties
management.metrics.export.prometheus.enabled=true
```

Spring Boot è‡ªåŠ¨æš´éœ² `/actuator/prometheus`ï¼Œå¯ä»¥æŠ“å–ä»¥ä¸‹æŒ‡æ ‡ï¼š

* `http_server_requests_seconds_count{method="GET",status="200",uri="/xxx"}`

ä½ ä¹Ÿå¯ä»¥åšä¸€ä¸ªå°ç¨‹åºå®šæœŸæ‹‰ Prometheus æ•°æ®åˆ¤æ–­æ˜¯å¦æœ‰æµé‡ã€‚

---

### ğŸ¯ æ–¹å¼äºŒï¼šæ—¥å¿—åˆ†æï¼ˆæŒ‰æ—¥å¿—åˆ¤æ–­è¯·æ±‚ï¼‰

æ—¥å¿—ä¸­æœ‰ï¼š

```
[INFO] GET /api/user 200 123ms
```

å¯ä»¥ç”¨ï¼š

* ELK
* Fluentd + Loki
* æˆ–è‡ªå®šä¹‰è„šæœ¬è¯»å– `/var/log/app.log` æ£€æŸ¥æœ€è¿‘æ˜¯å¦æœ‰è®°å½•

---

## âœ… æ€»ç»“ï¼šå¼ºçƒˆå»ºè®®å®ç°ä¸€ä¸ªç®€å•çš„ã€Œè¯·æ±‚æ•° APIã€

| é¡¹ç›®                           | æ¨èçŠ¶æ€  | åŸå›              |
| ---------------------------- | ----- | -------------- |
| æä¾› `/internal/request-stats` | âœ… å¿…å¤‡  | å¹³å°å¯è½®è¯¢          |
| åˆå§‹è¯·æ±‚è®¡æ•°ä¸º 0                    | âœ… åˆç†  | åˆ¤æ–­ä¸Šçº¿åæ˜¯å¦çœŸçš„æœ‰æµé‡è¿›æ¥ |
| 30 ç§’åä»ä¸º 0                    | âš ï¸ å‘Šè­¦ | è¯´æ˜æœåŠ¡æœªçœŸæ­£ä¸Šçº¿æˆ–æ¥å…¥å¤±è´¥ |
| æ”¯æŒå®šæ—¶æ¸…é›¶ / æœ€è¿‘çª—å£è¯·æ±‚æ•°             | âœ… å¯é€‰  | æ›´ç²¾å‡†åæ˜ æ˜¯å¦æœ‰â€œè¿‘æœŸâ€è¯·æ±‚ |

# å‚è€ƒèµ„æ–™

* any list
{:toc}  