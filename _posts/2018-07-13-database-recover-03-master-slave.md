---
layout: post
title:  数据库高可用方案-03-主备等高可用架构
date:  2018-07-13 17:39:24 +0800
categories: [Database]
tags: [database, sql, master-slave, distributed, sh]
published: true
---

# 数据库数据高可用系列

[数据库高可用方案-01-数据库备份还原方案](https://houbb.github.io/2018/07/13/database-recover)

[数据库高可用方案-02-多机房部署](https://houbb.github.io/2018/07/13/database-recover-02-multi-place)

[数据库高可用方案-03-主备等高可用架构](https://houbb.github.io/2018/07/13/database-recover-03-master-slave)

[数据库高可用方案-04-删除策略](https://houbb.github.io/2018/07/13/database-recover-04-delete-strategy)

[数据库高可用方案-05-备份与恢复](https://houbb.github.io/2018/07/13/database-recover-05-recover)

[数据库高可用方案-06-监控与报警](https://houbb.github.io/2018/07/13/database-recover-06-monitor-and-alarm)

[数据库高可用方案-07-一致性校验](https://houbb.github.io/2018/07/13/database-recover-07-checksum)

[数据库高可用方案-08-多版本管理](https://houbb.github.io/2018/07/13/database-recover-08-version-manager)

[数据库高可用方案-09-数据库的灾难恢复演练](https://houbb.github.io/2018/07/13/database-recover-09-problem-recover-test)


# 主备高可用架构

主备高可用架构（Master-Slave High Availability Architecture）是数据库高可用解决方案之一，旨在确保在某个数据库实例（主库）发生故障时，系统能够自动切换到备用数据库（备库），从而避免系统停机时间，确保系统的稳定性和可靠性。

主备架构广泛应用于数据库的高可用性设计中，尤其适用于读写分离场景。

### 1. 主备高可用架构的基本概念

在主备架构中：
- 主库（Master）：处理所有写操作（INSERT、UPDATE、DELETE）以及部分或所有读操作。主库通常是数据源，承载应用程序的主要业务数据。
- 备库（Slave）：备库是主库的副本，通常只用于处理读取操作，接收并应用来自主库的数据更新。备库不能处理写入操作，通常在主库发生故障时提升为主库。

主备架构可以是 同步复制 或 异步复制，决定了数据同步的延迟和一致性保障。

### 2. 主备架构的工作原理

1. 数据同步：主库的数据更新（写操作）会被实时或延迟地同步到备库。具体的同步方式决定了数据一致性的保障水平。
   
2. 故障转移与恢复：当主库发生故障时，备库可以被提升为新的主库，继续处理数据库请求，避免系统中断。这一过程称为“故障转移”（Failover）。有些系统可以自动进行故障转移，而有些则需要手动干预。

3. 读写分离：通过将主库负责写操作，备库负责读操作，能够将数据库的负载进行分离，提高读写性能。

4. 健康检查与心跳机制：系统通过心跳检查主库和备库的健康状态，定期监测数据库的可用性。如果主库失去响应，系统会自动或手动进行故障转移，确保高可用性。

### 3. 主备架构的类型

主备架构有几种常见的部署方式，取决于数据同步的方式和故障转移机制：

#### 1. 同步复制（Synchronous Replication）
   - 基本概念：在同步复制模式下，主库的写操作会等待所有备库确认收到数据后，才会提交。这样可以确保主库和备库的数据在同一时刻保持一致。
   - 优缺点：
     - 优点：数据一致性高，主库和备库数据完全同步，避免了主备库数据不一致的风险。
     - 缺点：性能较差，写操作需要等待备库确认，这增加了延迟和吞吐量的限制，特别是在跨机房的情况下，延迟会更明显。

#### 2. 异步复制（Asynchronous Replication）
   - 基本概念：在异步复制模式下，主库的写操作会立即提交，备库则在稍后时间将数据更新到本地。此时主库和备库之间可能存在数据延迟，即数据同步存在时间差。
   - 优缺点：
     - 优点：性能较好，主库写操作不需要等待备库确认，能够提高写操作的吞吐量。
     - 缺点：主库和备库之间可能出现数据不一致的情况，尤其在主库发生故障后，可能会丢失一些未同步到备库的数据。

#### 3. 半同步复制（Semi-Synchronous Replication）
   - 基本概念：半同步复制介于同步复制和异步复制之间，主库在写操作提交时，需要至少一个备库确认已接收到数据，但不需要等待所有备库都确认。这种方式能在一定程度上兼顾性能和数据一致性。
   - 优缺点：
     - 优点：在保障数据一致性的同时，减少了等待备库确认的时间，提高了性能。
     - 缺点：数据一致性稍低于同步复制，但比异步复制更高。

### 4. 主备架构的故障转移与恢复

故障转移（Failover）是主备架构中核心的高可用特性，它确保当主库不可用时，备库能够自动或手动切换为新的主库，继续提供服务。

#### 自动故障转移
- 自动故障转移通常基于心跳机制和健康检查来实现。如果主库在一定时间内没有响应（例如，主库崩溃或断网），备库将自动被提升为新的主库。
- 一些高级数据库系统（如 MySQL、PostgreSQL、Oracle）提供了自动化工具或服务来管理这一过程。常见的自动故障转移工具包括 MHA（MySQL高可用）、Orchestrator（MySQL集群管理工具）、Patroni（PostgreSQL高可用）。
- 自动故障转移的关键是 监控机制 和 自动化脚本，它们能够确保在主库出现问题时，能够迅速切换到备库，并重新建立主备关系。

#### 手动故障转移
- 在一些场景中，故障转移可能需要管理员手动操作，特别是在数据库系统本身没有自动化工具时。管理员需要确认主库出现故障，然后手动将备库提升为主库，并重新配置其他备库连接。
- 手动故障转移通常涉及备库提升、客户端重新连接和数据恢复等操作，可能需要较长的恢复时间。

### 5. 读写分离与负载均衡

- 读写分离：在主备架构中，通常会将写操作指向主库，而读操作指向备库。这种方式能够有效提高数据库的吞吐量，尤其在读操作较多的场景中，备库的读操作可以减轻主库的负担。
- 负载均衡：可以利用负载均衡器（如 HAProxy、Nginx）将读请求分配到不同的备库，确保各个备库的负载均衡。这也有助于在主库发生故障时，自动将读写请求转发到新的主库。

### 6. 主备架构的优势与不足

#### 优势
- 高可用性：主备架构能有效避免单点故障，提高系统的可用性。当主库出现故障时，能够迅速切换到备库，减少停机时间。
- 读写分离：通过主备架构，能够将读操作分担到备库，从而提高整个系统的吞吐量。
- 灾难恢复：通过备库的存在，在主库发生灾难性故障时，能够迅速恢复服务，减少数据丢失和服务中断时间。

#### 不足
- 性能损耗：如果采用同步复制，写操作的延迟会增加，因为主库需要等待备库确认数据接收。
- 数据一致性问题：在异步复制的情况下，主库和备库之间可能会存在数据延迟，导致主库故障时可能会丢失一些数据。
- 管理复杂性：虽然主备架构能提高可用性，但如何管理和监控多个数据库实例、进行故障转移、确保数据一致性等，都需要额外的管理工作。

### 7. 主备架构的实施建议

- 定期备份：尽管主备架构能保证高可用，但仍然需要定期备份数据，以防止数据丢失。
- 监控与报警：设置实时监控和报警机制，确保能够及时发现主库或备库的问题，提前采取措施。
- 自动化管理：使用自动化工具（如 MHA、Orchestrator 等）来简化主备切换和数据库管理，减少人工干预。

### 总结

主备高可用架构是一种通过主库和备库的配合，实现数据库高可用性的架构设计。

通过合理配置同步、异步或半同步复制，利用自动或手动故障转移机制，可以有效保证数据库系统在发生故障时迅速恢复，避免长时间的停机或数据丢失。

同时，读写分离和负载均衡能够提升系统的吞吐量，增强系统的处理能力。

* any list
{:toc}