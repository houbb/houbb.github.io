---
layout: post
title: Redis
date:  2016-6-22 14:54:00 +0800
categories: [NoSQL]
tags: [redis]
published: true
---

* any list
{:toc}


# Redis

Redis is an open source (BSD licensed), in-memory data structure store, used as database, cache and message broker. 
It supports data structures such as strings, hashes, lists, sets, sorted sets with range queries, bitmaps, hyperloglogs 
and geospatial indexes with radius queries. 

> [redis](http://redis.io/)

> [zh_CN](http://www.redis.cn/)

# Cygwin

## install

Redis is not supported on Windows by the official website. So, you can use **Cygwin**  to get that Linux feeling on Windows.

> [install](https://cygwin.com/install.html)

Download the [setup-x86_64.exe](https://cygwin.com/setup-x86_64.exe) and run it. 

Next, Next ... [How zh_CN](http://www.cygwin.cn/site/install/)

Util you meet this.

![setting]({{ site.url }}/static/app/img/2016-06-22-Cygwin.png)

We need **gcc** and **make** under the Devel, click the **Skip** and choose the right version to install.

- gcc

```
$   C complier upgrade helper           --not found

$   gcc-core

$   gcc-g++

$   gdb: The GUN Debugger
```

- make 

```
$   make: The GUN version of 'make' utility
```

The process of install will cost a lot time. 

One hour later.

## check

Let's check the compile environment.

```
$   gcc -v

使用内建 specs。
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/lto-wrapper.exe
目标：x86_64-pc-cygwin
配置为：...
线程模型：posix
gcc 版本 5.4.0 (GCC)


$   make -v

GNU Make 4.2.1
为 x86_64-unknown-cygwin 编译
Copyright (C) 1988-2016 Free Software Foundation, Inc.
许可证：GPLv3+：GNU 通用公共许可证第 3 版或更新版本<http://gnu.org/licenses/gpl.html>。
本软件是自由软件：您可以自由修改和重新发布它。
在法律允许的范围内没有其他保证。
```

# Install Redis

## Edit File

- redis.h

Open the **redis.h** under the path of {YourRedisPath}/src.
 
add these code at the first line.

```c
#ifndef SA_ONSTACK
#define SA_ONSTACK 0
#endif
```

- object.c

Open the **object.c** under the path of {YourRedisPath}/src.
 
add these code at the first line.

```c
#define strtold(a,b)  ((long double)strtold((a), (b)))
```

But, the **redis-3.2.1** seems has no need to edit.
 
## Install

Open your redis source package.

```
$   cd redis

$   ls
00-RELEASENOTES  COPYING  Makefile   redis.conf       runtest-sentinel  tests
BUGS             deps     MANIFESTO  runtest          sentinel.conf     utils
CONTRIBUTING     INSTALL  README.md  runtest-cluster  src
```

- compile the depends jar.
 
```
$   cd deps
$   make lua hiredis linenoise

(cd hiredis && make clean) > /dev/null || true
(cd linenoise && make clean) > /dev/null || true
(cd lua && make clean) > /dev/null || true
(cd geohash-int && make clean) > /dev/null || true
(cd jemalloc && [ -f Makefile ] && make distclean) > /dev/null || true
(rm -f .make-*)
(echo "" > .make-cflags)
(echo "" > .make-ldflags)
MAKE lua
cd lua/src && make all CFLAGS="-O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC='' " MYLDFLAGS="" AR="ar rcu"
make[1]: 进入目录“/cygdrive/d/redis/deps/lua/src”
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lapi.o lapi.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lcode.o lcode.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ldebug.o ldebug.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ldo.o ldo.c
ldo.c: 在函数‘f_parser’中:
ldo.c:496:7: 警告：未使用的变量‘c’ [-Wunused-variable]
   int c = luaZ_lookahead(p->z);
       ^
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ldump.o ldump.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lfunc.o lfunc.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lgc.o lgc.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o llex.o llex.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lmem.o lmem.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lobject.o lobject.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lopcodes.o lopcodes.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lparser.o lparser.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lstate.o lstate.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lstring.o lstring.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ltable.o ltable.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ltm.o ltm.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lundump.o lundump.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lvm.o lvm.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lzio.o lzio.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o strbuf.o strbuf.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o fpconv.o fpconv.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lauxlib.o lauxlib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lbaselib.o lbaselib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ldblib.o ldblib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o liolib.o liolib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lmathlib.o lmathlib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o loslib.o loslib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o ltablib.o ltablib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lstrlib.o lstrlib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o loadlib.o loadlib.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o linit.o linit.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua_cjson.o lua_cjson.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua_struct.o lua_struct.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua_cmsgpack.o lua_cmsgpack.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua_bit.o lua_bit.c
ar rcu liblua.a lapi.o lcode.o ldebug.o ldo.o ldump.o lfunc.o lgc.o llex.o lmem.o lobject.o lopcodes.o lparser.o lstate.o lstring.o ltable.o ltm.o lundump.o lvm.o lzio.o strbuf.o fpconv.o lauxlib.o lbaselib.o ldblib.o liolib.o lmathlib.o loslib.o ltablib.o lstrlib.o loadlib.o linit.o lua_cjson.o lua_struct.o lua_cmsgpack.o lua_bit.o  # DLL needs all object files
ranlib liblua.a
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o lua.o lua.c
cc -o lua  lua.o liblua.a -lm
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o luac.o luac.c
cc -O2 -Wall -DLUA_ANSI -DENABLE_CJSON_GLOBAL -DREDIS_STATIC=''    -c -o print.o print.c
cc -o luac  luac.o print.o liblua.a -lm
make[1]: 离开目录“/cygdrive/d/redis/deps/lua/src”
make: *** 没有规则可制作目标“hierdis”。 停止。
```

- compile the source

```
$   cd ..
$   make && make install

cd src && make all
make[1]: 进入目录“/cygdrive/d/redis/src”
rm -rf redis-server redis-sentinel redis-cli redis-benchmark redis-check-rdb redis-check-aof *.o *.gcda *.gcno *.gcov redis.info lcov-html
(cd ../deps && make distclean)
make[2]: 进入目录“/cygdrive/d/redis/deps”
(cd hiredis && make clean) > /dev/null || true
(cd linenoise && make clean) > /dev/null || true
(cd lua && make clean) > /dev/null || true
(cd geohash-int && make clean) > /dev/null || true
(cd jemalloc && [ -f Makefile ] && make distclean) > /dev/null || true
(rm -f .make-*)
make[2]: 离开目录“/cygdrive/d/redis/deps”
(rm -f .make-*)
echo STD=-std=c99 -pedantic -DREDIS_STATIC='' >> .make-settings
echo WARN=-Wall -W >> .make-settings
echo OPT=-O2 >> .make-settings
echo MALLOC=libc >> .make-settings
echo CFLAGS= >> .make-settings
echo LDFLAGS= >> .make-settings
echo REDIS_CFLAGS= >> .make-settings
echo REDIS_LDFLAGS= >> .make-settings
echo PREV_FINAL_CFLAGS=-std=c99 -pedantic -DREDIS_STATIC='' -Wall -W -O2 -g -ggdb   -I../deps/geohash-int -I../deps/hiredis -I../deps/linenoise -I../deps/lua/src >> .make-settings
echo PREV_FINAL_LDFLAGS=  -g -ggdb -rdynamic >> .make-settings
(cd ../deps && make hiredis linenoise lua geohash-int)
make[2]: 进入目录“/cygdrive/d/redis/deps”
(cd hiredis && make clean) > /dev/null || true
(cd linenoise && make clean) > /dev/null || true
(cd lua && make clean) > /dev/null || true
(cd geohash-int && make clean) > /dev/null || true
(cd jemalloc && [ -f Makefile ] && make distclean) > /dev/null || true
(rm -f .make-*)
(echo "" > .make-cflags)
(echo "" > .make-ldflags)
MAKE hiredis
cd hiredis && make static
make[3]: 进入目录“/cygdrive/d/redis/deps/hiredis”
cc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-strings -g -ggdb  net.c
net.c:1:0: 警告：-fPIC 在目标机上被忽略 (所有代码都是与位置无关的)
 /* Extracted from anet.c to work properly with Hiredis error reporting.
 ^
net.c: 在函数‘redisKeepAlive’中:
net.c:143:37: 错误：‘TCP_KEEPIDLE’未声明(在此函数内第一次使用)
     if (setsockopt(fd, IPPROTO_TCP, TCP_KEEPIDLE, &val, sizeof(val)) < 0) {
                                     ^
net.c:143:37: 附注：每个未声明的标识符在其出现的函数内只报告一次
net.c:150:37: 错误：‘TCP_KEEPINTVL’未声明(在此函数内第一次使用)
     if (setsockopt(fd, IPPROTO_TCP, TCP_KEEPINTVL, &val, sizeof(val)) < 0) {
                                     ^
net.c:156:37: 错误：‘TCP_KEEPCNT’未声明(在此函数内第一次使用)
     if (setsockopt(fd, IPPROTO_TCP, TCP_KEEPCNT, &val, sizeof(val)) < 0) {
                                     ^
make[3]: *** [Makefile:118：net.o] 错误 1
make[3]: 离开目录“/cygdrive/d/redis/deps/hiredis”
make[2]: *** [Makefile:47：hiredis] 错误 2
make[2]: 离开目录“/cygdrive/d/redis/deps”
make[1]: [Makefile:156：persist-settings] 错误 2 (已忽略）
    CC adlist.o
    CC quicklist.o
    CC ae.o
In file included from ae.c:58:0:
ae_select.c:35:5: 错误：未知的类型名‘fd_set’
     fd_set rfds, wfds;
     ^
ae_select.c:38:5: 错误：未知的类型名‘fd_set’
     fd_set _rfds, _wfds;
     ^
ae_select.c: 在函数‘aeApiCreate’中:
ae_select.c:45:5: 警告：隐式声明函数‘FD_ZERO’ [-Wimplicit-function-declaration]
     FD_ZERO(&state->rfds);
     ^
ae_select.c: 在函数‘aeApiResize’中:
ae_select.c:53:20: 错误：‘FD_SETSIZE’未声明(在此函数内第一次使用)
     if (setsize >= FD_SETSIZE) return -1;
                    ^
ae_select.c:53:20: 附注：每个未声明的标识符在其出现的函数内只报告一次
ae_select.c:51:37: 警告：未使用的参数‘eventLoop’ [-Wunused-parameter]
 static int aeApiResize(aeEventLoop *eventLoop, int setsize) {
                                     ^
ae_select.c: 在函数‘aeApiAddEvent’中:
ae_select.c:64:29: 警告：隐式声明函数‘FD_SET’ [-Wimplicit-function-declaration]
     if (mask & AE_READABLE) FD_SET(fd,&state->rfds);
                             ^
ae_select.c: 在函数‘aeApiDelEvent’中:
ae_select.c:72:29: 警告：隐式声明函数‘FD_CLR’ [-Wimplicit-function-declaration]
     if (mask & AE_READABLE) FD_CLR(fd,&state->rfds);
                             ^
ae_select.c: 在函数‘aeApiPoll’中:
ae_select.c:80:46: 错误：‘fd_set’未声明(在此函数内第一次使用)
     memcpy(&state->_rfds,&state->rfds,sizeof(fd_set));
                                              ^
ae_select.c:83:14: 警告：隐式声明函数‘select’ [-Wimplicit-function-declaration]
     retval = select(eventLoop->maxfd+1,
              ^
ae_select.c:91:43: 警告：隐式声明函数‘FD_ISSET’ [-Wimplicit-function-declaration]
             if (fe->mask & AE_READABLE && FD_ISSET(j,&state->_rfds))
                                           ^
ae.c: 在函数‘aeGetTime’中:
ae.c:184:5: 警告：隐式声明函数‘gettimeofday’ [-Wimplicit-function-declaration]
     gettimeofday(&tv, NULL);
     ^
make[1]: *** [Makefile:201：ae.o] 错误 1
make[1]: 离开目录“/cygdrive/d/redis/src”
make: *** [Makefile:6：all] 错误 2
```



