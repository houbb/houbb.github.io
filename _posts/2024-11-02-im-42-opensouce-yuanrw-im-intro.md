---
layout: post
title: IM å³æ—¶é€šè®¯ç³»ç»Ÿ-42-åŸºäºnettyå®ç°çš„IMæœåŠ¡ç«¯,æä¾›å®¢æˆ·ç«¯jaråŒ…,å¯é›†æˆè‡ªå·±çš„ç™»å½•ç³»ç»Ÿ
date: 2024-11-02 21:01:55 +0800
categories: [IM]
tags: [im, opensource, sh]
published: true
---

# IM å¼€æºç³»åˆ—

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-41-å¼€æº é‡ç«IM ä¸“æ³¨äºå³æ—¶é€šè®¯å®æ—¶éŸ³è§†é¢‘æŠ€æœ¯ï¼Œæä¾›ä¼˜è´¨å¯æ§çš„IM+RTCèƒ½åŠ›](https://houbb.github.io/2024/11/02/im-41-opensouce-yehuo-overview)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-42-åŸºäºnettyå®ç°çš„IMæœåŠ¡ç«¯,æä¾›å®¢æˆ·ç«¯jaråŒ…,å¯é›†æˆè‡ªå·±çš„ç™»å½•ç³»ç»Ÿ](https://houbb.github.io/2024/11/02/im-42-opensouce-yuanrw-im-intro)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-43-ç®€å•çš„ä»¿QQèŠå¤©å®‰å“APP](https://houbb.github.io/2024/11/02/im-43-opensouce-xiuweikang-im)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-44-ä»¿QQå³æ—¶é€šè®¯ç³»ç»ŸæœåŠ¡ç«¯](https://houbb.github.io/2024/11/02/im-44-opensouce-kingston-csj-im)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-45-merua0oo0 IM åˆ†å¸ƒå¼èŠå¤©ç³»ç»Ÿ](https://houbb.github.io/2024/11/02/im-45-opensouce-merua0oo0-im)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-46-OpenIM æä¾›äº†ä¸“ä¸ºå¼€å‘è€…è®¾è®¡çš„å¼€æºå³æ—¶é€šè®¯è§£å†³æ–¹æ¡ˆ](https://houbb.github.io/2024/11/02/im-46-opensouce-open-im-intro)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-47-beardlessCat IM ä½¿ç”¨nettyå¼€å‘åˆ†å¸ƒå¼Imï¼Œæä¾›åˆ†å¸ƒnettyé›†ç¾¤è§£å†³æ–¹æ¡ˆ](https://houbb.github.io/2024/11/02/im-47-opensouce-beardlessCat-im-intro)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-48-aurora-imui æ˜¯ä¸ªé€šç”¨çš„å³æ—¶é€šè®¯ï¼ˆIMï¼‰UI åº“ï¼Œä¸ç‰¹å®šäºä»»ä½• IM SDK](https://houbb.github.io/2024/11/02/im-48-opensouce-aurora-imui-intro)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-49-äº‘ä¿¡ IM UIKit æ˜¯åŸºäº NIM SDKï¼ˆç½‘æ˜“äº‘ä¿¡ IM SDKï¼‰å¼€å‘çš„ä¸€æ¬¾å³æ—¶é€šè®¯ UI ç»„ä»¶åº“ï¼ŒåŒ…æ‹¬èŠå¤©ã€ä¼šè¯ã€åœˆç»„ã€æœç´¢ã€ç¾¤ç®¡ç†ç­‰ç»„ä»¶](https://houbb.github.io/2024/11/02/im-49-opensouce-nim-uikit-android-intro)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-50-ğŸ“²cim(cross IM) é€‚ç”¨äºå¼€å‘è€…çš„åˆ†å¸ƒå¼å³æ—¶é€šè®¯ç³»ç»Ÿ](https://houbb.github.io/2024/11/02/im-50-opensouce-cim-intro)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-51-MPushå¼€æºå®æ—¶æ¶ˆæ¯æ¨é€ç³»ç»Ÿ](https://houbb.github.io/2024/11/02/im-51-opensouce-mpush-intro)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-52-leo-im æœåŠ¡ç«¯](https://houbb.github.io/2024/11/02/im-52-opensouce-leo-im-intro)

[IM å³æ—¶é€šè®¯ç³»ç»Ÿ-53-im system server](https://houbb.github.io/2024/11/02/im-53-opensouce-linyu-intro)


# IM

[IM](https://github.com/yuanrw/IM?tab=readme-ov-file) æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å³æ—¶é€šä¿¡æœåŠ¡ç«¯ã€‚æä¾›å®¢æˆ·ç«¯jaråŒ…ï¼Œæ–¹ä¾¿é›†æˆäºŒæ¬¡å¼€å‘ã€‚

## åŠŸèƒ½

* å•èŠï¼šæ–‡å­—/æ–‡ä»¶
* å·²å‘é€/å·²é€è¾¾/å·²è¯»å›æ‰§
* æ”¯æŒé›†æˆldap
* æ”¯æŒé›†æˆç¬¬ä¸‰æ–¹ç™»å½•ç³»ç»Ÿ
* æ–¹ä¾¿æ°´å¹³æ‰©å±•
* æä¾›å®¢æˆ·ç«¯jaråŒ…

## å¿«é€Ÿä¸Šæ‰‹

### å‡†å¤‡å·¥ä½œ
ä½¿ç”¨dockerå¿«é€Ÿå¯åŠ¨ IM æœåŠ¡ã€‚

```
# detect if the docker environment is avaliable.
docker -v
```
```
# clone the repository
git clone git@github.com:yuanrw/IM.git
```

### å¯åŠ¨æœåŠ¡

```
cd IM/docker
docker-compose up
```

å®¹å™¨å†…æœ‰demoç¨‹åºï¼Œè‡ªåŠ¨å¯åŠ¨å¤šä¸ªå®¢æˆ·ç«¯å¹¶ä¸”éšæœºå‘é€æ¶ˆæ¯ï¼Œå¯åŠ¨æˆåŠŸåè¾“å‡ºå¦‚ä¸‹æ—¥å¿—:

```
......
2019-08-11 17:29:13.451 client-samples - [Olive] get a msg: 357980857883037697 has been read
2019-08-11 17:29:13.452 client-samples - [yuanrw] get a msg: 357980857887232002 has been read
2019-08-11 17:29:13.452 client-samples - [xianyy] get a msg: 357980857887232001 has been read
2019-08-11 17:29:13.452 client-samples - [Adela] get a msg: 357980857874649089 has been read
2019-08-11 17:29:13.452 client-samples - [Bella] get a msg: 357980857874649090 has been read
2019-08-11 17:29:13.452 client-samples - [Tom] get a msg: 357980857887232000 has been read



sentMsg: 51, readMsg: 51, hasSentAck: 51, hasDeliveredAck: 51, hasReadAck: 51, hasException: 0



2019-08-11 17:29:15.114 client-samples - [Bella]get a msg: 357980866275840002 has been sent
2019-08-11 17:29:15.114 client-samples - [Adela]get a msg: 357980866275840000 has been sent
2019-08-11 17:29:15.114 client-samples - [Cynthia]get a msg: 357980866275840003 has been sent
......
```

## åˆ†å¸ƒå¼éƒ¨ç½²
```
mvn clean package -DskipTests
```
åœ¨/targetç›®å½•ä¸‹ç”Ÿæˆ $SERVICE_NAME-$VERSION-bin.zip

### ç¯å¢ƒ
* java 8+
* mysql 5.7+
* rabbitmq
* redis

### å¯åŠ¨
æŒ‰ç…§**å¦‚ä¸‹é¡ºåº**å¯åŠ¨æœåŠ¡:
rest-web --> transfer -->connector

å¯åŠ¨`rest-web`çš„æ­¥éª¤å¦‚ä¸‹,`transfer`å’Œ`connector`ç±»ä¼¼.

#### rest-web
1. è§£å‹

```
unzip rest-web-$VERSION-bin.zip
cd rest-web-$VERSION
```

2. ä¿®æ”¹é…ç½®æ–‡ä»¶

```
server.port=8082

# æ—¥å¿—ç›®å½•
log.path=

# jdbcé…ç½®
spring.datasource.url=
......

# redisé…ç½®
spring.redis.host=
......

# rabbitmqé…ç½®
spring.rabbitmq.host=
......
```

3. æ‰§è¡Œ`rest.sql`åˆå§‹åŒ–åº“è¡¨

4. å¯åŠ¨æœåŠ¡

```
java -jar rest-web-$VERSION.jar --spring.config.location=application.properties
```

#### transfer
```
java -jar -Dconfig=transfer.properties transfer-$VERSION.jar
```

#### connector
```
java -jar -Dconfig=connector.properties connector-$VERSION.jar
```

## Nginxé…ç½®
æ‰€æœ‰çš„æœåŠ¡éƒ½èƒ½å¤Ÿæ°´å¹³æ‰©å±•ï¼Œå®¢æˆ·ç«¯å’ŒconnectoræœåŠ¡ç«¯éœ€è¦ä¿æŒé•¿è¿æ¥ã€‚
nginxå¯ä»¥å¦‚ä¸‹é…ç½®:

```conf
stream {
	upstream backend {
        # connector services port
        server 127.0.0.1:9081         max_fails=3 fail_timeout=30s;
        server 127.0.0.1:19081			max_fails=3 fail_timeout=30s;
	}

    server {
        # to keep a persistent connection
        listen 9999 so_keepalive=on;
        proxy_timeout 1d;
        proxy_pass backend;
    }
}
```

## Login
IMå«æœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„ç™»å½•ç³»ç»Ÿï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚  
ä¹Ÿæ”¯æŒä»¥ä¸‹ä¸¤ç§ç™»å½•æ–¹å¼ã€‚

### ldap
è¿™é‡Œä½¿ç”¨open ldapæ¥ç™»å½•ã€‚  
ä¿®æ”¹é…ç½®æ–‡ä»¶application.properties

```properties
spi.user.impl.class=com.yrw.im.rest.web.spi.impl.LdapUserSpiImpl

# the following config should be replace with your own config
spring.ldap.base=dc=example,dc=org
# admin
spring.ldap.username=cn=admin,dc=example,dc=org
spring.ldap.password=admin
spring.ldap.urls=ldap://127.0.0.1:389
# user filterï¼Œuse the filter to search user when login in
spring.ldap.searchFilter=
# search base eg. ou=dev
ldap.searchBase=
# user objectClass
ldap.mapping.objectClass=inetOrgPerson
ldap.mapping.loginId=uid
ldap.mapping.userDisplayName=gecos
ldap.mapping.email=mail
```
```
java -jar rest-web-$VERSION.jar --spring.config.location=application.properties
```
### è‡ªå·±çš„ç™»å½•ç³»ç»Ÿ

1. éœ€è¦å®ç°`com.yrw.im.rest.spi.UserSpi`ä¸­çš„æ¥å£

```java
public interface UserSpi<T extends UserBase> {

    /**
     * get user by username and password, return user(id can not be null)
     * if username and password are right, else return null.
     * <p>
     * be sure that your password has been properly encrypted
     *
     * @param username
     * @param pwd
     * @return
     */
    T getUser(String username, String pwd);

    /**
     * get user by id, if id not exist then return null.
     *
     * @param id
     * @return
     */
    T getById(String id);
}
```

2. ä¿®æ”¹é…ç½®æ–‡ä»¶application.properties

```
# ä½ çš„å®ç°ç±»çš„å…¨é™å®šç±»å
spi.user.impl.class=
```

3. æ‰“åŒ…

```
mvn clean package -DskipTests
```

## ä½¿ç”¨å®¢æˆ·ç«¯jaråŒ…
ä¸€ä¸ªä½¿ç”¨æ ·ä¾‹:

[MyClient.java](https://github.com/yuanrw/IM/blob/master/client-samples/src/main/java/com/github/yuanrw/im/client/sample/MyClient.java)

# å‚è€ƒèµ„æ–™

* any list
{:toc}