---
layout: post
title: java 实现 OCR 图片文字识别
date:  2020-1-9 10:09:32 +0800
categories: [OCR]
tags: [java, ocr, sh]
published: true
---

# OCR图像识别技术的JAVA实现

最近有个需求需要用图像识别，学习记录一下。

目前网络上的开源的图像识别技术有很多，例如 OCRE(OCR Easy)、Clara OCR、OCRAD、TESSERACT-OCR 等。

今天本blog将记录下tesseract-ocr的JAVA实现，便于以后查阅使用。

## 开源 ocr 引擎

[https://github.com/search?q=ocr](https://github.com/search?q=ocr) 直接 github 搜索，可以看到对应的 ocr 开源框架。

我们本次直接以排名第一的 [TESSERACT-OCR](https://github.com/tesseract-ocr/tesseract) 作为例子。


# TESSERACT-OCR 安装

首先下载EXE安装包进行安装，我安装的版本是“tesseract-ocr-setup-3.05.01.exe”，建议直接安装在默认路径。

[https://github.com/tesseract-ocr/tesseract/wiki](https://github.com/tesseract-ocr/tesseract/wiki) 这里是安装页面的 wiki。

本次测试的环境为 windows10，所以[下载 windows 相关的安装包](https://github.com/tesseract-ocr/tesseract/wiki#windows)。

## windows 下载地址

[所有的文件列表](https://digi.bib.uni-mannheim.de/tesseract/)

我这里直接下载了 [tesseract-ocr-w64-setup-v4.1.0.20190314.exe](https://digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-w64-setup-v4.1.0.20190314.exe)

## 安装

安装完毕后，目录下：

直接双击 exe，然后安装。

![image](https://user-images.githubusercontent.com/18375710/72050215-8f440080-32fb-11ea-830d-13ce7b51a948.png)

- 指定安装特定语言包

这里我们安装一下中文的语言训练包。

【chinese】相关的四个，简体，繁体（分别对应的默认和垂直。）

比较悲催的是全部下载失败。

- 安装路径

使用默认路径：

```
C:\Program Files\Tesseract-OCR
```

- 结果

```
λ ls
ambiguous_words.exe*     libcairo-2.dll*        libgomp-1.dll*       libpangocairo-1.0-0.dll*  libwebp-7.dll*                  tesseract.exe*
classifier_tester.exe*   libexpat-1.dll*        libharfbuzz-0.dll*   libpangoft2-1.0-0.dll*    libwinpthread-1.dll*            tesseract-uninstall.exe*
cntraining.exe*          libffi-6.dll*          libintl-8.dll*       libpangowin32-1.0-0.dll*  lstmeval.exe*                   text2image.exe*
combine_lang_model.exe*  libfontconfig-1.dll*   libjbig-2.dll*       libpcre-1.dll*            lstmtraining.exe*               unicharset_extractor.exe*
combine_tessdata.exe*    libfreetype-6.dll*     libjpeg-8.dll*       libpixman-1-0.dll*        merge_unicharsets.exe*          wordlist2dawg.exe*
dawg2wordlist.exe*       libgcc_s_seh-1.dll*    liblept-5.dll*       libpng16-16.dll*          mftraining.exe*                 zlib1.dll*
doc/                     libgif-7.dll*          liblzma-5.dll*       libstdc++-6.dll*          set_unicharset_properties.exe*
iconv.dll*               libglib-2.0-0.dll*     libopenjp2.dll*      libtesseract-4.dll*       shapeclustering.exe*
libbz2-1.dll*            libgobject-2.0-0.dll*  libpango-1.0-0.dll*  libtiff-5.dll*            tessdata/
```

### 训练集数据

`tessdata` 这个文件夹用来放各种语言的训练集合数据。

因为中文下载失败，目前里面只有英文的：

```
λ ls
configs/         eng.user-patterns  jaxb-api-2.3.1.jar  pdf.ttf                 piccolo2d-extras-3.0.jar  ScrollView.jar
eng.traineddata  eng.user-words     osd.traineddata     piccolo2d-core-3.0.jar  script/                   tessconfigs/
```

各种语言库的下载地址 [tessdata](https://github.com/tesseract-ocr/tessdata)

本节暂时不讨论中文相关的处理。

# 代码测试

## maven 引入

实际原理就是利用 java 指定 cmder 进行调用，为了方便，我们直接引入一个 jar 便于调用。

```xml
<dependency>
    <groupId>net.sourceforge.tess4j</groupId>
    <artifactId>tess4j</artifactId>
    <version>3.2.1</version>
</dependency>
```

## 图片

直接以如下图片做测试：

![image](https://user-images.githubusercontent.com/18375710/72053053-40996500-3301-11ea-92a2-942ade6dd092.png)


## 测试代码

```java
package com.github.houbb.ocr;

import net.sourceforge.tess4j.ITesseract;
import net.sourceforge.tess4j.Tesseract;
import net.sourceforge.tess4j.TesseractException;

import java.io.File;

/**
 * @author binbin.hou
 * @since 1.0.0
 */
public class Main {

    public static void main(String[] args) throws TesseractException {
        ITesseract instance = new Tesseract();

        // 指定识别图片
        File imgDir = new File("D:\\code\\ocr\\src\\main\\resources\\hello.png");
        long startTime = System.currentTimeMillis();
        String ocrResult = instance.doOCR(imgDir);

        // 输出识别结果
        System.out.println("OCR Result: \n" + ocrResult + "\n 耗时：" + (System.currentTimeMillis() - startTime) + "ms");
    }

}
```

### 运行报错

```
Exception in thread "main" java.lang.Error: Invalid memory access
	at com.sun.jna.Native.invokePointer(Native Method)
	at com.sun.jna.Function.invokePointer(Function.java:470)
	at com.sun.jna.Function.invoke(Function.java:404)
	at com.sun.jna.Function.invoke(Function.java:315)
	at com.sun.jna.Library$Handler.invoke(Library.java:212)
	at com.sun.proxy.$Proxy0.TessBaseAPIGetUTF8Text(Unknown Source)
	at net.sourceforge.tess4j.Tesseract.getOCRText(Tesseract.java:437)
	at net.sourceforge.tess4j.Tesseract.doOCR(Tesseract.java:292)
	at net.sourceforge.tess4j.Tesseract.doOCR(Tesseract.java:213)
	at net.sourceforge.tess4j.Tesseract.doOCR(Tesseract.java:197)
	at com.github.houbb.ocr.Main.main(Main.java:21)
Error opening data file ./tessdata/eng.traineddata
Please make sure the TESSDATA_PREFIX environment variable is set to the parent directory of your "tessdata" directory.
Failed loading language 'eng'
Tesseract couldn't load any languages!
```

这里应该是 TESSDATA_PREFIX 的环境变量没有配置导致的，我们调整下代码：

### 解决方案

简单就是说把tessdata拷贝到exe的所在目录，或者设置 TESSDATA_PREFIX 环境变量

我们选择设置环境变量：

- 设置

以 root 用户启动 cmd 命令行，永久设置环境变量

```
$ setx /m TESSDATA_PREFIX "C:\Program Files\Tesseract-OCR"
```

- 立刻生效

重启电脑是一种方案。

我们介绍另外一种。

修改完成后，进入DOS命令提示符，输入：`set TESSDATA_PREFIX=C:` ，关闭DOS窗口。

再次打开DOS窗口，输入：`echo %TESSDATA_PREFIX%`，可以发现“我的电脑”->“属性”->“高级”->“环境变量”中设置的 TESSDATA_PREFIX 值已经生效。

不用担心DOS窗口中的修改会影响环境变量的值，DOS窗口中的环境变量只是Windows环境变量的一个副本而已。

但是对副本的修改却会引发Windows环境变量的刷新，这正是我们想要的!

诡异啊，使用win+R->cmd 启动的cmd.exe 会发现在电脑属性中设置的环境变量立马生效了，在其他模式下启动的cmd却没有发生效果，怪哉！！查看了一下资料，在电脑属性中设置环境变量以后，以后启动的程序和线程会生效，而对以前驻留内存的程序不起作用，也有人说kill explorer.exe 再启动explorer.exe 可以激发设置其作用。

这里要理解的是，一个程序启动时，环境变量被复制到该程序所在的环境中，在该程序执行过程中不会被除该程序以外的其他程序所改变。也就是说，假设我们启动了一个cmd程序，然后通过控制面板修改了环境变量设置，但是已经启动了的cmd所拥有的环境变量并不会被改变。如果我们在修改环境变量之后启动cmd程序，则该程序将拥有新的环境变量。

那么结论就很明显了：修改环境变量之后，如果受影响的是应用程序，那么只要简单地重新启动此应用程序，环境变量的修改就会反映到该程序中，而不必重新启动计算机；但是，如果受影响的是系统服务，就必须重新启动才能将环境变量的修改反映到系统服务中（因为没有办法在不重启计算机的情况下重新启动系统服务管理器）。

-  查看 TESSDATA_PREFIX

```
λ echo %TESSDATA_PREFIX%
C:\Program Files\Tesseract-OCR
```




# 参考资料

[Java 实现OCR 识别图像文字(手写中文)----tess4j](https://blog.csdn.net/weixin_37794901/article/details/83343092)

[Java OCR 图像智能字符识别技术[可识别中文]](https://blog.csdn.net/aosica321/article/details/52222709)


## 环境配置

[Windows下通过CMD脚本更改环境变量并马上生效](https://blog.csdn.net/u013704227/article/details/52130156)

[windows系统cmd命令行设置、查看、更改环境变量](https://www.cnblogs.com/We612/p/11331401.html)

[Windows下setx命令](https://www.cnblogs.com/tomsheep/archive/2010/04/25/1720361.html)

* any list
{:toc}