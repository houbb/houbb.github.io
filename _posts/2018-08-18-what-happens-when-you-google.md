---
layout: post
title:  What happens when you google
date:  2018-08-18 14:00:31 +0800
categories: [Other]
tags: [other, sh]
published: true
---

# 当你 google 时，发生了什么？

[what-happens-when](https://github.com/alex/what-happens-when)

> [中文解释](https://github.com/skyline75489/what-happens-when-zh_CN)

## 协议

[publicdomain](https://creativecommons.org/publicdomain/zero/1.0/)

# 按下"g"键

接下来的内容介绍了物理键盘和系统中断的工作原理，但是有一部分内容却没有涉及。

当你按下“g”键，浏览器接收到这个消息之后，会触发自动完成机制。浏览器根据自己的算法，以及你是否处于隐私浏览模式，会在浏览器的地址框下方给出输入建议。

大部分算法会优先考虑根据你的搜索历史和书签等内容给出建议。

你打算输入 "google.com"，因此给出的建议并不匹配。

但是输入过程中仍然有大量的代码在后台运行，你的每一次按键都会使得给出的建议更加准确。

甚至有可能在你输入之前，浏览器就将 "google.com" 建议给你。

# 回车键按下

为了从零开始，我们选择键盘上的回车键被按到最低处作为起点。

在这个时刻，一个专用于回车键的电流回路被直接地或者通过电容器间接地闭合了，使得少量的电流进入了键盘的逻辑电路系统。

这个系统会扫描每个键的状态，对于按键开关的电位弹跳变化进行噪音消除(debounce)，并将其转化为键盘码值。

在这里，回车的码值是13。键盘控制器在得到码值之后，将其编码，用于之后的传输。

现在这个传输过程几乎都是通过通用串行总线(USB)或者蓝牙(Bluetooth)来进行的，以前是通过PS/2或者ADB连接进行。

## USB键盘：

键盘的USB元件通过计算机上的USB接口与USB控制器相连接，USB接口中的第一号针为它提供了5V的电压

键码值存储在键盘内部电路一个叫做"endpoint"的寄存器内

USB控制器大概每隔10ms便查询一次"endpoint"以得到存储的键码值数据，这个最短时间间隔由键盘提供

键值码值通过USB串行接口引擎被转换成一个或者多个遵循低层USB协议的USB数据包

这些数据包通过D+针或者D-针(中间的两个针)，以最高1.5Mb/s的速度从键盘传输至计算机。速度限制是因为人机交互设备总是被声明成"低速设备"（USB 2.0 compliance）

这个串行信号在计算机的USB控制器处被解码，然后被人机交互设备通用键盘驱动进行进一步解释。之后按键的码值被传输到操作系统的硬件抽象层

## 虚拟键盘（触屏设备）：

在现代电容屏上，当用户把手指放在屏幕上时，一小部分电流从传导层的静电域经过手指传导，形成了一个回路，使得屏幕上触控的那一点电压下降，屏幕控制器产生一个中断，报告这次“点击”的坐标

然后移动操作系统通知当前活跃的应用，有一个点击事件发生在它的某个GUI部件上了，现在这个部件是虚拟键盘的按钮

虚拟键盘引发一个软中断，返回给OS一个“按键按下”消息

这个消息又返回来向当前活跃的应用通知一个“按键按下”事件

# 产生中断[非USB键盘]

键盘在它的中断请求线(IRQ)上发送信号，信号会被中断控制器映射到一个中断向量，实际上就是一个整型数。

CPU使用中断描述符表(IDT)把中断向量映射到对应函数，这些函数被称为中断处理器，它们由操作系统内核提供。

当一个中断到达时，CPU根据IDT和中断向量索引到对应的中断处理器，然后操作系统内核出场了。










* any list
{:toc}
