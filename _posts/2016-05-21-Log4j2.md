---
layout: post
title: Log4j2
date:  2016-5-21 10:00:13 +0800
categories: [Java]
tags: [log]
published: true
---
* any list
{:toc}

# slf4j

The Simple Logging Facade for Java (SLF4J) serves as a simple facade or abstraction for various logging frameworks
(e.g. java.util.logging, logback, log4j) allowing the end user to plug in the desired logging framework at deployment time.


> [slf4j](http://www.slf4j.org/)


# log4j2

Apache Log4j 2 is an upgrade to Log4j that provides significant improvements over its predecessor, Log4j 1.x,
and provides many of the improvements available in Logback while fixing some inherent problems in Logback's architecture.

> [log4j2](http://logging.apache.org/log4j/2.x)

Just use **log4j2** instead of log4j and logback, reasons as following.

- Both Log4j 1.x and Logback will lose events while reconfiguring. Log4j 2 will not.

- In multi-threaded scenarios Asynchronous Loggers have 10 times higher throughput and
orders of magnitude lower latency than Log4j 1.x and Logback.

- Log4j 1.x has known deadlock issues. Many of these are fixed in Logback but
many Logback classes still require synchronization at a fairly high level.

- [others](http://logging.apache.org/log4j/2.x/manual/index.html)...

## Hello world

- pom.xml

```xml
<dependencies>
  <dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-api</artifactId>
    <version>2.6.1</version>
  </dependency>
  <dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-core</artifactId>
    <version>2.6.1</version>
  </dependency>
</dependencies>
```

- App.java

```java
public class App {
    static final Logger logger = LogManager.getLogger(App.class);

    public static void main(String[] args) {
        logger.trace("Entering application.");
        Bar bar = new Bar();
        if (!bar.doIt()) {
            logger.error("Didn't do it.");
        }
        logger.trace("Exiting application.");
    }
}
```

- Bar.java

```java
public class Bar {
    static final Logger logger = LogManager.getLogger(Bar.class.getName());

    public boolean doIt() {
        logger.entry();
        logger.error("Did it again!");
        return logger.exit(false);
    }
}
```

- result

```
ERROR StatusLogger No log4j2 configuration file found. Using default configuration: logging only errors to the console.
11:11:34.539 [main] ERROR com.ryo.logger.Bar - Did it again!
11:11:34.540 [main] ERROR com.ryo.logger.App - Didn't do it.

Process finished with exit code 0
```

- add log4j2.xml as following into classpath

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
    <Appenders>
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
        </Console>
    </Appenders>
    <Loggers>
        <Root level="trace">
            <AppenderRef ref="Console"/>
        </Root>
    </Loggers>
</Configuration>
```

- and the result is:

```
11:22:58.433 [main] TRACE com.ryo.logger.App - Entering application.
11:22:58.437 [main] TRACE com.ryo.logger.Bar - entry
11:22:58.438 [main] ERROR com.ryo.logger.Bar - Did it again!
11:22:58.438 [main] TRACE com.ryo.logger.Bar - exit with(false)
11:22:58.438 [main] ERROR com.ryo.logger.App - Didn't do it.
11:22:58.438 [main] TRACE com.ryo.logger.App - Exiting application.

Process finished with exit code 0
```

## Additivity

Perhaps it is desired to eliminate all the TRACE output from everything except `com.ryo.logger.Bar`,
the solution is to add a new logger definition to the configuration

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
  <Appenders>
    <Console name="Console" target="SYSTEM_OUT">
      <PatternLayout pattern="%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
    </Console>
  </Appenders>
  <Loggers>
    <Logger name="com.ryo.logger.Bar" level="trace">
      <AppenderRef ref="Console"/>
    </Logger>
    <Root level="error">
      <AppenderRef ref="Console"/>
    </Root>
  </Loggers>
</Configuration>
```

- result

```
12:11:43.095 [main] TRACE com.ryo.logger.Bar - entry
12:11:43.095 [main] TRACE com.ryo.logger.Bar - entry
12:11:43.096 [main] ERROR com.ryo.logger.Bar - Did it again!
12:11:43.096 [main] ERROR com.ryo.logger.Bar - Did it again!
12:11:43.096 [main] TRACE com.ryo.logger.Bar - exit with(false)
12:11:43.096 [main] TRACE com.ryo.logger.Bar - exit with(false)
12:11:43.096 [main] ERROR com.ryo.logger.App - Didn't do it.

Process finished with exit code 0
```

Notice that the trace messages from  'com.ryo.logger.Bar' appear twice.

change

```xml
<Logger name="com.ryo.logger.Bar" level="trace">
  <AppenderRef ref="Console"/>
</Logger>
```
into

```xml
<Logger name="com.ryo.logger.Bar" level="trace" additivity="false">
  <AppenderRef ref="Console"/>
</Logger>
```

and result will be

```
12:16:34.921 [main] TRACE com.ryo.logger.Bar - entry
12:16:34.923 [main] ERROR com.ryo.logger.Bar - Did it again!
12:16:34.923 [main] TRACE com.ryo.logger.Bar - exit with(false)
12:16:34.923 [main] ERROR com.ryo.logger.App - Didn't do it.

Process finished with exit code 0
```

Once an event reaches a logger with its additivity set to false the event will not be passed to any of its parent loggers,
regardless of their additivity setting.


## Use with junit

```java
import junit.framework.TestCase;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;


public class BaseTest extends TestCase {
    protected static final Logger logger = LogManager.getLogger(BaseTest.class);
}
```

