---
layout: post
title: 分布式链路追踪-03-分布式系统跟踪工具，如何设计 span? 
date:  2023-07-25 08:00:00 +0800
categories: [Trace]
tags: [trace, distributed, sh]
published: true
---

# 开源项目

> 自动日志输出 [https://github.com/houbb/auto-log](https://github.com/houbb/auto-log)

# 分布式系统跟踪工具，如何设计 span

在分布式系统跟踪工具中，"Span" 是一个核心概念，它代表着一个跟踪单元或操作的一部分。

Span 是分布式系统中的一个时间跨度，用于表示一个请求或操作在分布式系统中的起始点和结束点。

设计 Span 的关键是捕获有关操作的重要信息，以便对系统的性能和行为进行分析。

下面是设计 Span 时需要考虑的几个关键点：

1. 起始点和结束点：Span 需要记录操作的起始时间和结束时间，这样就可以计算出操作的持续时间。这将帮助您识别性能瓶颈和潜在的延迟问题。

2. Span ID 和 Trace ID：每个 Span 都应该有一个唯一的标识符（Span ID），用于在分布式系统中跟踪操作的传播路径。而 Trace ID 则用于关联相关的 Span，形成完整的操作跟踪链。

3. 父子关系：如果一个操作触发了另一个操作，那么这两个操作之间会存在父子关系。在 Span 中记录父子关系，可以帮助您构建完整的操作依赖关系图。

4. 标签（Tags）和日志（Logs）：除了基本的时间和标识信息，您还可以通过添加标签和日志来丰富 Span 的数据。标签是键值对，用于描述 Span 的一些特性，如操作类型、状态、处理结果等。而日志可以记录操作的详细信息，帮助您更好地理解操作的执行过程。

5. 上下文传递：在分布式系统中，操作可能会经过多个服务或节点。因此，Span 需要能够在不同的服务或节点之间传递，并保持上下文的连续性。这样，您就可以在整个分布式系统中跟踪操作的路径和执行情况。

6. 采样率：在大规模的分布式系统中，生成的 Span 数据可能非常庞大。为了降低数据量和开销，可以考虑采样率设置，只记录部分操作的 Span 数据，而非全部操作。

7. 性能开销：设计 Span 数据的收集和传递方式时，需要考虑对系统性能的影响。确保跟踪工具的设计不会引入额外的性能开销，从而影响实际系统的性能。

# spanId 要如何生成，能够保证唯一性和顺序性？

在分布式系统跟踪中，确保 Span ID 的唯一性和顺序性是非常重要的，以便正确地追踪和关联不同操作之间的关系。

通常，可以通过以下方式生成唯一且有序的 Span ID：

1. 全局唯一标识符（UUID）：使用UUID可以生成全局唯一的标识符，确保在整个分布式系统中不会出现冲突。UUID是128位的数字，具有足够的长度来保证唯一性，可以使用随机算法生成。一般情况下，现代编程语言和框架都提供了生成UUID的函数或库。

2. Snowflake算法：Snowflake算法是Twitter开源的一种ID生成算法，用于生成全局唯一的64位ID。它的结构通常包含一个时间戳、机器ID和序列号，可以保证在不同机器和不同时间生成的ID都是唯一的。

3. 数据库自增ID：如果您的分布式系统使用了集中式数据库，可以使用数据库自增ID来生成 Span ID。数据库自增ID的特性保证了每次生成的ID都是唯一且递增的。

4. 分布式序列号生成器：使用分布式序列号生成器，比如ZooKeeper或etcd等分布式协调服务，可以确保在不同节点上生成唯一且有序的Span ID。

无论使用哪种方法，生成 Span ID 时都要确保在分布式系统中的唯一性。

# 这里只是保证唯一性，如何保证顺序性呢？

对于分布式系统中的 Span ID，保证顺序性是一个更复杂的问题，因为分布式系统的性质使得完全保证全局顺序是困难的。

在分布式环境下，多个节点可能同时生成 Span，并且它们之间的时钟可能存在微小的差异，导致无法完全按照生成顺序进行排序。

然而，尽管完全保证全局顺序是不可行的，但可以采取一些方法来在局部范围内近似保证顺序性，或者在特定场景下实现较好的顺序性。

一种常见的方法是在生成 Span ID 时结合时间戳信息。

例如，可以将时间戳信息作为 Span ID 的一部分，以此确保在同一节点上生成的 Span ID 是有序的。

这样，虽然无法完全保证全局顺序，但至少在同一节点上的 Span ID 是按照时间顺序递增的。

另一种方法是使用分布式的序列号生成器，比如 ZooKeeper 或 etcd 等分布式协调服务。

这些服务可以生成全局唯一且有序的序列号，可以用作 Span ID。通过使用这样的分布式序列号生成器，可以在全局范围内实现较好的顺序性。

需要注意的是，保证顺序性往往会引入更多的复杂性和开销，而在分布式系统中，一般更关注全局唯一性和跟踪数据的完整性。在实际应用中，如果确实需要某种程度的顺序性，可以考虑上述方法。

但是，对于一些特定场景和应用，可能需要更复杂的协调和排序机制来实现更严格的顺序性保证。


# 如何让你设计 spanId，你如何设计？保证获取到层级关系和执行顺序？

1. 基本结构：Span ID 应该是一个足够长的唯一标识符，确保在分布式系统中每个 Span 的 ID 都是唯一的。通常采用UUID（128位）或Snowflake算法（64位）等方式来生成唯一的 Span ID。

2. Trace ID：在设计 Span ID 时，考虑引入 Trace ID 的概念。Trace ID 是用于唯一标识一个跟踪操作链的标识符。每个跟踪链都有一个 Trace ID，并且跟踪链中的所有 Span 都共享同一个 Trace ID。这样，可以在不同的 Span 之间建立层级关系，形成完整的操作依赖关系图。

3. 父子关系：在 Span 数据中记录父 Span 的 ID，以建立 Span 之间的父子关系。通过这种方式，可以明确不同 Span 之间的调用链关系，帮助构建层级关系。

4. 时间戳：考虑在 Span ID 中加入时间戳信息，以引入一定程度的顺序性。这样，在同一节点上生成的 Span ID 将在时间上有一定的递增顺序，有助于还原操作的执行顺序。

5. 分布式序列号生成器：使用分布式序列号生成器（如ZooKeeper、etcd等）来生成 Span ID，确保在不同节点上生成的 Span ID 是唯一且有序的。

6. 全局唯一性：确保生成的 Span ID 具有全局唯一性，避免冲突和数据混淆。这可以通过UUID或Snowflake算法等方式来实现。

7. 考虑性能：在设计 Span ID 时，需要考虑对系统性能的影响。确保生成 Span ID 的方式在性能方面是高效的，不会成为系统的性能瓶颈。

综合考虑上述要素，可以设计一个 Span ID 生成策略，以满足获取层级关系和执行顺序的需求。

# 小结

希望本文对你有所帮助，如果喜欢，欢迎点赞收藏转发一波。

我是老马，期待与你的下次相遇。

# 参考资料

https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36356.pdf

https://research.google/pubs/pub36356/

* any list
{:toc}