---
layout: post
title: 多版本并发控制（MVCC） 是一种用于分布式数据库和存储系统中的一致性协议，旨在控制并发事务对数据的访问
date:  2021-3-06 16:52:15 +0800
categories: [Distributed]
tags: [distributed, algorithm, java, sh]
published: true
---

# chat

## 是什么？

### 多版本并发控制（MVCC）详解

多版本并发控制（MVCC，Multi-Version Concurrency Control） 是一种用于处理数据库中并发访问的技术，它允许多个事务同时读写数据，同时避免数据冲突和锁争用。MVCC 通过为每个数据项维持多个版本，使得事务可以在不锁定数据的情况下并发执行，从而提高了数据库系统的性能和可扩展性。

MVCC 被广泛应用于关系型数据库（如 PostgreSQL、MySQL InnoDB）和 NoSQL 数据库（如 Cassandra、HBase）中。它特别适合支持高并发读写操作的场景，特别是在需要支持高吞吐量和低延迟的应用中。

### MVCC 的基本原理

MVCC 的核心思想是在数据库中为每一项数据（通常是行）创建多个版本，每个版本记录的数据都是在特定时间点下的“快照”，事务读取和写入的数据会访问不同的版本。通过这种方式，数据库能够支持多个事务并发执行，并且避免了传统的锁定机制。

具体来说，MVCC 在以下几个方面进行优化：

1. 数据版本化：
   - 每次对数据进行修改时，不会直接覆盖旧数据，而是创建一个新的版本。这些版本包含数据的不同快照，事务可以访问自己需要的版本而不会影响其他事务。
   
2. 事务视图（Transaction Views）：
   - 每个事务都会有一个视图，表示该事务可以看到的数据库状态。事务可以读取到在其开始之前提交的所有数据版本，但不能看到正在被其他事务修改的数据版本。
   
3. 时间戳管理：
   - 每个事务在开始时会获得一个时间戳或事务ID，这个时间戳决定了该事务在数据库中的视图，以及它可以读取哪些版本的数据。MVCC 通过时间戳或事务ID来标识数据版本的创建时间。
   
4. 提交和回滚机制：
   - 当事务提交时，新的数据版本被永久保存。若事务回滚，所创建的版本会被丢弃，不会对数据库的最终状态产生影响。

### MVCC 的工作流程

#### 1. 写操作的处理

- 创建新版本：当一个事务需要更新数据库中的数据时，不会直接覆盖旧的数据项，而是创建一个新的版本，这个版本包含了当前事务对数据的修改。
  
- 版本管理：新版本会有一个时间戳或事务ID标识，指示其创建的时间。每个数据项（如行或字段）会有一个版本链，记录着每个修改版本及其事务ID。

- 标记删除：如果事务删除了某个数据项，它并不会立即将数据从数据库中移除，而是通过一个特殊的“删除标记”来标记这个版本，表示该数据项已被删除，但仍保留在数据库中。

#### 2. 读操作的处理

- 读取可见版本：当一个事务读取数据时，它并不读取数据库中最新的版本，而是读取所有“可见”的版本。可见版本是指该事务视图下已经提交的数据。换句话说，事务只能看到在其开始之前已经提交的版本，无法看到其他事务还未提交的修改。

- 读取旧版本：例如，在两个事务并发执行时，如果一个事务更新了某一数据项，而另一个事务正在读取该数据项，则读取事务会看到更新前的版本（如果更新事务未提交）。这样，通过多个版本的维护，事务之间就不会互相阻塞。

#### 3. 事务提交和回滚

- 提交：当一个事务提交时，所有它所创建的新版本将成为“可见”，并且其他事务可以访问这些版本。这些版本会被永久保存，并在日志中记录以便持久化。

- 回滚：如果事务回滚，那么所有它所创建的新版本都会被丢弃，数据库状态恢复到回滚前的状态。

#### 4. 版本清理

- 垃圾回收：随着数据库中版本的增多，旧版本会占用大量空间，因此需要一个垃圾回收机制来定期清理不再需要的版本。通常，当所有持有某个版本的事务完成时（即该版本不再可见），可以安全地删除它。

### MVCC 的关键组成部分

1. 事务ID/时间戳：
   - 每个事务在开始时会获得一个唯一的事务ID或时间戳。事务ID 标识了事务的开始顺序，而时间戳则在数据库中对每个版本进行标记。事务ID/时间戳是 MVCC 的核心组件，用来确定事务可见的版本。

2. 版本链：
   - 每个数据项（行或字段）都有一个版本链，版本链包含所有修改该数据项的版本及其对应的事务ID。每个事务的修改会创建一个新的版本，并添加到版本链上。

3. 可见性规则：
   - 每个事务只能看到在其事务ID之前提交的版本。这是 MVCC 最重要的特性之一，确保了并发读写操作不会导致冲突。

4. 撤销日志（Undo Log）：
   - MVCC 中每个事务都会有一个撤销日志，用于记录事务的修改操作。如果事务回滚，可以通过撤销日志恢复数据。

5. 提交日志（Commit Log）：
   - 记录每个事务的提交信息，帮助数据库恢复事务状态。它确保了事务的持久化，并在系统崩溃后能够恢复数据库状态。

### MVCC 的优缺点

#### 优点

1. 提高并发性：
   - MVCC 允许多个事务并发执行，读操作无需等待写操作的锁定，从而大大提高了系统的吞吐量和并发性。
   
2. 避免死锁：
   - 由于读操作不会阻塞写操作，写操作也不会阻塞读操作，MVCC 可以避免传统锁机制中可能出现的死锁问题。

3. 无锁读取：
   - 事务可以执行无锁的读取操作，即使其他事务正在修改数据。这使得读操作非常高效，特别是在高并发的场景下。

4. 更好的响应时间：
   - 由于数据库操作不需要等待锁释放，读操作的响应时间通常较低，系统可以更快地响应用户请求。

5. 历史数据的访问：
   - 由于数据库保留了不同版本的数据，MVCC 使得数据库可以支持事务的“快照隔离”，并且可以访问历史数据。

#### 缺点

1. 存储开销：
   - 由于 MVCC 保留了多个数据版本，需要额外的存储空间来保存所有版本和事务信息。这可能会增加存储需求，尤其是在数据更新频繁的情况下。

2. 版本清理复杂性：
   - 随着数据库版本的不断增加，旧版本需要定期清理，否则会消耗大量存储空间。版本清理过程可能带来额外的系统负担，特别是在高并发的场景下。

3. 复杂的事务管理：
   - MVCC 的实现需要管理大量的版本信息和事务ID，增加了数据库管理的复杂性。尤其是在高并发环境下，如何正确管理和清理版本会是一个挑战。

4. 性能问题：
   - 如果数据库系统未能有效地管理版本清理或压缩操作，可能会出现性能问题。特别是当存储中积累了大量无效的历史版本时，读写性能可能会下降。

### MVCC 的应用场景

1. 高并发读写系统：
   - MVCC 非常适合需要支持高并发读写操作的系统，如 Web 应用、社交平台、电商平台 等，尤其是这些平台需要处理大量并发查询和修改操作。

2. 需要事务隔离的数据库：
   - MVCC 是实现 事务隔离（尤其是 可重复读 和 读已提交 隔离级别）的理想选择。通过保留每个事务的视图，确保事务之间的干扰最小化。

3. 分布式数据库：
   - 在 分布式数据库 中，MVCC 可以通过多个副本或节点保存不同版本的数据，使得系统能够容忍部分节点故障，同时确保数据一致性和可用性。

4. OLTP 系统：
   - 在线事务处理（OLTP） 系统通常需要频繁的并发读取和写入数据。MVCC 提供的高并发性和无锁读取，适合 OLTP 场景。

### 总结

MVCC 是一种非常强大和高效的并发控制机制，它通过维护数据的多个版本，使得系统能够实现高并发和低延迟的操作。MVCC 避免了传统锁机制中的性能瓶颈，提供了无锁的读取和写入操作，但也面临存

储开销和版本管理的挑战。它在需要高吞吐量、事务隔离和高并发读写的场景中表现出色，是许多现代数据库系统的核心技术之一。

# 参考资料

* any list
{:toc}