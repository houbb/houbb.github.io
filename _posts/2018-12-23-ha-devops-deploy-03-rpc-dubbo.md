---
layout: post
title: 高可用之应用发布？03-RPC dubbo 如何优雅上下线？
date: 2018-12-23 13:55:13 +0800
categories: [Distributed]
tags: [distributed, ha, limit, sh]
published: true
---

# chat

## dubbo 如何实现服务的动态上下线？

在 Apache Dubbo 中实现服务的动态上下线，可以通过以下几种方式：

1. **使用动态配置中心**：Dubbo 支持与动态配置中心（如 Nacos、Apollo 等）集成，通过配置中心可以动态地调整服务的配置信息，如权重、负载均衡策略等，实现服务的动态上下线。配置中心会在配置变更时实时通知注册中心和订阅者，从而实现服务的动态调整。

例如，在 Nacos 中，可以通过修改服务实例的健康状态来实现动态上下线 。

2. **使用 Dubbo Admin 管理控制台**：Dubbo Admin 提供了服务治理的功能，包括服务的上下线操作。通过 Dubbo Admin，可以对服务进行查询、测试以及治理，包括动态地对服务进行上下线处理 。

3. **使用 QoS 进行动态控制**：Dubbo 的 QoS 功能允许通过 Telnet 或 HTTP 协议对服务进行动态查询和控制，包括服务的上下线操作。例如，可以使用 `online` 和 `offline` 命令来动态地将服务注册到注册中心或从注册中心摘除 。

4. **使用 Nacos Open API**：如果需要对多个服务实例进行批量上下线操作，可以利用 Nacos 提供的 Open API 来实现。通过编写脚本或程序调用 Nacos 的服务管理接口，可以实现对指定服务实例的上下线操作 。

5. **使用权重调整和动态路由**：通过调整服务提供者的权重，可以控制流量的分配，实现服务的平滑上下线。同时，Dubbo 的动态路由功能允许通过配置路由规则来指定流量的处理方式，从而实现服务的动态上下线 。

6. **使用标签路由**：在 Dubbo 2.7 版本中引入了标签路由功能，允许给不同的服务实例打上不同的标签，并在调用时通过设置不同的标签名称来选择服务实例，从而实现流量隔离和灰度发布 。

7. **使用应用级别的服务治理**：在 Dubbo 2.7 版本中，支持应用级别的服务治理，可以对整个应用的服务进行统一的配置和管理，包括条件路由、动态配置等 。

通过上述方法，Dubbo 可以实现服务的动态上下线，保证服务在上线和下线过程中的流量无损，提高服务的可用性和稳定性。

## 详细介绍下 dubbo 使用 QoS 进行动态控制上下线

在 Apache Dubbo 中，QoS（Quality of Service）功能允许用户通过 Telnet 或 HTTP 协议动态地对服务进行查询和控制，包括服务的动态上下线。以下是如何使用 QoS 进行动态控制服务上下线的具体步骤和示例：

### QoS 工作机制
从 Dubbo 2.5.8 版本开始，默认引入了 QoS 功能，默认处于启动状态。QoS 功能基于 Netty4 实现，可以通过执行命令来动态控制服务。QoS 启动后，会监听一个端口（默认是 22222），识别目标请求的协议（HTTP 或 Telnet），并根据协议解析出需要执行的命令，然后执行命令并返回结果。

### QoS 支持的命令
- `help`：帮助命令，列出所有可用的命令。
- `ls`：列出当前所有正在提供的服务以及消费的服务。
- `online`：动态将某个或全部服务向注册中心进行注册。
- `offline`：动态将某个或全部服务从注册中心摘除（反注册）。
- `quit`：退出当前 Telnet 会话。

### 通过 Telnet 方式访问 QoS
1. 启动 Dubbo 服务端后，通过 Telnet 连接到 QoS 端口：
   ```
   $ telnet localhost 22222
   ```
   连接成功后，会出现 `dubbo>` 提示符。

2. 输入 `help` 命令列出所有可用命令：
   ```
   dubbo> help
   ```

3. 使用 `ls` 命令查看当前服务状态：
   ```
   dubbo> ls
   ```
   可以看到服务列表，其中 `PUB=Y` 表示服务已发布到注册中心，`PUB=N` 表示服务未发布。

4. 使用 `offline` 命令动态下线服务：
   ```
   dubbo> offline org.apache.dubbo.demo.provider.DemoService
   ```
   命令返回 `OK` 后，服务即从注册中心摘除。

5. 使用 `online` 命令动态上线服务：
   ```
   dubbo> online org.apache.dubbo.demo.provider.DemoService
   ```
   命令返回 `OK` 后，服务即向注册中心注册。

6. 使用 `quit` 命令退出 Telnet 会话：
   ```
   dubbo> quit
   ```
   

### 通过 HTTP 方式访问 QoS
也可以通过 HTTP 请求来执行 QoS 命令，例如使用 curl 工具：
```
$ curl -i http://localhost:22222/online?service=org.apache.dubbo.demo.provider.DemoService
```
这将动态地将指定的服务注册到注册中心。

### QoS 相关参数说明
QoS 提供了一些启动参数来配置其行为：
- `qosEnable`：是否启动 QoS，默认为 `true`。
- `qosPort`：启动 QoS 绑定的端口，默认为 `22222`。
- `qosAcceptForeignIp`：是否允许远程访问，默认为 `false`。从 2.6.4/2.7.0 开始，默认配置改为 `false`，如果设置为 `true`，可能带来安全风险，请仔细评估后再打开。

这些参数可以通过系统属性、`dubbo.properties` 文件、XML 配置或 Spring Boot 自动装配方式进行配置。

通过上述方法，你可以使用 Dubbo 的 QoS 功能来实现服务的动态上下线，从而在不停服的情况下进行服务的维护和更新。

## Dubbo QoS 功能在实际应用中有哪些优势和局限性？

Dubbo 的 QoS 功能在实际应用中提供了一些显著的优势，但同时也存在一些局限性：

### 优势：

1. **动态服务上下线**：QoS 允许通过简单的命令动态地将服务注册到或从注册中心注销，这意味着可以快速响应服务状态的变化，而不需要重启服务或更改配置文件。

2. **实时监控**：通过 `ls` 命令，可以实时查看服务提供者和消费者的状态，包括服务是否已发布到注册中心。

3. **简化运维操作**：QoS 提供的命令行界面简化了运维操作，使得服务的上线和下线变得更加快捷和方便。

4. **支持远程操作**：通过配置，QoS 允许远程访问，这意味着可以在不同的环境中对服务进行操作，增强了灵活性。

5. **安全性**：Dubbo QoS 提供了权限级别设置，可以限制匿名访问的权限，增加了操作的安全性。

6. **多种访问方式**：QoS 支持 HTTP 和 Telnet 协议，方便不同情况下的使用。

### 局限性：

1. **安全性风险**：默认情况下，QoS 允许任何主机发起命令，如果配置不当，可能会带来安全风险。从 2.6.4/2.7.0 开始，`qos-accept-foreign-ip` 默认配置改为 `false`，如果设置为 `true`，需要仔细评估安全风险。

2. **配置复杂性**：虽然 QoS 提供了灵活的配置选项，但这也意味着需要正确理解和配置这些参数，对于不熟悉 Dubbo 的用户来说可能会有一定的学习曲线。

3. **依赖特定版本**：QoS 功能依赖于 Dubbo 的特定版本，对于使用旧版本的用户来说，可能需要升级才能使用 QoS 功能。

4. **可能影响性能**：虽然 QoS 通常不会对性能产生显著影响，但在高负载情况下，额外的命令处理可能会对服务性能产生一定影响。

5. **限制在命令范围内的操作**：QoS 提供的命令有限，只能执行预定义的一系列操作，对于需要更复杂运维操作的场景，可能需要其他工具或脚本来辅助。

总的来说，Dubbo 的 QoS 功能为服务的动态管理提供了便利，但在使用时需要注意安全性和配置的正确性。

## 在使用 Dubbo QoS 时，有哪些最佳实践可以避免常见的问题和风险？

在使用 Dubbo QoS 功能时，以下是一些最佳实践，以避免常见的问题和风险：

1. **限制远程访问**：默认情况下，QoS 允许任何主机发起命令。为了安全起见，建议设置 `qos-accept-foreign-ip` 为 `false`，以拒绝远端主机发出的命令，只允许服务本机执行。如果需要远程访问，可以通过设置 `qos-accept-foreign-ip-whitelist` 来指定支持的远端主机 IP 地址（段）。

2. **配置合适的权限级别**：QoS 提供了匿名访问的能力以及对权限级别的设置。建议根据需要设置合适的权限级别，以控制匿名访问的命令权限。例如，可以通过设置 `qos-anonymous-access-permission-level` 为 `NONE` 来关闭匿名访问，或者设置为 `PROTECTED` 来允许匿名访问更高级别的权限命令。

3. **使用安全的端口**：QoS 默认监听 22222 端口。如果该端口被其他服务占用或出于安全考虑，可以通过配置文件 `dubbo.properties` 或 JVM 参数来修改端口号。

4. **监控和审计**：启用 QoS 功能时，应确保对通过 QoS 发起的操作进行监控和审计，以便跟踪可能的不当操作或安全事件。

5. **了解 QoS 命令**：熟悉 QoS 支持的命令，如 `help`、`ls`、`online`、`offline` 和 `quit`，并了解它们的用途和潜在影响。例如，`online` 和 `offline` 命令可以用于动态地控制服务的注册和注销。

6. **配置管理**：确保 QoS 配置的更改由授权人员进行，并且更改被适当记录和审计。

7. **服务上下线的最佳实践**：在执行服务上下线操作时，应确保遵循服务契约和版本管理的最佳实践，以避免不兼容的更改导致的服务中断。

8. **异常处理**：在服务上下线过程中，应适当处理可能发生的异常，确保服务的稳定性和可靠性。

9. **文档和培训**：为运维团队提供 QoS 功能的详细文档和培训，确保他们了解如何安全、有效地使用 QoS 功能。

通过遵循这些最佳实践，可以最大限度地减少使用 Dubbo QoS 功能时的风险，同时充分利用其动态控制服务的能力。

# 参考资料

* any list
{:toc}