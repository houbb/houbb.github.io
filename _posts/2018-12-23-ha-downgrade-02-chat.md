---
layout: post
title: 高可用之降级 downgrade-02-chat 聊一聊降级
date: 2018-12-23 13:55:13 +0800
categories: [Distributed]
tags: [distributed, ha, sh]
published: true
---

# chat

## 详细介绍一下服务降级

服务降级是分布式系统中的一种重要策略，旨在提高系统的可用性和容错能力。

它通常在系统出现故障或资源过载时启用，以确保系统在部分功能失效的情况下仍能继续提供服务。

### 服务降级的目的

1. **提高可用性**：通过部分功能的降级，系统可以避免完全崩溃，保证核心功能的可用性。
2. **用户体验优化**：即使在发生故障时，用户仍然能够访问某些功能，减少用户流失。
3. **资源保护**：在系统负载过高时，通过限制某些服务的使用，保护重要资源，避免进一步崩溃。

### 服务降级的策略

1. **功能降级**：
   - 关闭或简化某些非核心功能。例如，在电商网站中，当支付服务不可用时，允许用户浏览商品但不支持购买。

2. **API降级**：
   - 提供备用API接口，简化请求或减少返回数据量。例如，在获取用户信息时，只返回基本信息而非完整信息。

3. **缓存机制**：
   - 在服务出现故障时，使用缓存数据响应请求，确保用户可以获取到最近的有效数据。

4. **流量控制**：
   - 在高负载情况下，限制某些请求的数量，优先处理高优先级请求。

### 实现服务降级的工具

1. **熔断器（Circuit Breaker）**：
   - 用于监控服务调用的状态，及时切换到降级模式，防止系统过载。

2. **限流（Rate Limiting）**：
   - 控制单位时间内的请求数量，防止系统因请求过多而崩溃。

3. **服务监控**：
   - 实时监控系统健康状况，及时发现异常，触发降级措施。

### 总结

服务降级是提升系统可靠性的重要手段，通过合理设计和实现，可以有效减轻系统故障带来的影响，提高用户满意度。

在实际应用中，需要根据具体业务场景和用户需求，灵活选择降级策略。

## 服务降级和熔断的关系是什么？

服务降级和熔断是分布式系统中常用的两种应对故障的策略，它们既有联系也有区别。

它们的目标都是为了提高系统的稳定性和可用性，但侧重点不同。

### 服务降级与熔断的关系

1. **共同目标**：
   - **提高系统的容错能力**：两者都旨在防止系统因某些组件或服务的故障而导致整个系统不可用，从而提升系统的可靠性和用户体验。
   
2. **先后顺序**：
   - **熔断触发降级**：熔断通常是服务降级的前置机制。当熔断器检测到某个服务调用频繁失败或响应超时时，它会切断与该服务的调用（即“熔断”）。此时，系统可以自动进入降级模式，为用户提供一个替代的、简化的服务，确保系统核心功能仍能正常工作。

3. **相互补充**：
   - **熔断保护系统，服务降级保障体验**：熔断主要是从技术层面出发，保护系统不被错误或超时的服务拖垮。而服务降级更多的是从业务角度出发，确保用户在部分服务不可用时仍能获得某种形式的反馈或体验。例如，某个支付服务出现故障，熔断后系统可以通过服务降级展示一个“支付功能暂时不可用”的提示，而不是直接让整个系统宕机。

### 服务降级与熔断的区别

1. **触发条件不同**：
   - **熔断**：熔断的触发基于一定的规则，比如一段时间内的失败次数、错误率超过阈值、响应超时等。当条件满足时，熔断器会自动阻止请求发送到目标服务，防止继续调用可能导致系统资源枯竭。
   - **服务降级**：服务降级通常根据业务需求或系统负载情况手动或自动触发。例如，系统负载过高时，可以主动关闭非核心功能来减轻负担；或者某个服务被熔断后，系统自动降级为备用的低级服务模式。

2. **操作对象不同**：
   - **熔断**：熔断主要针对调用链上的服务间的依赖关系，保护下游服务不被频繁失败的上游服务影响。
   - **服务降级**：服务降级更多的是在业务层面，针对整个系统或应用的功能，限制某些非关键功能或提供简化版的服务。

3. **持续时间不同**：
   - **熔断**：熔断器在一段时间内阻止服务调用，等到系统恢复后可以进入“半开”状态，逐步恢复正常调用。
   - **服务降级**：服务降级可以是暂时性的，也可以是持续性的，取决于业务策略和故障恢复的情况。

### 总结

**熔断器是技术手段，用于防止系统过载和连锁故障，而服务降级是业务手段，保证用户在系统部分功能失效时依然有基本的服务可用。**两者结合使用能够提升系统的弹性和用户体验，在复杂分布式系统中尤为重要。

## 如何优雅的实现服务降级？最佳实践

实现服务降级时，优雅的设计不仅能确保系统的稳定性，还能提供良好的用户体验。

以下是一些最佳实践，帮助你在分布式系统中高效实现服务降级。

### 1. **识别核心与非核心服务**
   - **核心服务**：比如支付、订单提交等用户最关心的功能，必须尽可能保持可用性。
   - **非核心服务**：如推荐、评论、统计等，可以优先降级或临时关闭。

   **实践**：为每个服务分类，明确哪些功能在高负载或故障时可以降级，从而确保关键业务不受影响。

### 2. **熔断器集成**
   使用熔断器（如 Hystrix、Resilience4j）是实现服务降级的基础步骤之一。熔断器可以监控服务的调用状况，在调用失败率或超时率达到一定阈值时触发降级。

   **实践**：
   - 设置合理的熔断阈值（如请求失败次数、错误比例、超时时间等）。
   - 在熔断器开启后，执行降级逻辑，如提供默认响应或调用备用服务。

   示例（使用 Resilience4j 实现熔断与降级）：
   ```java
   @CircuitBreaker(name = "backendA", fallbackMethod = "fallback")
   public String backendA() {
       // 调用核心服务
   }

   public String fallback(Throwable throwable) {
       // 降级逻辑：返回默认值或调用备份服务
       return "服务暂时不可用，请稍后再试";
   }
   ```

### 3. **使用缓存作为降级方案**
   当下游服务不可用时，使用缓存中的数据作为降级处理，能够提供近似的用户体验。

   **实践**：
   - 在高并发或故障时，从缓存中返回上次成功的结果，避免用户感知到服务的不可用。
   - 使用缓存时要确保数据的时效性和一致性。

   示例（使用 Redis 缓存数据作为降级）：
   ```java
   public String getProductInfo(String productId) {
       try {
           // 正常调用外部服务
           return productService.getProduct(productId);
       } catch (Exception e) {
           // 从缓存中读取数据
           return redisCache.get("productInfo:" + productId);
       }
   }
   ```

### 4. **默认值降级**
   在某些情况下，当服务不可用时，可以返回合理的默认值或静态内容，以保障用户体验。

   **实践**：
   - 为关键服务设计合理的默认值，比如推荐服务不可用时，可以展示一组默认推荐商品。
   - 对非核心服务，降级时可以返回一些提示信息，告知用户当前服务不可用。

   示例（返回默认值降级）：
   ```java
   @CircuitBreaker(name = "recommendationService", fallbackMethod = "defaultRecommendations")
   public List<String> getRecommendations() {
       return recommendationService.get();
   }

   public List<String> defaultRecommendations(Throwable throwable) {
       // 返回默认推荐商品
       return Arrays.asList("默认商品1", "默认商品2");
   }
   ```

### 5. **定期评估降级策略**
   服务降级不是一次性设计，需要定期评估和调整，以适应业务需求和系统变化。

   **实践**：
   - 定期测试和评估服务降级策略，确保在不同场景下能够正常运行。
   - 监控各服务的性能表现和降级触发情况，分析是否需要优化降级阈值或逻辑。

### 6. **灰度降级**
   对于部分用户进行降级而非全部用户，可以实现更精细化的控制，确保在高负载情况下仍有部分用户能够享受全功能服务。

   **实践**：
   - 根据用户特性（如VIP用户、付费用户）进行灰度降级，只对普通用户或低优先级用户实施降级。
   - 通过流量控制器或A/B测试框架来实现灰度降级。

### 7. **良好的用户提示**
   服务降级时，不应让用户觉得服务完全不可用，优雅的降级应通过合理的提示信息来告知用户。

   **实践**：
   - 在UI层面提供简洁的提示信息，告知用户功能暂时不可用，避免直接展示错误页面。
   - 在合适的场景下提供备用方案，比如展示备用数据或允许用户稍后重试。

   示例：
   ```html
   <div class="alert alert-warning">
       推荐服务暂时不可用，您可以浏览热门商品。
   </div>
   ```

### 8. **自动恢复机制**
   降级是临时措施，系统恢复正常后应尽快切换回全功能模式。

   **实践**：
   - 使用熔断器的“半开”状态来逐步恢复服务调用，检测服务是否已恢复。
   - 在降级逻辑中实现自动恢复检测，一旦服务恢复，则解除降级模式。

### 9. **监控与告警**
   服务降级的实施离不开监控和告警系统的支持。需要通过监控及时发现系统中的故障并触发降级，同时对降级情况进行持续监控。

   **实践**：
   - 配置监控工具（如 Prometheus, Grafana）对各服务的响应时间、错误率、熔断触发率等进行监控。
   - 配置告警系统，当服务进入降级状态或熔断器触发时，及时通知相关运维人员。

### 总结

优雅的服务降级实现不仅仅是单纯地切换到备用方案，还包括了核心与非核心服务的合理划分、熔断器的集成、缓存和默认值的使用、用户体验的优化、自动恢复机制、以及强大的监控与告警支持。

通过以上最佳实践，能够确保系统在复杂的分布式环境中具备良好的弹性和韧性，从而保障用户在服务故障或高负载时仍能获得良好的体验。

# 参考资料

[降级](https://mp.weixin.qq.com/s/q2B1c0tzR3hNuY9mAcaUMw)

* any list
{:toc}