---
layout: post
title: dns-01-网络域名解析服务
date: 2018-11-22 8:01:55 +0800
categories: [Web]
tags: [web-server, dns, overview, sh]
published: true
---

# chat

## 在一个企业级的网络架构中，用户通过 https://域名/服务 请求到最终的服务器上，整体的网络流程什么样的? 详细列出来

在一个企业级的网络架构中，用户通过 HTTPS 请求访问服务的过程涉及多个步骤，包括 DNS 解析、SSL/TLS 加密、负载均衡、反向代理等。

以下是这个过程的详细步骤：

1. **DNS 解析**：
   - 用户在浏览器输入 `https://域名/服务`。
   - 浏览器首先查询 DNS 服务器，将域名解析为服务器的 IP 地址。

2. **建立 SSL/TLS 连接**：
   - 用户的浏览器与服务器建立 SSL/TLS 加密连接，以确保数据传输的安全性。
   - 服务器向浏览器提供 SSL 证书，证书包含公钥。

3. **SSL 证书验证**：
   - 浏览器验证服务器提供的 SSL 证书的有效性，包括证书是否由受信任的证书颁发机构签发，证书是否过期等。

4. **握手和加密**：
   - 浏览器和服务器完成 SSL/TLS 握手过程，协商加密算法和密钥。
   - 握手成功后，浏览器和服务器之间的通信将使用协商的密钥进行加密。

5. **负载均衡器**：
   - 用户的 HTTPS 请求到达负载均衡器（如 AWS ELB、HAProxy 或 Nginx）。
   - 负载均衡器根据配置的策略（轮询、最少连接、IP 哈希等）将请求分发到不同的后端服务器。

6. **SSL 卸载（可选）**：
   - 负载均衡器或反向代理服务器可以执行 SSL 卸载，即在这些设备上终止 SSL 连接，然后将未加密的请求转发到后端服务器。

7. **反向代理**：
   - 请求到达 Nginx 或 Apache 等反向代理服务器。
   - 反向代理服务器根据配置将请求路由到适当的后端服务或应用服务器。

8. **应用服务器**：
   - 请求最终到达应用服务器，可以是运行 Web 应用的服务器，如 Tomcat、Node.js 服务器等。
   - 应用服务器处理请求，并生成响应。

9. **内容返回**：
   - 应用服务器将生成的内容发送回反向代理服务器。

10. **SSL 加密（如果是 SSL 卸载）**：
    - 如果执行了 SSL 卸载，反向代理服务器将使用原始的 SSL 证书对内容进行加密。

11. **负载均衡器回传**：
    - 加密后的数据（如果进行了 SSL 加密）被发送回负载均衡器。

12. **返回给用户**：
    - 负载均衡器将响应传回给用户的浏览器。

13. **浏览器渲染**：
    - 浏览器接收到响应后，解密数据（如果之前进行了加密），并开始渲染页面内容。

在整个过程中，可能还会涉及到其他组件，如 CDN（内容分发网络）、DDoS 防护系统、防火墙、入侵检测系统等，以提高性能、安全性和可靠性。

此外，企业可能还会使用 API 网关来管理、监控和控制对后端服务的访问。

## DNS 解析

DNS（Domain Name System）解析是互联网中用于将人类可读的域名转换为机器可读的 IP 地址的过程。

这个系统是互联网的基础服务之一，允许用户通过域名而不是难以记忆的数字 IP 地址来访问网站。

以下是 DNS 解析过程的详细步骤：

1. **浏览器缓存检查**：
   - 用户输入一个域名，如 `www.example.com`。
   - 浏览器首先检查自身的缓存，看是否已经有了该域名对应的 IP 地址。

2. **操作系统缓存检查**：
   - 如果浏览器缓存中没有找到，浏览器会查询操作系统的 DNS 缓存。

3. **本地 DNS 服务器（ISP DNS）查询**：
   - 操作系统会将 DNS 查询请求发送给互联网服务提供商（ISP）的本地 DNS 服务器，这是用户上网配置中设置的 DNS 服务器。

4. **递归查询**：
   - 本地 DNS 服务器通常会执行递归查询：
     - 如果本地 DNS 服务器缓存了该域名的 IP 地址，它将直接返回结果。
     - 如果没有缓存，它会向 DNS 根服务器查询。

5. **DNS 根服务器**：
   - 根服务器返回负责顶级域（TLD，如 .com、.org）的 DNS 服务器地址。

6. **顶级域 DNS 服务器**：
   - 本地 DNS 服务器再向 TLD DNS 服务器查询，获取负责该域名的权威 DNS 服务器地址。

7. **权威 DNS 服务器**：
   - 权威 DNS 服务器是域名解析的最终权威来源，它会返回域名对应的 IP 地址。

8. **返回结果**：
   - 本地 DNS 服务器将获取到的 IP 地址返回给操作系统，操作系统再通知浏览器。

9. **浏览器访问 IP 地址**：
   - 浏览器使用得到的 IP 地址尝试连接到目标服务器。

10. **DNS 缓存**：
    - 为了提高效率，DNS 结果通常会在本地 DNS 服务器和操作系统中缓存一段时间。

11. **DNS 记录类型**：
    - DNS 查询不仅限于将域名转换为 IPv4 地址（A 记录），还可以包括 IPv6 地址（AAAA 记录）、邮件服务器（MX 记录）、别名（CNAME 记录）等。

12. **DNS 轮询**：
    - 为了负载均衡，DNS 服务器可以使用轮询（Round-Robin）策略，将请求平均分配到多个服务器的 IP 地址。

13. **智能 DNS**：
    - 某些 DNS 服务提供智能解析，根据用户的地理位置或其他因素将请求路由到最合适的服务器。

14. **DNS 安全性**：
    - 为了提高安全性，DNS 查询和响应可以通过 DNSSEC（DNS 安全扩展）进行加密和验证。

15. **DNS 优化**：
    - 使用 CDN 或其他网络优化技术，可以将 DNS 解析和内容分发更靠近用户，减少延迟。

DNS 解析是一个复杂而精细的过程，它确保了用户能够快速且准确地访问互联网上的资源。随着互联网的发展，DNS 系统也在不断进化，以满足更高的性能和安全性需求。


## 这种是公网的 DNS 的解析处理，如果是企业内网呢？想维护一套域名和 ip 的映射，一般是如何实现的？

在企业内网中，维护域名和 IP 地址的映射通常通过内部 DNS (Domain Name System) 服务器来实现。内部 DNS 服务器类似于互联网上的 DNS 服务，但仅限于企业内部网络使用。以下是企业内网中实现域名解析的常见步骤和方法：

1. **内部 DNS 服务器部署**：
   - 企业通常会部署至少一台内部 DNS 服务器，负责解析内网中的域名请求。

2. **域名映射配置**：
   - 在内部 DNS 服务器上配置域名和 IP 地址的映射关系。管理员可以通过 DNS 管理界面或配置文件手动添加这些记录。

3. **区域文件管理**：
   - 对于基于 BIND (Berkeley Internet Name Domain) 的 DNS 服务器，域名和 IP 的映射关系通常存储在称为区域文件（zone files）的文本文件中。

4. **DNS 缓存**：
   - 内部 DNS 服务器会缓存解析后的域名信息，以加快响应速度并减少网络流量。

5. **动态 DNS (DDNS)**：
   - 如果企业内网的 IP 地址是动态分配的，可以使用动态 DNS 服务来自动更新域名与当前 IP 地址的映射。

6. **DNS 转发器**：
   - 内部 DNS 服务器可以配置为转发不能解析的域名请求到外部 DNS 服务器，以便解析互联网上的域名。

7. **DNS 安全性**：
   - 内部 DNS 服务器可以配置安全特性，如访问控制、DNSSEC（DNS 安全扩展）等，以防止 DNS 劫持和欺骗攻击。

8. **DNS 负载均衡**：
   - 使用 DNS 轮询或智能 DNS 策略，可以在多个服务器之间分配负载，提高应用的可用性和性能。

9. **分层次命名策略**：
   - 企业内网的 DNS 结构通常遵循分层次的命名策略，如按照部门或地理位置划分子域。

10. **本地主机文件**：
    - 在没有专用 DNS 服务器的情况下，也可以在本地主机文件（如 Windows 的 `hosts` 文件）中手动配置域名和 IP 地址的映射。

11. **DNS 服务提供商**：
    - 一些企业可能会选择使用第三方 DNS 服务提供商来管理内部 DNS，特别是对于需要复杂管理或高可用性要求的情况。

12. **AD 集成**：
    - 在使用活动目录（Active Directory）的环境中，DNS 服务可以与 AD 集成，实现基于域的名称解析。

13. **监控和维护**：
    - 定期监控 DNS 服务器的性能和安全性，并进行必要的维护和更新。

通过上述方法，企业可以确保内网中的设备和用户能够通过易于记忆的域名来访问内部资源，而不是难以记忆的 IP 地址。

这不仅提高了内网的可管理性，也增强了用户体验。

## 适合个人和小型企业内网使用的 dns 的开源服务器有哪些？给出网址

适合个人和小型企业内网使用的 DNS 开源服务器有：

1. **Godns**
   - 简介：Godns 是一个轻量级、高性能且易于部署的 DNS 服务器，支持多种配置方式，包括 JSON 配置文件和命令行参数，适合个人和小型企业。
   - 网址：[Godns 项目地址](https://gitcode.com/TimothyYe/godns)

2. **CoreDNS**
   - 简介：CoreDNS 是一个插件式的 DNS 服务器，使用 Golang 开发，是 Kubernetes 1.13 后所内置的默认 DNS 服务器，适用于内网环境搭建。
   - 网址：[CoreDNS 项目地址](https://github.com/coredns/coredns)

3. **dnsmasq**
   - 简介：dnsmasq 是一个小巧且方便的工具，用于配置 DNS 和 DHCP，适用于小型网络，配置简单。
   - 网址：[dnsmasq 项目地址](https://github.com/robertfoss/dnsmasq)

4. **ADGuardHome**
   - 简介：ADGuardHome 是一个开源的 DNS 服务器，可以作为个人和小型企业的广告和跟踪器阻止解决方案。
   - 网址：[ADGuardHome 项目地址](https://github.com/AdguardTeam/AdGuardHome)

5. **ddns-at-home**
   - 简介：ddns-at-home 是一个开源的解决方案，允许在家庭环境中轻松设置动态 DNS 服务器。
   - 网址：[ddns-at-home 项目地址](https://blog.csdn.net/gitblog_00035/article/details/138113548)

这些开源 DNS 服务器各有特点，可以根据个人或企业的具体需求进行选择。例如，

Godns 以其简洁和高性能著称，CoreDNS 则因其插件式架构和 Kubernetes 生态系统集成而受到欢迎。dnsmasq 适合需要同时管理 DNS 和 DHCP 的小型网络环境。ADGuardHome 不仅提供 DNS 服务，还带有广告拦截功能，而 ddns-at-home 专注于动态 DNS 解决方案。

对于个人和小型企业内网使用的开源 DNS 服务器，以下是一些常用的选择：

1. **BIND (Berkeley Internet Name Domain)**：
   - 网址：https://www.isc.org/bind/
   - BIND 是一个功能强大的开源 DNS 服务器，被广泛用于互联网和企业内网环境中。它支持丰富的功能和灵活的配置选项。

2. **Unbound**：
   - 网址：https://nlnetlabs.nl/projects/unbound/about/
   - Unbound 是一个轻量级、高性能的开源 DNS 解析器和缓存服务器，适用于个人和小型企业内网环境。

3. **PowerDNS**：
   - 网址：https://www.powerdns.com/
   - PowerDNS 是一个灵活的、模块化的开源 DNS 服务器，支持多种后端存储（如数据库、文件、API等），适用于个人和小型企业内网环境。

4. **dnsmasq**：
   - 网址：http://www.thekelleys.org.uk/dnsmasq/doc.html
   - dnsmasq 是一个轻量级的 DNS 缓存服务器和 DHCP 服务器，适用于个人和小型企业内网环境。

5. **CoreDNS**：
   - 网址：https://coredns.io/
   - CoreDNS 是一个模块化的 DNS 服务器，支持插件式的架构，适用于云原生环境和微服务架构中的 DNS 解析服务。

这些开源 DNS 服务器都具有不同的特点和适用场景，你可以根据自己的需求选择最适合的。每个项目的网址都提供了详细的文档和指南，以帮助你了解如何配置和使用这些 DNS 服务器。

## 语言

Godns/BIND/Unbound/PowerDNS/dnsmasq/CoreDNS/ADGuardHome/ddns-at-home 列出这些开源 dns 的编程语言，和一些详细的对比表格。

以下是这些开源 DNS 服务器的编程语言和一些详细的对比信息：

| DNS 服务器名称 | 编程语言 | 主要特性 | 适合规模 | 配置复杂度 | 插件/扩展支持 | 社区活跃度 | 学习曲线 | 实时更新 | 安全特性 | 项目地址 |
|----------------|-----------|----------|----------|------------|--------------|------------|----------|----------|----------|
| Godns          | Go        | 轻量级、高性能、多种配置方式、RESTful API | 个人/小型企业 | 低 | 未来支持插件 | 高 | 适中 | 支持 | 支持HTTPS | [Godns](https://gitcode.com/TimothyYe/godns) |
| BIND           | C         | 功能全面、稳定、广泛使用 | 大型/企业 | 高 | 支持 | 高 | 陡峭 | 支持 | 支持DNSSEC | [BIND](https://www.isc.org/bind/) |
| Unbound        | C/C++     | 递归解析器、DNSSEC验证、缓存 | 中型/企业 | 中 | 社区插件 | 中 | 适中 | 支持 | 支持DNSSEC | [Unbound](https://www.unbound.net/) |
| PowerDNS       | C++       | 高性能、多种后端支持、Lua脚本 | 中型/大型 | 中 | Lua脚本 | 高 | 适中 | 支持 | 支持DNSSEC | [PowerDNS](https://www.powerdns.com/) |
| dnsmasq        | C         | 轻量级、易于配置、同时提供DHCP | 小型网络/个人 | 低 | 有限 | 中 | 浅 | 支持 | 基本 | [dnsmasq](http://www.thekelleys.org.uk/dnsmasq/doc.html) |
| CoreDNS        | Go        | 插件式、Kubernetes集成、快速 | 中型/云原生 | 中 | 丰富 | 高 | 适中 | 支持 | 支持DNSSEC | [CoreDNS](https://coredns.io/) |
| ADGuardHome    | Go        | 广告过滤、家长控制、隐私保护 | 家庭/小型网络 | 低 | 过滤规则 | 中 | 浅 | 支持 | 基本 | [ADGuardHome](https://github.com/AdguardTeam/AdGuardHome) |
| ddns-at-home   | 不明确    | 动态DNS服务 | 家庭用户 | 低 | 不明确 | 不明确 | 浅 | 不明确 | 不明确 | [ddns-at-home](https://blog.csdn.net/gitblog_00035/article/details/138113548) |

**注意**：
- 上表中的“适合规模”列是指该 DNS 服务器通常推荐的使用场景。
- “配置复杂度”列反映了配置该 DNS 服务器的难易程度。
- “社区活跃度”列基于项目维护的活跃程度和社区的参与度。
- “学习曲线”列描述了对于新手来说学习使用该 DNS 服务器的难易程度。
- “实时更新”列指出了该 DNS 服务器是否支持实时或快速的配置更新而无需重启服务。
- “安全特性”列提到了该 DNS 服务器是否支持如 DNSSEC 这样的安全扩展或提供其他安全相关的功能。

由于信息可能随时间变化，建议直接访问项目的官方网站或源代码仓库以获取最新和最准确的信息。

## 为什么没有 java ？有 java 语言开源的 dns 服务器吗。给出 java 的 dns 开源服务器+网址

确实存在使用 Java 语言编写的开源 DNS 服务器。以下是几个 Java 语言编写的 DNS 服务器项目及其网址：

1. **JmDNS**
   - 简介：JmDNS 是一款用 Java 编写的轻量级 DNS 服务器，实现了多播 DNS 协议（mDNS），适用于局域网内设备间的服务发现与通信。
   - 网址：[JmDNS 项目地址](https://gitcode.com/jmdns/jmdns)

2. **dns-cheater**
   - 简介：dns-cheater 是一个用 Java 实现的 DNS 服务器，它通过 WEB 端的管理界面提供基本的 DNS 服务器功能，并且支持企业内部云的 DNS、上网行为控制等。
   - 网址：[dns-cheater 项目地址](https://gitee.com/matrixy/dns-cheater)

3. **DNSServer**
   - 简介：DNSServer 是一个开源的 Java 版 DNS 服务器，实现了部分 RFC1035 协议内容，能够处理基本的 A 类型记录。
   - 网址：[DNSServer 项目地址](https://www.oschina.net/news/141053/dnsserver-1-0-released)

4. **自定义 Java DNS 服务器实现**
   - 简介：有关使用 Java 实现自定义 DNS 服务器的实践，包括使用 Apache HttpClient 的 InMemoryDnsResolver 和 SystemDefaultDnsResolver 类进行自定义解析的示例。
   - 网址：[Java自定义DNS解析器三种实践](https://cloud.tencent.com/developer/article/1940751)

这些项目展示了 Java 在 DNS 服务器领域的应用，从简单的服务发现到完整的 DNS 服务器实现，可以根据个人或企业的具体需求选择合适的项目进行部署或参考学习。

## 我想实现内网中，访问一个域名，让后请求就会到指定的服务器上。windows 下可以修改 hosts 文件，linux 上，有哪些方法？

在Linux系统中，实现内网中通过域名访问指定服务器的功能，可以通过以下几种方法：

1. **修改`hosts`文件**：
   - 类似于Windows系统，Linux也有`hosts`文件，位于`/etc/hosts`。
   - 通过编辑该文件，可以将域名映射到指定的IP地址。例如：
     ```
     192.168.1.100  myserver.example.com
     ```
   - 这种方法简单直接，但不适合动态变化的环境或大量域名的管理。

2. **使用DNS服务**：
   - 在Linux上运行DNS服务，如BIND（Berkeley Internet Name Domain）。
   - 可以创建一个区域文件，将域名与内网IP地址关联起来。

3. **利用`dnsmasq`**：
   - `dnsmasq`是一个轻量级的DNS、DHCP和网络时间协议（NTP）服务器。
   - 它可以为本地网络上的机器提供DNS和DHCP服务，并且可以为特定的域名返回特定的IP地址。

4. **使用`iptables`规则**：
   - `iptables`可以用来重定向特定域名的流量到指定的IP地址。
   - 通过设置MASQUERADE或REDIRECT规则，可以将特定域名的流量重定向。

5. **使用`firewalld`**（适用于使用firewalld管理系统的Linux发行版）：
   - 可以设置规则，将对特定域名的访问重定向到特定的IP地址。

6. **使用本地DNS解析器**：
   - 安装和配置本地DNS解析器，如`unbound`或`powerdns`。
   - 在配置文件中定义域名与IP的映射关系。

7. **修改网络配置**：
   - 对于某些网络管理工具或配置，可以直接在网络设置中指定DNS服务器，并在该DNS服务器上配置域名解析。

8. **使用`systemd-resolved`**：
   - `systemd-resolved`是systemd的一部分，它是一个本地域名解析器和DNS stub resolver。
   - 可以通过编辑`/etc/systemd/resolved.conf`或创建新的`resolved.conf.d/`文件来添加域名到IP的映射。

9. **使用`hosts`文件的动态版本**：
   - 有些系统允许使用动态更新的`hosts`文件，如使用`dnsmasq`来管理。

选择哪种方法取决于具体需求、网络环境和个人偏好。

对于简单的需求和小规模网络，直接修改`hosts`文件可能是最快的解决方案。

而对于需要高级功能和可扩展性的更复杂的网络环境，则可能需要考虑使用DNS服务或`dnsmasq`。


## 为什么修改 hosts 就可以实现域名到 ip 的映射呢？详细介绍一下 dns 的域名与 ip 的映射流程

修改`hosts`文件可以实现域名到IP的映射，因为它是操作系统用于将网络主机名映射到IP地址的文件。

当系统需要解析一个域名时，它会首先检查`hosts`文件，看是否能找到对应的IP地址。如果找到了，就不需要进行DNS查询，直接使用该文件中定义的IP地址。

下面是DNS域名与IP映射的详细流程：

1. **浏览器缓存检查**：当用户输入一个域名时，浏览器首先检查自己的缓存，看是否已经有了该域名对应的IP地址。

2. **操作系统缓存检查**：如果浏览器缓存中没有，浏览器会询问操作系统。操作系统会检查自己的DNS缓存（如`/etc/hosts`文件或系统DNS缓存）。

3. **DNS递归查询**：如果操作系统缓存中也没有，操作系统将向配置的DNS服务器（通常是ISP提供的）发起递归查询。

4. **根DNS服务器**：如果本地DNS服务器也没有该域名的记录，它会向根DNS服务器查询，根服务器会告诉本地DNS服务器下一步应该查询的顶级域（TLD）服务器。

5. **顶级域DNS服务器**：本地DNS服务器继续查询相应的顶级域（如.com、.org等）DNS服务器，获取负责该域名的权威DNS服务器。

6. **权威DNS服务器**：最后，本地DNS服务器向权威DNS服务器查询，权威DNS服务器会提供最终的IP地址。

7. **缓存IP地址**：本地DNS服务器得到IP地址后，会缓存这个映射关系一段时间，以便快速响应后续的相同查询。

8. **返回客户端**：本地DNS服务器将IP地址返回给操作系统，操作系统再返回给浏览器。

9. **浏览器访问IP**：浏览器得到IP地址后，就可以向该IP地址发起连接请求。

这个过程中，`hosts`文件的作用是作为本地静态映射表，提供了一种无需DNS服务器即可解析域名的方法。这对于快速访问某些网站或在没有网络连接的情况下访问本地网络中的服务器非常有用。

DNS域名解析是一个复杂的过程，涉及到多个服务器和缓存机制，目的是为了提高域名解析的速度和可靠性。

通过缓存，可以减少不必要的DNS查询，加快解析速度。

同时，通过分布式的DNS服务器，可以分散解析请求，提高整个系统的可靠性和可扩展性。

# 参考资料

> [tengine zh_CN](http://tengine.taobao.org/)

学习则以 tengine 为主。

- what can nginx do 

[nginx](https://www.nginx.com/resources/glossary/nginx/)

* any list
{:toc}



