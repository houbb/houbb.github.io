---
layout: post
title:  XStream
date:  2017-6-13 15:30:42 +0800
categories: [XML]
tags: [xStream]
published: true
---

# XStream

[XStream](http://x-stream.github.io/) is a simple library to serialize objects to XML and back again.


> Features

- Ease of use. A high level facade is supplied that simplifies common use cases.

- No mappings required. Most objects can be serialized without need for specifying mappings.

- Performance. Speed and low memory footprint are a crucial part of the design, making it suitable for large object graphs or systems with high message throughput.

- Clean XML. No information is duplicated that can be obtained via reflection. This results in XML that is easier to read for humans and more compact than native Java serialization.

- Requires no modifications to objects. Serializes internal fields, including private and final. Supports non-public and inner classes. Classes are not required to have default constructor.

- Full object graph support. Duplicate references encountered in the object-model will be maintained. Supports circular references.

- Integrates with other XML APIs. By implementing an interface, XStream can serialize directly to/from any tree structure (not just XML).

- Customizable conversion strategies. Strategies can be registered allowing customization of how particular types are represented as XML.

- Security framework. Fine-control about the unmarshalled types to prevent security issues with manipulated input.

- Error messages. When an exception occurs due to malformed XML, detailed diagnostics are provided to help isolate and fix the problem.

- Alternative output format. The modular design allows other output formats. XStream ships currently with JSON support and morphing.

- Typical Uses


# Hello World

<uml>
    Title: XStream Demo
    Object->Xml: Trans object into xml;
    Xml->Obejct: Trans xml into xml;
</uml>

(这个官方的例子稍微有些不够简洁，但是也很容易理解。效果显著)

使用之前，引入Jar

```xml
<dependency>
    <groupId>com.thoughtworks.xstream</groupId>
    <artifactId>xstream</artifactId>
    <version>1.4.9</version>
</dependency>
```

## Obj2Xml

- toXmlTest()

```java
@Test
public void toXmlTest() {
     XStream xstream = new XStream(new StaxDriver());
     xstream.alias("person", Person.class);
     xstream.alias("phoneNum", PhoneNum.class);

     Person joe = new Person();
     joe.setFirstname("hello");
     joe.setLastname("world");
     joe.setPhone(new PhoneNum(123, "1234-456"));
     joe.setFax(new PhoneNum(123, "9999-999"));

     String xml = xstream.toXML(joe);
     System.out.println(xml);
}
```



其中实体类如下(下一个列子也是用此实体类)：

- Person.java

```java
@Data
public class Person {

    private String firstname;

    private String lastname;

    private PhoneNum phone;

    private PhoneNum fax;

}
```

- PhoneNum.java

```java
@Data
public class PhoneNum {
    private int code;
    private String number;

    public PhoneNum(int code, String number) {
        this.code = code;
        this.number = number;
    }
}
```

为了简单，此处不适用日志。直接打印。结果如下:

```xml
<?xml version="1.0" ?><person><firstname>hello</firstname><lastname>world</lastname><phone><code>123</code><number>1234-456</number></phone><fax><code>123</code><number>9999-999</number></fax></person>
```

## Xml2Obj

既然可以将对象转成XML，反之肯定也可以。如下：

- toObjectTest()

```java
@Test
public void toObjectTest() {
     final String xml = "<?xml version=\"1.0\" ?><person><firstname>hello</firstname><lastname>world</lastname><phone><code>123</code><number>1234-456</number></phone><fax><code>123</code><number>9999-999</number></fax></person>";
     XStream xstream = new XStream(new StaxDriver());
     xstream.alias("person", Person.class);
     xstream.alias("phoneNum", PhoneNum.class);
     Person newJoe = (Person)xstream.fromXML(xml);
     System.out.println(newJoe.getFirstname());  
}
```

打印结果:

```
hello
```

# Alias

有时候我们为了更便于阅读或者简化会为一样东西提供一个别名。我们来看一个简单的例子。

假设我们要生成如图的xml文件：

```xml
<blog author="ryo">
  <entry>
    <title>first</title>
    <description>My first blog entry.</description>
  </entry>
  <entry>
    <title>tutorial</title>
    <description>
        Today we have developed a nice alias tutorial. Tell your friends! NOW!
    </description>
  </entry>
</blog>
```

首先，我们会建立对应实体类。

- Blog.java

```java
@Data
public class Blog {
    private Author writer;
    private List<Entry> entries = new LinkedList<>();
}
```

- Author.java

```java
@Data
public class Author {

    private String name;

    public Author(String name) {
        this.name = name;
    }
}
```

- Entry.java

```java
@Data
public class Entry {

    private String title;

    private String description;

    public Entry(String title, String description) {
        this.title = title;
        this.description = description;
    }
}
```

然后，我们写一个简单的测试。

- initTest()

```java
@Test
public void initTest() {
    Author author = new Author("ryo");
    Blog teamBlog = new Blog();
    teamBlog.setWriter(author);

    List<Entry> entries = new LinkedList<>();
    entries.add(new Entry("first","My first blog entry."));
    entries.add(new Entry("tutorial",
            "Today we have developed a nice alias tutorial. Tell your friends! NOW!"));
    teamBlog.setEntries(entries);

    XStream xstream = new XStream();
    System.out.println(xstream.toXML(teamBlog));
}
```

打印结果:

```xml
<com.ryo.convert.test.domain.Blog>
  <writer>
    <name>ryo</name>
  </writer>
  <entries class="linked-list">
    <com.ryo.convert.test.domain.Entry>
      <title>first</title>
      <description>My first blog entry.</description>
    </com.ryo.convert.test.domain.Entry>
    <com.ryo.convert.test.domain.Entry>
      <title>tutorial</title>
      <description>Today we have developed a nice alias tutorial. Tell your friends! NOW!</description>
    </com.ryo.convert.test.domain.Entry>
  </entries>
</com.ryo.convert.test.domain.Blog>
```

一、Class Alias

我们将XStream调用时简单修改如下：(这个在一开始的例子中其实已经使用过了)

```java
XStream xstream = new XStream();
xstream.alias("blog", Blog.class);
xstream.alias("entry", Entry.class);
```

输出结果如下：

```xml
<blog>
  <writer>
    <name>ryo</name>
  </writer>
  <entries class="linked-list">
    <entry>
      <title>first</title>
      <description>My first blog entry.</description>
    </entry>
    <entry>
      <title>tutorial</title>
      <description>Today we have developed a nice alias tutorial. Tell your friends! NOW!</description>
    </entry>
  </entries>
</blog>
```

- Field Alias

上面的输出看起来简洁了很多，但是我们想把 `writer` 改为 `author` 怎么做呢？接着看。

只需要添加一句话:

```java
xstream.aliasField("author", Blog.class, "writer");
```

结果：

```xml
<blog>
  <author>
    <name>ryo</name>
  </author>
  <entries class="linked-list">
    <entry>
      <title>first</title>
      <description>My first blog entry.</description>
    </entry>
    <entry>
      <title>tutorial</title>
      <description>Today we have developed a nice alias tutorial. Tell your friends! NOW!</description>
    </entry>
  </entries>
</blog>
```

三、Implicit collection

如果我们有一个集合，但是我们不想把根节点显示出来。比如本例子，不想显示 `entries` 节点。

```java
xstream.addImplicitCollection(Blog.class, "entries");
```

结果如下：

```xml
<blog>
  <author>
    <name>ryo</name>
  </author>
  <entry>
    <title>first</title>
    <description>My first blog entry.</description>
  </entry>
  <entry>
    <title>tutorial</title>
    <description>Today we have developed a nice alias tutorial. Tell your friends! NOW!</description>
  </entry>
</blog>
```

四、Attribute Alias

我们离最后的目标还差一点。如何将 `author` 属性变为 XML 的属性呢。

- AttributeAliasTest()

```java
XStream xstream = new XStream();
xstream.alias("blog", Blog.class);
xstream.alias("entry", Entry.class);
xstream.addImplicitCollection(Blog.class, "entries");

xstream.useAttributeFor(Blog.class, "writer");
xstream.aliasField("author", Blog.class, "writer");
xstream.registerConverter(new AuthorConverter());

System.out.println(xstream.toXML(teamBlog));
```

- AuthorConverter.java

我们必须告诉 XStream 如何将字段属性转换为 XML 的 tag 属性。
 
```java
public class AuthorConverter implements SingleValueConverter {

    @Override
    public String toString(Object obj) {
        return ((Author) obj).getName();
    }

    @Override
    public Object fromString(String name) {
        return new Author(name);
    }

    @Override
    public boolean canConvert(Class type) {
        return type.equals(Author.class);
    }

}
```

输出结果如下：

```xml
<blog author="ryo">
  <entry>
    <title>first</title>
    <description>My first blog entry.</description>
  </entry>
  <entry>
    <title>tutorial</title>
    <description>Today we have developed a nice alias tutorial. Tell your friends! NOW!</description>
  </entry>
</blog>
```

大功告成！

五、Package Alias

我们再看一个可能会用到的技能——为包名起一个别名。

```java
XStream xstream = new XStream();
xstream.aliasPackage("my.company", "com.ryo.convert.test.domain");
System.out.println(xstream.toXML(teamBlog));
```

结果如下：

```xml
<my.company.Blog>
  <writer>
    <name>ryo</name>
  </writer>
  <entries class="linked-list">
    <my.company.Entry>
      <title>first</title>
      <description>My first blog entry.</description>
    </my.company.Entry>
    <my.company.Entry>
      <title>tutorial</title>
      <description>Today we have developed a nice alias tutorial. Tell your friends! NOW!</description>
    </my.company.Entry>
  </entries>
</my.company.Blog>
```










