---
layout: post
title:  IP 协议
date:  2018-09-25 14:44:40 +0800
categories: [Protocol]
tags: [ip, protocol, sh]
published: true
---

# IP 协议

网际协议（英语：Internet Protocol，缩写为IP），又译互联网协议，是用于分组交换数据网络的一种协议。

IP是在TCP/IP协议族中网络层的主要协议，任务仅仅是根据源主机和目的主机的地址来传送数据。

为此目的，IP定义了寻址方法和数据报的封装结构。第一个架构的主要版本，现在称为IPv4，仍然是最主要的互联网协议，尽管世界各地正在积极部署IPv6。

# IP 特点

IP协议为上层协议提供无状态、无连接、不可靠的服务。

## 无状态

无状态是指IP通信双方不同步传输数据的状态信息，所有IP数据报的发送、传输、接受都是相互独立、没有上下文关系的。

这种服务优点在于简单、高效。最大的缺点是无法处理乱序和重复的IP数据报，确保IP数据报完整的工作只能交给上层协议来完成。

## 无连接

无连接是指IP通信双方都不长久地维持对方的任何信息。上层协议每次发送数据的时候，都需要明确指出对方的IP地址。

## 不可靠

不可靠是指IP协议不能保证IP数据报准确到达接收端，它指承诺尽最大努力交付。

IP模块一旦检测到数据报发送失败，就通知上层协议，而不会试图重传。

# IP4 协议头

![ipv4](https://upload-images.jianshu.io/upload_images/5853159-1cd12b03db657e08.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/521/format/webp)

IP协议头格式

数据在经过IP网络层时,也会对数据进行封装,也就有相应的IP协议包头了｡

在以太网帧中,IPv4包头紧跟着以太网帧头,同时以太网帧头中的协议类型值设置为十六进制的0800｡

## 属性说明

### 版本(Version)

指定IP协议的版本号｡

因为目前仍主要使用IPv4版本,所以这里的值通常是 0x4 (注意封包使用的数字通常都是十六进位的)｡占4位｡

### 包头长度(Internet Header Length,IHL)

指明IPv4协议包头长度的字节数包含多少个32位｡

由于IPv4的包头可能包含可变数量的可选项,所以这个字段可以用来确定IPv4数据报中数据部分的偏移位置｡

IPv4包头的最小长度是20个字节,因此IHL这个字段的最小值用十进制表示就是5，占4位｡

由于它是一个4比特字段,因此首部最长为60个字节,但实际上目前最多仍为24个字节｡

### 服务类型(Type of Service,TOS)

定义IP封包在传送过程中要求的服务类型,共由8个bit组成其中每个bit的组合分别代表不同的意思｡

4bit中只能置其中1bit｡

如果所有4bit均为0,那么就意味着是一般服务｡

具体如下:

- `000..... (Routine)`: 过程字段,占3位｡设置了数据包的重要性,取值越大数据越重要,取值范围为:0(正常)~ 7(网络控制)

- `...0....(Delay)`: 延迟字段 ,占1位,取值:0(正常)､1(期特低的延迟) 

- `....0...(Throughput)`: 流量字段,占1位｡取值:0(正常)､1(期特高的流量) 

- `.....0..(Reliability)`: 可靠性字段,占1位｡取值:0(正常)､1(期特高的可靠性)

- `…..0.(ECN-Capable Transport)`: 显式拥塞指示传输字段,占1位｡由源端设置,以显示源端节点的传输协议是支持ECN(Explicit Cogestion Notifica tion,显式拥塞指示)的｡取值:0(不支持ECN)､1(支持ECN)

- `.......0(Congestion Experienced)`: 拥塞预警字段,占1位｡取值:0(正常,不拥塞)､1(拥塞)

### 包长度(Total Length,TL)

IP协议头格式中指定IP包的总长,通常以byte做单位来表示该封包的总长度此数值包括标头和数据的总和｡它以字节为单位,占16位｡

利用首部长度字段和总长度字段,就可以知道IP数据报中数据内容的起始位置和长度｡

由于该字段长16比特,所以IP数据报最长可达65535字节｡尽管可以传送一个长达65535字节的IP数据报,但是大多数的链路层都会对它进行分段｡

而且,主机也要求不能接收超过576字节的数据报｡由于TCP把用户数据分成若干段,因此一般来说这个限制不会影响TCP｡

UDP的应用(如RIP､TFTP､BOOTP､DNS､SNMP等),都限制用户数据报长度为512字节,小于576字节｡

但是,事实上现在大多数的实现允许超过8192字节的IP数据报｡

总长度字段是IP首部中必要的内容,因为一些数据链路(如以太网)需要填充一些数据以达到最小长度｡

尽管以太网的最小帧长为46个字节(将在本章后面介绍),但是IP数据可能会更短｡如果没有总长度字段,那么IP层就不知道46字节中有多少是IP数据报的内容｡

### 标识(Identification)

每一个IP封包都有一个16位的唯一识别码｡当程序产生的数据要通过网络传送时都会被拆散成封包形式发送,当封包要进行重组的时候这个ID就是依据了｡占16位｡

标识字段唯一地标识主机发送的每一份数据报｡通常每发送一份消息它的值就会加1｡RFC791认为标识字段应该由让IP发送数据报的上层来选择｡假设有两个连续的IP数据报,其中一个是由TCP生成的,而另一个是由UDP生成的,那么它们可能具有相同的标识字段｡尽管这也可以照常工作(由重组算法来处理),但是在大多数从伯克利派生出来的系统中,每发送一个IP数据报,IP层都要把一个内核变量的值加1,不管交给IP的数据来自哪一层｡内核变量的初始值根据系统引导时的时间来设置｡

### 标记(Flags)

这是当封包在传输过程中进行最佳组合时使用的3个bit的识别记号｡占3位｡

- `000(Reserved Fragment)`: 保留分段｡ 当此值为0的时候表示目前未被使用｡

- `.0.(Don't Fragment)`: 不分段｡ 当此值为0的时候表示封包可以被分段,如果为1则不能被分割｡ 

- `..0( More Fragment)`: 更多分段｡ 当上一个值为0时,此值为0就示该封包是最後一个封包,如果为1则表示其後还有被分割的封包｡

### 分段偏移(Fragment Offset,FO)

IP协议头格式规定当封包被分段之后,由于网路情况或其它因素影响其抵达顺序不会和当初切割顺序一至,所以当封包进行分段的时候会为各片段做好定位记录,以便在重组的时候就能够对号入座｡值为多少个字节,如果封包并没有被分段,则FO值为“0"｡ 占13位｡ 

### 生存时间(Time To Live,TTL)

生存时间字段设置了数据报可以经过的最多路由器数,表示数据包在网络上生存多久｡

TTL的初始值由源主机设置(通常为32或64),一旦经过一个处理它的路由器,它的值就减去1｡

当该字段的值为0时,数据报就被丢弃,并发送ICMP消息通知源主机｡这样当封包在传递过程中由於某些原因而未能抵达目的地的时候就可以避免其一直充斥在网路上面｡占8位｡

### 协议(Protocol,PROT)

指该封包所使用的网络协议类型,如ICMP､DNS等｡占8位｡

[协议编号列表](https://zh.wikipedia.org/wiki/IP%E5%8D%8F%E8%AE%AE%E5%8F%B7%E5%88%97%E8%A1%A8)

### 头校验和(Header checksum)

指IPv4数据报包头的校验和｡这个数值用来检错用的,用以确保封包被正确无误的接收到｡当封包开始进行传送后,接收端主机会利用这个检验值会来检验余下的封包,如果一切无误就会发出确认信息表示接收正常｡与UDP和TCP协议包头中的校验和作用是一样的｡占16位｡

首部检验和字段是根据IP首部计算的检验和码,不对首部后面的数据进行计算｡ICMP､IGMP､UDP和TCP协议在它们各自的首部中均含有同时覆盖首部和数据检验和码｡

IP协议头格式规定了：计算一份数据报的IP检验和,首先把检验和字段置为0｡然后,对首部中每个16位进行二进制反码求和(整个首部看成是由一串16位的字组成),结果存在检验和字段中｡当接收端收到一份IP数据报后,同样对首部中每个16 位进行二进制反码的求和｡由于接收方在计算过程中包含了发送方存在首部中的检验和,因此,如果首部在传输过程中没有发生任何差错,那么接收方计算的结果应该为全1｡如果结果不是全1(即检验和错误),那么IP就丢弃收到的数据报｡但是不生成差错消息,由上层去发现丢失的数据报并进行重传｡

ICMP､IGMP､UDP和TCP都采用相同的检验和算法,尽管TCP和UDP除了本身的首部和数据外,在IP首部中还包含不同的字段｡由于路由器经常只修改TTL字段(减1),因此当路由器转发一份消息时可以增加它的检验和,而不需要对IP整个首部进行重新计算｡

### 源地址(Source Address,SA)

发送IP数据包的IP地址｡占32位｡

### 目的地址(Destination Address)

接收IP数据包的IP地址｡也占32位｡

### 选项(Options)+填充(Padding)

这两个选项较少使用,只有某些特殊的封包需要特定的控制才会利用到｡共32位｡这些选项通常包括:

### 安全和处理限制

用于军事领域

### 记录路径

让每个路由器都记下它的IP地址

### 时间戳

让每个路由器都记下它的IP地址和时间

### 宽松的源站选路

为数据报指定一系列必须经过的IP地址

### 严格的源站选路

与宽松的源站选路类似,但是要求只能经过指定的这些地址,不能经过其他的地址｡

以上这些选项很少被使用,而且并非所有的主机和路由器都支持这些选项｡

选项字段一直都是以32位作为界限,在必要的时候插入值为0的填充字节｡这样就保证IP首部始终是32位的整数倍(这是首部长度字段所要求的)｡

从以上IP协议头格式可以看出,IP协议包头大小也有两种:当没有“选项"这个字段时,为160位,20个字节;当有“选项"字段时为192位,24个字节｡它与TCP协议包头大小是一样的｡

# IP6 协议头

IPv6协议并不是IPv4的简单扩展，而是完全独立的协议。从以太网帧封装的数据类型来看，前者类型是0X86dd，后者是0x8600，是完全不同的类型。

IPv6解决了网络地址不足的问题，其头部增加了多播和流的功能，引入了自动配置功能，还增加了网络安全的功能。
其固定部分的头部如下：

## 头部

![ipv6](https://upload-images.jianshu.io/upload_images/5853159-1d601ef3cf12e284.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/526/format/webp)

## 属性说明

### 流标签

是IPv6新增加的字段，用于对某些连接的服务质量有特殊要求的通信，比如音频或者视频等实时数据传递。

### 下一个包头

指出紧跟IPv6固定头部后的包头类型，如拓展头，或者某个上层协议头（ICMP，TCP，UDP），它类似IPv4中的协议字段，且相同的取值具有相同的含义。

# 常见问题

## 为什么 IP 不可靠

IP 协议没有超时和重传机制，没有连接握手协议。

## IP数据报经过路由器都做了哪些改动

IP没经过一个路由器，TTL数就会减一，如果最后TTL为0了，但是依然没有到达目的地，这个IP包将会被丢弃。

这样做了目的是为了防止出现循环回路。并且最后一跳的路由器会发送一个ICMP不可达的数据包给源IP。

## 分片问题

IP数据包的长度为16，也就是说最大为65535个字节。但是我们知道数据链路层规定MTU最大传输单元为1500个字节。

当IP数据包的大小超过了1500，IP数据包必须要进行分片处理。

这还只是初始发送端的分片，在网络中如果某个路由器的MTU小于1500，那么还需要在路由器端做分片，这就给IP包的完整接收照成了很大的不确定性（我们知道数据包达到终点不一定是按照顺序的），因为万一某一个分片丢失，可能会造成真个IP重传，当然前提是高层协议支持重传。

对于TCP协议，不存在分片的问题，因为TCP报头的选项字段有MSS字段，规定一个TCP包最大可传输的字节数，一般是1500-20-20=1460字节。

也就是说到达IP封包的时候最大可承载数据只有1460个字节，这样就可以避免分片的问题。

但是对于UDP这一类的协议，分片操作还是交给IP完成，虽然这样可以增加载荷的效率，但是稳定性会受到很大的影响。

# 参考资料

[图解IP协议（一） IP协议原理与实践](http://blog.51cto.com/chenxinjie/1970704)

[网络协议](https://zh.wikipedia.org/wiki/%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AE)

[一篇文章带你熟悉 TCP/IP 协议（网络协议篇二）](https://juejin.im/post/5a069b6d51882509e5432656)

[IP协议详解](https://www.jianshu.com/p/58a77f173f71)

[IP协议首部详细分析](https://blog.csdn.net/zhangdaisylove/article/details/47147991)

https://zhangbinalan.gitbooks.io/protocol/content/ipxie_yi.html

* any list
{:toc}