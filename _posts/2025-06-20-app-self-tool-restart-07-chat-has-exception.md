---
layout: post
title: å¦‚ä½•è®¾è®¡å®ç°å¼€å‘è‡ªåŠ©é‡å¯å·¥å…·-05-èŠä¸€èŠæœåŠ¡å¦‚ä½•åˆ¤æ–­å¤„ç†æ˜¯å¦å­˜åœ¨å¼‚å¸¸ï¼Ÿ
date: 2025-6-20 23:45:51 +0800
categories: [Tool]
tags: [tool, sh]
published: true
---

# å¼€å‘è‡ªåŠ©é‡å¯

è¯´æ˜ï¼šæœ‰æ—¶å€™ç ”å‘äº§çº¿éœ€è¦é‡å¯ï¼Œä¸ºäº†ä¿è¯å®‰å…¨ã€æˆ–è€…è¯´æå‡æ•ˆç‡ï¼Œæœ€å¥½æœ‰ä¸€ä¸ªç»Ÿä¸€çš„ç ”å‘è‡ªåŠ©é‡å¯é¡µé¢ã€‚

è¿™ä¸ªåŠŸèƒ½å¯åº”ç”¨çš„å‘å¸ƒæœ‰ä¸€äº›ç±»ä¼¼ä¹‹å¤„ã€‚é‚£ä¹ˆè¿™ä¸ªåŠŸèƒ½å…·ä½“åº”è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ

# chat

# æ˜¯å¦æœ‰å¼‚å¸¸ï¼Ÿ

Qï¼š

```
java çš„åº”ç”¨åœ¨å¯åŠ¨ä¹‹åï¼Œå¦‚æœå·²ç»å¯ç”¨æµé‡ã€‚

åˆåº”è¯¥å¦‚ä½•åˆ¤æ–­å¤„ç†æ˜¯å¦å­˜åœ¨å¼‚å¸¸ï¼Ÿ

æœ€å¥½å¯ä»¥è‡ªåŠ¨åŒ–çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡ api ä¹‹ç±»çš„ï¼Œæ–¹ä¾¿å’Œè‡ªåŠ©é‡å¯å·¥å…·é›†æˆ
```

è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„é—®é¢˜ï¼š

> âœ… **æœåŠ¡è™½ç„¶æ”¶åˆ°äº†æµé‡ï¼Œä½†æ˜¯å¦çœŸæ­£å¤„ç†æˆåŠŸï¼Ÿæœ‰æ²¡æœ‰é”™è¯¯ï¼Ÿæœ‰æ²¡æœ‰è¶…æ—¶ï¼Ÿæœ‰æ²¡æœ‰å¡æ­»ï¼Ÿ**

åœ¨é‡å¯ä¸Šçº¿æµç¨‹ä¸­ï¼Œä»…ä»…æœ‰è¯·æ±‚æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜è¦**ç¡®è®¤è¯·æ±‚å¤„ç†æ˜¯å¥åº·çš„**ï¼Œå¦åˆ™å°±æ˜¯ã€Œå‡ä¸Šçº¿ã€ã€‚

---

## âœ… ç›®æ ‡ï¼šåˆ¤æ–­æœåŠ¡ä¸Šçº¿åæ˜¯å¦ã€Œè¯·æ±‚å¤„ç†æ­£å¸¸ã€

### å¸¸è§å¼‚å¸¸ä¿¡å·ï¼š

* è¯·æ±‚é‡ä¸Šæ¥äº†ï¼Œä½† 5xx å¼‚å¸¸ç‡é«˜
* RTï¼ˆå“åº”æ—¶é—´ï¼‰å¼‚å¸¸å‡é«˜
* åº”ç”¨çº¿ç¨‹å¡ä½ã€é˜»å¡ã€OOM
* ä¸‹æ¸¸ä¾èµ–è°ƒç”¨å¼‚å¸¸ï¼ˆæ•°æ®åº“/MQ/ç¼“å­˜ç­‰ï¼‰

---

## âœ… è‡ªåŠ¨åŒ–åˆ¤æ–­ç­–ç•¥ï¼ˆæ¨èç»„åˆä½¿ç”¨ï¼‰

| æ£€æµ‹ç»´åº¦           | å®ç°æ–¹å¼                          | è‡ªåŠ¨åŒ–å·¥å…·åŒ–å»ºè®®                      |
| -------------- | ----------------------------- | ----------------------------- |
| 1ï¸âƒ£ é”™è¯¯ç‡ï¼ˆå¦‚ 5xxï¼‰ | åº”ç”¨å±‚è®¡æ•° / Actuator / Prometheus | æä¾› `/internal/error-rate` API |
| 2ï¸âƒ£ RTï¼ˆå“åº”æ—¶é—´ï¼‰   | Micrometer / Prometheus       | æä¾›å¹³å‡/ç™¾åˆ†ä½æ¥å£                    |
| 3ï¸âƒ£ å¼‚å¸¸æ—¥å¿—ç›‘æ§     | ç›‘æ§æ—¥å¿—ä¸­æ˜¯å¦æœ‰å¼‚å¸¸æ ˆ                   | ç®€å•ç‰ˆæœ¬ï¼šç»Ÿè®¡æ—¥å¿—ä¸­`Exception`æ¬¡æ•°       |
| 4ï¸âƒ£ ä¸‹æ¸¸æœåŠ¡çŠ¶æ€     | è‡ªæ£€æ¢é’ˆï¼ˆDBã€MQ pingï¼‰              | é€šè¿‡ readinessProbe åé¦ˆ          |
| 5ï¸âƒ£ çº¿ç¨‹ & å†…å­˜å¥åº·  | JVM ç›‘æ§ï¼ˆçº¿ç¨‹æ•°ã€å †å†…å­˜ï¼‰               | å¯å®šåˆ¶ `/internal/jvm-status`    |
| 6ï¸âƒ£ æ¥å…¥å±‚åé¦ˆ      | Nginx / Gateway è¿”å›ç æ¯”ä¾‹         | å¯æ¥å…¥ç°æœ‰æ¥å…¥ç›‘æ§ä½“ç³»                   |

---

## âœ… æ¨èå®ç°ï¼šæä¾›ä¸€ä¸ªã€Œåº”ç”¨å¥åº·è´¨é‡ APIã€

### ğŸ§© 1. ç¤ºä¾‹ï¼šSpring Boot æä¾› `/internal/health-extended`

```java
@RestController
@RequestMapping("/internal")
public class AppHealthController {

    @Autowired
    MetricsEndpoint metrics;

    @GetMapping("/health-extended")
    public Map<String, Object> healthStatus() {
        long errorCount = getMetricValue("http.server.requests", "status", "5xx");
        double rtP95 = getMetricValue("http.server.requests", "uri", "/your/api", "quantile", "0.95");

        return Map.of(
            "errorCount", errorCount,
            "rtP95", rtP95,
            "status", (errorCount < 5 && rtP95 < 1000) ? "healthy" : "unhealthy"
        );
    }

    private long getMetricValue(String name, String... tags) {
        // ç®€åŒ–å¤„ç†ï¼Œå®é™…å¯ç”¨ micrometer / prometheus æŸ¥è¯¢
        return 0;
    }
}
```

> è‡ªåŠ©å¹³å°è°ƒç”¨ `/internal/health-extended`ï¼Œåˆ¤æ–­æ˜¯å¦å¥åº·ï¼š

```bash
# è‹¥è¿”å› status: healthyï¼Œè¡¨ç¤ºä¸Šçº¿æˆåŠŸ
# è‹¥ status: unhealthyï¼Œè‡ªåŠ¨å›æ»šæˆ–æ ‡çº¢å‘Šè­¦
```

---

## âœ… ç¤ºä¾‹æŒ‡æ ‡æ ‡å‡†ï¼ˆå¯é…ç½®ï¼‰

| æŒ‡æ ‡              | é˜ˆå€¼           | åˆ¤æ–­ä¾æ®   |
| --------------- | ------------ | ------ |
| errorCountï¼ˆ5xxï¼‰ | â‰¤ 5 æ¬¡ / 1åˆ†é’Ÿ  | æ­£å¸¸èŒƒå›´å†…  |
| RTï¼ˆP95ï¼‰         | â‰¤ 1s         | è¯·æ±‚ä¸æ…¢   |
| threadCount     | â‰¤ 1000       | é¿å…çº¿ç¨‹æ³„æ¼ |
| fullGC count    | â‰¤ 2 æ¬¡ / 1min | å†…å­˜å‹åŠ›ä¸å¤§ |

---

## âœ… è¿›é˜¶æ–¹æ¡ˆï¼šPrometheus + AlertManager

å¦‚æœä½ æœ‰ Prometheus ç›‘æ§ï¼Œå¯å®šä¹‰å¦‚ä¸‹è‡ªåŠ¨åŒ–å‘Šè­¦è§„åˆ™ï¼š

```yaml
- alert: HighErrorRate
  expr: rate(http_server_requests_seconds_count{status=~"5.."}[1m]) > 5
  for: 1m
  labels:
    severity: warning
  annotations:
    summary: "æœåŠ¡5xxé”™è¯¯ç‡å¼‚å¸¸"
```

---

## âœ… è¡¥å……å»ºè®®ï¼šæ¥å…¥å¹³å°è°ƒç”¨æµç¨‹å›¾

```text
æœåŠ¡å¯åŠ¨ â†’ readiness OK â†’ æ¥å…¥æµé‡ â†’
å»¶è¿Ÿ 10s â†’
1. è°ƒç”¨ /internal/request-statsï¼Œç¡®è®¤æœ‰æµé‡ âœ…
2. è°ƒç”¨ /internal/health-extendedï¼Œç¡®è®¤é”™è¯¯ç‡ & RT æ­£å¸¸ âœ…
â†’ åˆ¤å®šä¸ºæˆåŠŸä¸Šçº¿ âœ…
å¦åˆ™ â†’ å›æ»šã€é‡è¯•ã€æŠ¥è­¦ âŒ
```

---

## âœ… æ€»ç»“ Checklist

| æ£€æŸ¥é¡¹               | è¯´æ˜         | æ˜¯å¦å»ºè®®   |
| ----------------- | ---------- | ------ |
| æä¾›è¯·æ±‚æ•°ç»Ÿè®¡æ¥å£         | ç¡®è®¤æ˜¯å¦æœ‰æµé‡è¿›æ¥  | âœ… å¼ºçƒˆå»ºè®® |
| æä¾›é”™è¯¯ç‡/RTæŒ‡æ ‡æ¥å£      | åˆ¤æ–­æ˜¯å¦å¥åº·     | âœ… å¼ºçƒˆå»ºè®® |
| Prometheus/æ—¥å¿—ç›‘æ§æ¥å…¥ | è¡¥å……éªŒè¯ï¼Œç¨³å®šæ€§æ›´é«˜ | âœ… æ¨è   |
| å‘ç° unhealthy è‡ªåŠ¨å›æ»š | æé«˜å®¹ç¾èƒ½åŠ›     | âœ… æ¨è   |
| æ”¯æŒæŒ‡æ ‡é˜ˆå€¼é…ç½®          | æ¯ä¸ªæœåŠ¡å¯å®šåˆ¶    | âœ… æ¨è   |

---

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ Spring Boot å¥åº·æ¢æµ‹ API åŒ…ï¼ŒåŒ…æ‹¬ï¼š

* `/internal/request-stats`
* `/internal/health-extended`
* é›†æˆ Prometheus æŒ‡æ ‡
* è‡ªå®šä¹‰å¼‚å¸¸ç»Ÿè®¡

è¦æˆ‘æ¥å†™ä¸€ä¸ª ready-to-use çš„ç¤ºä¾‹é¡¹ç›®å—ï¼Ÿ






# å‚è€ƒèµ„æ–™

* any list
{:toc}  