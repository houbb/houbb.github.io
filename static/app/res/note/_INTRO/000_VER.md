# 整个流程


eif-verify-accounting文档

注意：
1. 文件编码
不同支付公司提供的对账文件编码不同，实际编码时需根据实际情况进行编码。
可修改此方法指定编码：

ClrFilePreHandleServiceImpl.getCharsetByChannelNo()


对账流程
1.0	 paycore拉我方对账流水
2.0	 OMC页面上传对账文件，会MQ通知eif-verify-accounting对账
3.0	 eif-verify-accounting 对账开始
3.1	 文件名校验
3.2	 文件内容预处理
3.3	 进行对账
3.4	 对账汇总
3.5	 更新自动状态
paycore拉流水
PayDataPreHandleRunner定时Job去paycore拉流水。


数据库：
【paycore】： eif_paycore.t_paycore_payment
【verify】：eif_verify.t_ver_accing

OMC页面上传对账文件

login页面URL：http://ip:8091/eif-omc-web/login.jsp

admin/123456

详见：http://oa.hengjs.com/w/eif/dev_team/operation/env_info/eif/dev_docker/

上传页面：
【对账管理】->【清算文件上传】-> 【上传】

上传的文件命名会在后面提到，不同的支付渠道，对账格式也各不相同。


//对账处理 
verifyAccingBiz.verHandle()
文件名校验
对账文件命名应符合：
清算类型 2位 + 渠道编号 4位 + 清算日期(yyyyMMDd) + 序列号(位) + 文件后缀(.xxx)

例如：
01_0004_20161024_004.txt

//校验对账参数
ParamCheckHandle. checkVerHandleParam()

-	清算类型
ClrFileHandleSignCode.java

-	渠道编号
PayChannelCode.java

- 文件后缀
	FileTypeCode.java

具体队长文档信息可见：
http://oa.hengjs.com/w/eif/dev_team/%E6%B8%85%E7%BB%93%E7%AE%97%E7%B3%BB%E7%BB%9F%E8%AE%A1%E5%88%92/verify%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A3/

【注意】
-	宝付渠道对账文件类型为EXCEL,会在OMC上传后转为CSV文件。研发须知道这点，以免疑惑。测试无需关心。

文件内容预处理

/**
     * 1.buildClrOrigInfoSerBean()创建清算文件信息TVerClrOrig,tVerFileIndex,tVerBatch
     * 2.addClrFileInfoTX()事务添加清算文件信息
     * 3.loadClrFile()下载清算文件(二进制数组)
     * 4.buildTempClrFile()创建临时文件
     * 5.tempclrFileHandle()根据清算文件处理标记处理临时文件
     * 6.batchAddClrFileDataTX()批量插入清算明细(成功+失败的)
     * 7.addVerClrOrignLoad()插入清算解析
     * 8.deleteTempFile()删除临时文件
     *
     * @throws ServiceException
     */
    public PreHandleReslutSerBean clrFilePreHandle(String batchNo, ClearFileTransferSerBean clearFileTransferSerBean)
            throws ServiceException;


不同渠道，对账文件各不相同。预处理，一般只关心以下字段：

-	订单号列(商户订单号)

用于唯一标识这笔交易对应的我方流水，从而找到对应的记录进行对账。

【注意】支付系统针对chinapay增加字段providerTransmitPaymentNo作为流水唯一标识
	
-	交易金额列(订单金额)

-	手续费(手续费)

金额需要关心是否有正负号。

-	交易状态(订单状态)

AccingStatusCode.java




【总结】
对账文件的出款和入款，有的是在同一个对账文件中，有的是分开的。需要确认出款和入款等的区分字段是什么。

渠道中需要特殊处理的地方，研发需要需对方沟通确认。

出款、入款等对应枚举：
FileClrTypeCode.java



对账
根据商户订单查询t_ver_accing中对应记录，与对账文件中记录进行比较。会根据以下规则，设置对账结果：

入款



paycore
支付公司
Verify
动作
S
S
Y

S
F
X
人工处理
S
NA
P

S
?
X
人工处理
F
S
X
人工处理
F
F
Y

F
NA
P

F
?
X
人工处理
P
S
C
审核
P
F
A-Y

P
NA
P

P
?
X
人工处理
NA
S
X
人工处理
NA
F
X
人工处理
?
S
X
人工处理
?
F
X
人工处理









出款



paycore
支付公司
Verify
动作
S
S
Y

S
F
X
人工处理
S
NA
P

S
?
X
人工处理
F
S
X
人工处理
F
F
Y

F
NA
P

F
?
X
人工处理
P
S
A-Y

P
F
C
审核
P
NA
P

P
?
X
人工处理
NA
S
X
人工处理
NA
F
X
人工处理
?
S
X
人工处理
?
F
X
人工处理






注释：
S  成功
F  失败
P  Padding
Y  对账成功
A-Y自动成功或者失败 
X  人工处理
C  审核    

对账结果枚举值

VerifyResultCode.java










汇总
根据VerifyResultCode.java进行分类汇总。

对应OMC页面【对账管理】->【汇总确认】


更新状态
对于自动置成功和失败的记录，会通知paycore修改数据库中记录状态，并更新eif_verify数据库状态。

























附录
[对账管理][对账文件预处理]
t_ver_clr_orign_load    //清算解析表

[对账管理][对账文件预处理][错误的清算明细查询(放大镜功能)]
t_ver_orig_error_detail     //清算源文件明细错误表

[对账管理][流水对账]
t_ver_batch     //对账批次表

[对账管理][汇总确认]
t_ver_result_sum        //对账结果汇总表

[对账管理][汇总确认][差异明细查询(放大镜功能)]
t_ver_diff_detail       //差异明细表

【对账管理】【汇总确认】【成功明细查询(放大镜功能)】
t_ver_accing    //账务明细表-成功交易状态

[对账管理][平台流水查询]
t_ver_accing        //账务明细表

[对账管理][渠道流水查询]
t_ver_clr_detail    //清算明细表

【对账管理】【差异流水查询】
t_ver_diff_detail   //差异明细表















数据库表简介
•	t_ver_accing 账务明细表
存放从paycore定时拉取的平台流水。
•	t_ver_accing_carried_detail 结转明细表
汇总确认后，结转明细入库。
•	t_ver_batch 对账批次表
[对账管理][流水对账]查询。 包含以下信息：
资金渠道 上传日期 对账批次号 总笔数 合计总金额 对账状态
•	t_ver_channel_info 渠道编号表
保存各种支付渠道信息。可参考PayChannelCode.java
•	t_ver_clr_detail 清算明细表
[对账管理][渠道流水查询]查询。
存放渠道流水的交易记录。
•	t_ver_clr_orig 清算源件表
存放对账文件原始的信息： 文件号 文件名称 清算类型 渠道编号 对账批次号 等信息
•	t_ver_clr_orign_load 清算解析表
[对账管理][对账文件预处理] 查询。 包含以下信息：
支付通道 文件名 总笔数 出错笔数 处理笔数 等信息
•	t_ver_clr_type_mapping 渠道交易类型映射表
用于保存部分渠道的交易类型。对账文件中的交易类型可能是汉字，或者是特定的编号，全部映射为对应的出款、入款等交易类型。
•	t_ver_config 配置表
配置了定时去paycore拉去流水的pageSize, 参见PayDataPreHandleServiceImpl.fetchPayData()
•	t_ver_diff_detail 差异明细表
用来保存对账时的差异明细
•	t_ver_fetch_status 平台流水拉取状态表
定时拉取流水时，标志状态。参见 VerifyAccingBizImpl.payDataPreHandle()
•	t_ver_file_index 对账文件索引表
用于保存对账文件在服务器上的地址。
•	t_ver_mapping 类型映射表
定时拉取paycore流水时，用于将paycore的表字段与eifverify.tver_accing表对应起来。
•	t_ver_orig_error_detail 清算源文件明细错误表
[对账管理][对账文件预处理][错误的清算明细查询(放大镜功能)]查询。
存放对账错误明细。
•	t_ver_result_sum 对账结果汇总表
[对账管理][汇总确认]查询。保存汇总信息。
•	t_ver_sum_dle_status 汇总处理状态表
暂时不用。已被SumDleStatusCode.java替代。
•	t_ver_tmp_file_index 对账临时文件地址表
eif_verify回去服务器上下载对账文件，将二进制清算文件转为临时清算文件并封装进ClrFileDataSerBean.java。此时，创建临时文件，表中保存了临时文件的存放路径。

